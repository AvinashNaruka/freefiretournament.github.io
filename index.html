<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Free Fire Tournament</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCAjiInmaJsHSqhlxZZ0heIdNEMu6m6Y6Y",
      authDomain: "freefire-tournament-2009.firebaseapp.com",
      projectId: "freefire-tournament-2009",
      storageBucket: "freefire-tournament-2009.appspot.com",
      messagingSenderId: "498357283098",
      appId: "1:498357283098:web:2f05123efe6c57e65524a3"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM Elements
    const signupForm = document.getElementById('signupForm');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const userStatus = document.getElementById('userStatus');
    const registerForm = document.getElementById('registerForm');
    const uploadInput = document.getElementById('uploadInput');
    const uploadMsg = document.getElementById('uploadMsg');

    // Auth state listener
    onAuthStateChanged(auth, user => {
      if(user){
        userStatus.textContent = `Logged in as ${user.email}`;
        loginForm.style.display = 'none';
        signupForm.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        registerForm.style.display = 'block';
      } else {
        userStatus.textContent = 'Not logged in';
        loginForm.style.display = 'block';
        signupForm.style.display = 'block';
        logoutBtn.style.display = 'none';
        registerForm.style.display = 'none';
      }
    });

    // Signup
    signupForm.addEventListener('submit', async e => {
      e.preventDefault();
      const email = signupForm.email.value;
      const pass = signupForm.password.value;
      try{
        await createUserWithEmailAndPassword(auth,email,pass);
        alert('Signup successful! Login now.');
        signupForm.reset();
      }catch(err){
        alert(err.message);
      }
    });

    // Login
    loginForm.addEventListener('submit', async e => {
      e.preventDefault();
      const email = loginForm.email.value;
      const pass = loginForm.password.value;
      try{
        await signInWithEmailAndPassword(auth,email,pass);
        loginForm.reset();
      }catch(err){
        alert(err.message);
      }
    });

    // Logout
    logoutBtn.addEventListener('click', ()=>signOut(auth));

    // Register for tournament
    registerForm.addEventListener('submit', async e => {
      e.preventDefault();
      const user = auth.currentUser;
      if(!user){
        alert('Please login first');
        return;
      }
      const tName = registerForm.tournamentName.value;
      const ffId = registerForm.ffId.value;
      const phone = registerForm.phone.value;
      if(!tName || !ffId){
        alert('Fill tournament name and FF ID');
        return;
      }
      if(uploadInput.files.length === 0){
        alert('Upload payment screenshot');
        return;
      }

      // Upload screenshot
      const file = uploadInput.files[0];
      const storageRef = ref(storage, `payments/${user.uid}/${Date.now()}_${file.name}`);
      try{
        const snapshot = await uploadBytes(storageRef, file);
        const url = await getDownloadURL(snapshot.ref);

        // Save registration
        await addDoc(collection(db,'registrations'),{
          userId: user.uid,
          tournamentName: tName,
          ffId,
          phone,
          paymentProof: url,
          paid: true,
          createdAt: new Date()
        });

        alert('Registered successfully!');
        registerForm.reset();
        uploadMsg.textContent = '';
      }catch(err){
        alert('Error: '+err.message);
      }
    });

    // Show file size limit message on file select
    uploadInput.addEventListener('change', e=>{
      const file = e.target.files[0];
      if(file && file.size > 500*1024){
        alert('File size exceeds 500KB limit!');
        uploadInput.value = '';
        uploadMsg.textContent = '';
      } else {
        uploadMsg.textContent = file ? `Selected file: ${file.name}` : '';
      }
    });
  </script>
</head>
<body>
  <h2>Free Fire Tournament</h2>
  <div id="userStatus">Not logged in</div>

  <form id="signupForm">
    <h3>Sign Up</h3>
    <input type="email" name="email" placeholder="Email" required/><br/>
    <input type="password" name="password" placeholder="Password" required/><br/>
    <button type="submit">Sign Up</button>
  </form>

  <form id="loginForm">
    <h3>Login</h3>
    <input type="email" name="email" placeholder="Email" required/><br/>
    <input type="password" name="password" placeholder="Password" required/><br/>
    <button type="submit">Login</button>
  </form>

  <button id="logoutBtn" style="display:none;">Logout</button>

  <form id="registerForm" style="display:none;">
    <h3>Register Tournament</h3>
    <input type="text" name="tournamentName" placeholder="Tournament Name" required/><br/>
    <input type="text" name="ffId" placeholder="Free Fire ID" required/><br/>
    <input type="text" name="phone" placeholder="Phone (optional)"/><br/>
    <label>Upload Payment Screenshot (max 500KB):</label><br/>
    <input type="file" id="uploadInput" accept="image/*" required/><br/>
    <div id="uploadMsg" style="color:green;margin:4px 0;"></div>
    <button type="submit">Register</button>
  </form>
</body>
</html>

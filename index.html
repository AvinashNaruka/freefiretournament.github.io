<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Free Fire Tournament Manager</title>
<style>
  body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #1b2631, #0a1f2e);
    color: #eee;
    margin: 0;
    padding: 0 15px;
  }
  .container {
    max-width: 960px;
    margin: 20px auto;
    background: #1b2631;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 20px #0a1f2e;
  }
  h1,h2,h3 {
    margin-top: 0;
    font-weight: 700;
    color: #f39c12;
  }
  label {
    display: block;
    margin-top: 12px;
    font-size: 0.9rem;
    color: #f5c26b;
  }
  input, select, button, textarea {
    width: 100%;
    margin-top: 6px;
    padding: 8px 10px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    font-family: 'Inter', sans-serif;
  }
  input, select, textarea {
    background: #162029;
    color: #ddd;
  }
  button {
    background: #f39c12;
    color: #1b2631;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #d88e1a;
  }
  .flex {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
  }
  .flex > * {
    flex: 1;
    min-width: 180px;
  }
  .hidden {
    display: none;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    border: 1px solid #333;
    padding: 8px;
    text-align: left;
  }
  th {
    background: #34495e;
    color: #f5c26b;
  }
  tr:nth-child(even) {
    background: #22313f;
  }
  .message {
    margin-top: 10px;
    padding: 10px;
    border-radius: 8px;
  }
  .success {
    background: #27ae60;
    color: white;
  }
  .error {
    background: #c0392b;
    color: white;
  }
  nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    color: #f39c12;
  }
  nav button {
    width: auto;
    padding: 8px 15px;
  }
  .gradient-btn {
    background: linear-gradient(45deg, #f39c12, #f1c40f);
    border: none;
    color: #1b2631;
    font-weight: 700;
  }
  .admin-badge {
    background: #e67e22;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 700;
  }
  a {
    color: #f39c12;
    text-decoration: underline;
    cursor: pointer;
  }
  .screenshot-preview {
    max-width: 120px;
    max-height: 90px;
    border-radius: 8px;
    margin-top: 6px;
    border: 1px solid #f39c12;
  }
  .utrsmall {
    font-size: 0.85rem;
    margin-top: 3px;
    color: #f5c26b;
  }
  #totalAmount {
    margin-top: 10px;
    font-size: 1.1rem;
    font-weight: 700;
    color: #f39c12;
    text-align: right;
  }
  #qrContainer {
    margin-top: 15px;
    text-align: center;
  }
  .contact-buttons {
    margin-top: 20px;
    display: flex;
    gap: 10px;
  }
  .contact-buttons button {
    flex: 1;
  }
  .disabled-btn {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>
</head>
<body>

<div class="container">

  <nav>
    <div><h1>Free Fire Tournament Manager</h1></div>
    <div>
      <span id="userEmail" style="margin-right: 15px;"></span>
      <button id="logoutBtn" class="hidden">Logout</button>
    </div>
  </nav>

  <!-- Authentication -->
  <div id="authSection">
    <h2>Login / Signup</h2>
    <label for="emailInput">Email:</label>
    <input type="email" id="emailInput" placeholder="Enter your email" autocomplete="username"/>
    <label for="passwordInput">Password:</label>
    <input type="password" id="passwordInput" placeholder="Enter password" autocomplete="current-password"/>
    <button id="loginBtn">Login</button>
    <button id="signupBtn">Sign Up</button>
    <div id="authMessage"></div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hidden">
    <div class="flex" style="justify-content: space-between; align-items: center;">
      <h2>Tournaments</h2>
      <span id="adminBadge" class="admin-badge hidden">Admin</span>
    </div>

    <!-- Admin Panel -->
    <div id="adminSection" class="hidden">

      <h3>Create / Edit Tournament</h3>
      <label for="tName">Name:</label>
      <input type="text" id="tName" />
      <label for="tDate">Date & Time:</label>
      <input type="datetime-local" id="tDate" />
      <label for="tMode">Mode:</label>
      <select id="tMode">
        <option value="solo">Solo</option>
        <option value="duo">Duo</option>
        <option value="squad">Squad</option>
      </select>
      <label for="tSlots">Slots (number of squads/duos/solos):</label>
      <input type="number" id="tSlots" min="1" value="12" />
      <label for="tFee">Entry Fee (â‚¹):</label>
      <input type="number" id="tFee" min="0" value="20" />
      <button id="createTBtn" class="gradient-btn">Create / Update Tournament</button>
      <button id="cancelEditTBtn" style="display:none; margin-left:10px;">Cancel Edit</button>

      <label for="adminTSelect" style="margin-top:20px;">Select Tournament:</label>
      <select id="adminTSelect"></select>

      <button id="editTournamentBtn" class="gradient-btn" style="margin-top:10px;">Edit Selected Tournament</button>
      <button id="deleteTournamentBtn" class="gradient-btn" style="background:#c0392b; margin-left:10px;">Delete Selected Tournament</button>

      <h3 style="margin-top:30px;">Registrations for Selected Tournament</h3>
      <table>
        <thead>
          <tr>
            <th>Player Name</th>
            <th>Free Fire IDs</th>
            <th>Phone</th>
            <th>Amount Paid</th>
            <th>UTR</th>
            <th>Payment Proof</th>
            <th>WhatsApp</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="adminRegsTableBody"></tbody>
      </table>

      <div class="contact-buttons">
        <button onclick="window.location.href='tel:7976726014'">Call Admin</button>
        <button onclick="window.open('https://wa.me/7976726014','_blank')">WhatsApp Admin</button>
      </div>

    </div>

    <!-- User Panel -->
    <div id="userSection" class="hidden">

      <label for="tSelect">Select Tournament to Register:</label>
      <select id="tSelect"></select>

      <div id="registrationSection" class="hidden" style="margin-top:20px;">
        <h3>Register for Tournament</h3>
        <form id="registerForm">
          <label for="playerNameInput">Your Name:</label>
          <input type="text" id="playerNameInput" required />

          <label for="phoneNumberInput">Phone Number:</label>
          <input type="text" id="phoneNumberInput" required />

          <div id="playerModeIdsDiv"></div>

          <div id="paymentSection" style="margin-top:15px;">
            <button type="button" id="payBtn" class="gradient-btn">Pay & Register</button>
          </div>

          <div id="paymentUploadSection" class="hidden" style="margin-top:15px;">
            <label for="paymentProofInput">Upload Payment Screenshot (1 only):</label>
            <input type="file" id="paymentProofInput" accept="image/*" required />
            <img id="paymentProofPreview" class="screenshot-preview hidden" alt="Payment Proof Preview" />
            <label for="utrInput">Enter UTR / Transaction ID:</label>
            <input type="text" id="utrInput" required />
            <button type="submit" class="gradient-btn" style="margin-top:10px;">Submit Registration</button>
          </div>
        </form>

        <div id="totalAmount"></div>

        <div id="qrContainer" class="hidden">
          <canvas id="qrCanvas"></canvas>
          <br />
          <a id="upiLink" href="#" target="_blank" style="color:#f39c12; text-decoration:none; font-weight:bold; margin-top:10px; display:inline-block;">Pay via UPI Link</a>
        </div>
      </div>

      <h3 style="margin-top:30px;">Your Registrations</h3>
      <table>
        <thead>
          <tr>
            <th>Tournament</th>
            <th>Date</th>
            <th>Mode</th>
            <th>Fee</th>
            <th>Payment Status</th>
            <th>UTR</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="userRegsTableBody"></tbody>
      </table>

      <div class="contact-buttons" style="margin-top:20px;">
        <button onclick="window.location.href='tel:7976726014'">Call Admin</button>
        <button onclick="window.open('https://wa.me/7976726014','_blank')">WhatsApp Admin</button>
      </div>

    </div>
  </div>

</div>

<!-- Firebase & QR Code libs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCAjiInmaJsHSqhlxZZ0heIdNEMu6m6Y6Y",
    authDomain: "freefire-tournament-2009.firebaseapp.com",
    projectId: "freefire-tournament-2009",
    storageBucket: "freefire-tournament-2009.appspot.com",
    messagingSenderId: "498357283098",
    appId: "1:498357283098:web:2f05123efe6c57e65524a3"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // Elements
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authMessage = document.getElementById('authMessage');
  const userEmailDisplay = document.getElementById('userEmail');

  const mainApp = document.getElementById('mainApp');
  const authSection = document.getElementById('authSection');

  const adminBadge = document.getElementById('adminBadge');
  const adminSection = document.getElementById('adminSection');
  const userSection = document.getElementById('userSection');

  // Admin controls
  const tName = document.getElementById('tName');
  const tDate = document.getElementById('tDate');
  const tMode = document.getElementById('tMode');
  const tSlots = document.getElementById('tSlots');
  const tFee = document.getElementById('tFee');
  const createTBtn = document.getElementById('createTBtn');
  const cancelEditTBtn = document.getElementById('cancelEditTBtn');
  const editTournamentBtn = document.getElementById('editTournamentBtn');
  const deleteTournamentBtn = document.getElementById('deleteTournamentBtn');
  const adminTSelect = document.getElementById('adminTSelect');
  const adminRegsTableBody = document.getElementById('adminRegsTableBody');

  // User controls
  const tSelect = document.getElementById('tSelect');
  const registrationSection = document.getElementById('registrationSection');
  const playerNameInput = document.getElementById('playerNameInput');
  const phoneNumberInput = document.getElementById('phoneNumberInput');
  const playerModeIdsDiv = document.getElementById('playerModeIdsDiv');
  const paymentSection = document.getElementById('paymentSection');
  const payBtn = document.getElementById('payBtn');
  const paymentUploadSection = document.getElementById('paymentUploadSection');
  const paymentProofInput = document.getElementById('paymentProofInput');
  const paymentProofPreview = document.getElementById('paymentProofPreview');
  const utrInput = document.getElementById('utrInput');
  const registerForm = document.getElementById('registerForm');
  const userRegsTableBody = document.getElementById('userRegsTableBody');
  const totalAmountDiv = document.getElementById('totalAmount');
  const qrContainer = document.getElementById('qrContainer');
  const qrCanvas = document.getElementById('qrCanvas');
  const upiLink = document.getElementById('upiLink');

  // Admin & user info
  const adminEmail = 'avinashnaruka89@gmail.com';
  const adminPhone = '7976726014';
  const upiIDs = {
    phonepe: '7976726014@axl',
    gpay: 'avinashnaruka89@okicici'
  };

  let currentUser = null;
  let isAdmin = false;
  let tournaments = [];
  let selectedTournamentId = null;
  let editingTournamentId = null;

  // Utility functions
  function show(el) { el.classList.remove('hidden'); }
  function hide(el) { el.classList.add('hidden'); }
  function clearAuthMessage() { authMessage.textContent = ""; authMessage.className = ""; }
  function setAuthMessage(msg, success = true) {
    authMessage.textContent = msg;
    authMessage.className = success ? "message success" : "message error";
  }
  function formatDateTime(ms) {
    return new Date(ms).toLocaleString();
  }

  // Login/signup handlers
  signupBtn.addEventListener('click', async () => {
    clearAuthMessage();
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if (!email || !pass) {
      setAuthMessage("Email and password required", false);
      return;
    }
    try {
      await auth.createUserWithEmailAndPassword(email, pass);
      setAuthMessage("Signup successful! Logging in...");
    } catch (e) {
      setAuthMessage("Signup error: " + e.message, false);
    }
  });

  loginBtn.addEventListener('click', async () => {
    clearAuthMessage();
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if (!email || !pass) {
      setAuthMessage("Email and password required", false);
      return;
    }
    try {
      await auth.signInWithEmailAndPassword(email, pass);
      setAuthMessage("Login successful!");
    } catch (e) {
      setAuthMessage("Login error: " + e.message, false);
    }
  });

  logoutBtn.addEventListener('click', async () => {
    await auth.signOut();
  });

  // Auth state change
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      userEmailDisplay.textContent = user.email;
      show(logoutBtn);
      hide(authSection);
      show(mainApp);

      isAdmin = (user.email.toLowerCase() === adminEmail.toLowerCase());
      if (isAdmin) {
        show(adminBadge);
        show(adminSection);
        hide(userSection);
      } else {
        hide(adminBadge);
        hide(adminSection);
        show(userSection);
      }

      loadTournaments();
      clearAuthMessage();

    } else {
      userEmailDisplay.textContent = '';
      hide(logoutBtn);
      show(authSection);
      hide(mainApp);
      clearAuthMessage();
      resetAdminForm();
      clearUserForm();
    }
  });

  // Load tournaments from Firestore
  async function loadTournaments() {
    tournaments = [];
    tSelect.innerHTML = '';
    adminTSelect.innerHTML = '';
    try {
      const q = db.collection("tournaments").orderBy("date", "asc");
      const querySnap = await q.get();
      querySnap.forEach(docSnap => {
        const data = docSnap.data();
        data.id = docSnap.id;
        tournaments.push(data);
      });
    } catch (e) {
      alert("Failed to load tournaments: " + e.message);
      return;
    }

    if (tournaments.length === 0) {
      tSelect.innerHTML = '<option disabled>No tournaments available</option>';
      adminTSelect.innerHTML = '<option disabled>No tournaments available</option>';
      hide(registrationSection);
      clearUserRegistrationsTable();
      clearAdminRegistrationsTable();
      return;
    }

    tournaments.forEach(t => {
      let opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = `${t.name} - ${new Date(t.date).toLocaleString()} (${t.mode.toUpperCase()})`;
      tSelect.appendChild(opt);
    });
    tournaments.forEach(t => {
      let opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = `${t.name} - ${new Date(t.date).toLocaleString()} (${t.mode.toUpperCase()})`;
      adminTSelect.appendChild(opt);
    });

    selectedTournamentId = tournaments[0].id;
    tSelect.value = selectedTournamentId;
    adminTSelect.value = selectedTournamentId;

    if (isAdmin) {
      loadAdminRegistrations(selectedTournamentId);
    } else {
      setupRegistrationForm(selectedTournamentId);
      loadUserRegistrations();
    }
  }

  // Admin create/update tournament
  createTBtn.addEventListener('click', async () => {
    const name = tName.value.trim();
    const dateStr = tDate.value;
    const mode = tMode.value;
    const slots = parseInt(tSlots.value);
    const fee = parseInt(tFee.value);

    if (!name || !dateStr || !mode || !slots || isNaN(slots) || isNaN(fee)) {
      alert("Please fill all tournament details correctly.");
      return;
    }

    const dateMs = new Date(dateStr).getTime();
    if (isNaN(dateMs)) {
      alert("Invalid date/time");
      return;
    }

    try {
      if (editingTournamentId) {
        await db.collection("tournaments").doc(editingTournamentId).update({
          name, date: dateMs, mode, slots, fee
        });
        alert("Tournament updated successfully");
      } else {
        await db.collection("tournaments").add({
          name, date: dateMs, mode, slots, fee
        });
        alert("Tournament created successfully");
      }
      resetAdminForm();
      loadTournaments();
    } catch (e) {
      alert("Error saving tournament: " + e.message);
    }
  });

  cancelEditTBtn.addEventListener('click', () => {
    resetAdminForm();
  });

  // Reset admin form
  function resetAdminForm() {
    editingTournamentId = null;
    tName.value = '';
    tDate.value = '';
    tMode.value = 'solo';
    tSlots.value = 12;
    tFee.value = 20;
    createTBtn.textContent = 'Create / Update Tournament';
    cancelEditTBtn.style.display = 'none';
  }

  // Edit tournament button
  editTournamentBtn.addEventListener('click', () => {
    const tid = adminTSelect.value;
    if (!tid) return alert("Select a tournament first.");
    const t = tournaments.find(t => t.id === tid);
    if (!t) return alert("Tournament not found.");

    editingTournamentId = tid;
    tName.value = t.name;
    tDate.value = new Date(t.date).toISOString().slice(0,16);
    tMode.value = t.mode;
    tSlots.value = t.slots;
    tFee.value = t.fee;
    createTBtn.textContent = 'Update Tournament';
    cancelEditTBtn.style.display = 'inline-block';
  });

  // Delete tournament button
  deleteTournamentBtn.addEventListener('click', async () => {
    const tid = adminTSelect.value;
    if (!tid) return alert("Select a tournament first.");
    if (!confirm("Are you sure you want to delete this tournament? All registrations will also be deleted.")) return;

    try {
      // Delete registrations subcollection
      const regsSnap = await db.collection("tournaments").doc(tid).collection("registrations").get();
      const batch = db.batch();
      regsSnap.forEach(doc => batch.delete(doc.ref));
      await batch.commit();

      // Delete tournament doc
      await db.collection("tournaments").doc(tid).delete();

      alert("Tournament deleted.");
      resetAdminForm();
      loadTournaments();
    } catch(e) {
      alert("Error deleting tournament: " + e.message);
    }
  });

  // When admin changes tournament select
  adminTSelect.addEventListener('change', () => {
    const tid = adminTSelect.value;
    if (!tid) return;
    loadAdminRegistrations(tid);
  });

  // Load admin registrations
  async function loadAdminRegistrations(tournamentId) {
    adminRegsTableBody.innerHTML = '<tr><td colspan="8">Loading...</td></tr>';
    try {
      const regsSnap = await db.collection("tournaments").doc(tournamentId).collection("registrations").orderBy("createdAt","desc").get();
      if (regsSnap.empty) {
        adminRegsTableBody.innerHTML = '<tr><td colspan="8">No registrations found.</td></tr>';
        return;
      }
      let html = '';
      regsSnap.forEach(doc => {
        const r = doc.data();
        const freeFireIDs = Array.isArray(r.freefireIDs) ? r.freefireIDs.join(', ') : '';
        const phone = r.phone || '';
        const name = r.playerName || '';
        const amount = r.amountPaid || 0;
        const utr = r.utr || '';
        const paymentURL = r.paymentProofURL || '';
        const whatsappLink = phone ? `https://wa.me/${phone.replace(/\D/g,'')}` : '';
        const docId = doc.id;

        html += `<tr>
          <td>${name}</td>
          <td>${freeFireIDs}</td>
          <td>${phone}</td>
          <td>â‚¹${amount}</td>
          <td>${utr}</td>
          <td>${paymentURL ? `<a href="${paymentURL}" target="_blank">View</a>` : 'No'}</td>
          <td>${phone ? `<a href="${whatsappLink}" target="_blank">WhatsApp</a>` : 'No'}</td>
          <td><button data-id="${docId}" class="adminDeleteRegBtn" style="background:#c0392b;">Delete</button></td>
        </tr>`;
      });
      adminRegsTableBody.innerHTML = html;

      // Attach delete handlers to registration delete buttons
      document.querySelectorAll('.adminDeleteRegBtn').forEach(btn => {
        btn.onclick = async e => {
          const regId = e.target.dataset.id;
          if (!confirm("Delete this registration?")) return;
          try {
            await db.collection("tournaments").doc(tournamentId).collection("registrations").doc(regId).delete();
            loadAdminRegistrations(tournamentId);
          } catch (e) {
            alert("Error deleting registration: "+ e.message);
          }
        };
      });

    } catch(e) {
      adminRegsTableBody.innerHTML = `<tr><td colspan="8">Error loading registrations.</td></tr>`;
    }
  }

  // User tournament select change
  tSelect.addEventListener('change', () => {
    const tid = tSelect.value;
    if (!tid) {
      hide(registrationSection);
      return;
    }
    setupRegistrationForm(tid);
  });

  // Setup registration form for selected tournament
  function setupRegistrationForm(tournamentId) {
    const t = tournaments.find(t => t.id === tournamentId);
    if (!t) {
      hide(registrationSection);
      return;
    }
    selectedTournamentId = tournamentId;
    registrationSection.style.display = 'block';

    // Show correct Free Fire ID inputs based on mode
    playerModeIdsDiv.innerHTML = '';
    let count = 1;
    if (t.mode === 'solo') count = 1;
    else if (t.mode === 'duo') count = 2;
    else if (t.mode === 'squad') count = 4;

    for (let i=1; i<=count; i++) {
      const label = document.createElement('label');
      label.textContent = `Free Fire ID ${i}:`;
      label.setAttribute('for', `ffid${i}`);
      const input = document.createElement('input');
      input.type = 'text';
      input.id = `ffid${i}`;
      input.required = true;
      playerModeIdsDiv.appendChild(label);
      playerModeIdsDiv.appendChild(input);
    }

    // Show fee info and total amount
    totalAmountDiv.textContent = `Total Entry Fee: â‚¹${t.fee}`;

    // Reset payment & form sections
    paymentUploadSection.style.display = 'none';
    paymentProofInput.value = '';
    paymentProofPreview.src = '';
    paymentProofPreview.classList.add('hidden');
    utrInput.value = '';
    show(paymentSection);
    hide(qrContainer);
  }

  // Clear user registrations table
  function clearUserRegistrationsTable() {
    userRegsTableBody.innerHTML = '';
  }

  // Load user registrations
  async function loadUserRegistrations() {
    if (!currentUser) return;
    userRegsTableBody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
    try {
      let allRegs = [];
      // Get all tournaments and registrations for this user email
      for (const t of tournaments) {
        const regsSnap = await db.collection("tournaments").doc(t.id).collection("registrations").where('userId','==', currentUser.uid).get();
        regsSnap.forEach(doc => {
          const reg = doc.data();
          reg.id = doc.id;
          reg.tournament = t;
          allRegs.push(reg);
        });
      }

      if (allRegs.length === 0) {
        userRegsTableBody.innerHTML = '<tr><td colspan="7">No registrations found.</td></tr>';
        return;
      }

      let html = '';
      allRegs.forEach(r => {
        html += `<tr>
          <td>${r.tournament.name}</td>
          <td>${new Date(r.tournament.date).toLocaleString()}</td>
          <td>${r.tournament.mode.toUpperCase()}</td>
          <td>â‚¹${r.amountPaid || 0}</td>
          <td>${r.paymentDone ? 'Paid' : 'Pending'}</td>
          <td>${r.utr || ''}</td>
          <td><button data-tid="${r.tournament.id}" data-rid="${r.id}" class="userDeleteRegBtn" style="background:#c0392b;">Delete</button></td>
        </tr>`;
      });
      userRegsTableBody.innerHTML = html;

      // Attach delete handlers
      document.querySelectorAll('.userDeleteRegBtn').forEach(btn => {
        btn.onclick = async e => {
          const tid = e.target.dataset.tid;
          const rid = e.target.dataset.rid;
          if (!confirm("Delete this registration?")) return;
          try {
            await db.collection("tournaments").doc(tid).collection("registrations").doc(rid).delete();
            loadUserRegistrations();
          } catch (e) {
            alert("Error deleting registration: "+ e.message);
          }
        };
      });

    } catch(e) {
      userRegsTableBody.innerHTML = `<tr><td colspan="7">Error loading registrations.</td></tr>`;
    }
  }

  // Payment & registration flow

  // Check if device is mobile (simple)
  function isMobile() {
    return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  }

  // On Pay & Register click
  payBtn.addEventListener('click', async () => {
    // Validate form fields first
    if (!playerNameInput.value.trim()) return alert("Enter your name");
    if (!phoneNumberInput.value.trim()) return alert("Enter your phone number");

    // Validate Free Fire IDs
    const t = tournaments.find(t => t.id === selectedTournamentId);
    if (!t) return alert("Tournament not found");
    let count = 1;
    if (t.mode === 'solo') count = 1;
    else if (t.mode === 'duo') count = 2;
    else if (t.mode === 'squad') count = 4;
    const ffIDs = [];
    for(let i=1; i<=count; i++) {
      const val = document.getElementById(`ffid${i}`).value.trim();
      if (!val) return alert(`Enter Free Fire ID ${i}`);
      ffIDs.push(val);
    }

    // Check slots availability
    const regsSnap = await db.collection("tournaments").doc(selectedTournamentId).collection("registrations").get();
    if (regsSnap.size >= t.slots) {
      alert("Tournament registration full.");
      return;
    }

    // Show payment method: laptop = QR + link; mobile = redirect link
    totalAmountDiv.textContent = `Total Amount to Pay: â‚¹${t.fee}`;

    if (isMobile()) {
      // Mobile: redirect to UPI link with fixed amount
      const upiID = upiIDs.phonepe; // You can choose dynamically if you want
      const upiUrl = `upi://pay?pa=${upiID}&pn=Avinash+Naruka&am=${t.fee}&cu=INR&tn=FreeFireTournament`;
      // Show UPI link to click after confirm
      if (confirm(`You will be redirected to UPI payment app to pay â‚¹${t.fee}. Proceed?`)) {
        window.location.href = upiUrl;
        // After payment, user must upload screenshot & UTR
        paymentUploadSection.style.display = 'block';
        paymentProofInput.required = true;
        utrInput.required = true;
        hide(paymentSection);
        hide(qrContainer);
      }
    } else {
      // Laptop/Desktop: show QR and link
      const upiID = upiIDs.phonepe;
      const upiLinkUrl = `upi://pay?pa=${upiID}&pn=Avinash+Naruka&am=${t.fee}&cu=INR&tn=FreeFireTournament`;
      qrContainer.style.display = 'block';
      upiLink.href = upiLinkUrl;
      upiLink.textContent = `Pay â‚¹${t.fee} via UPI`;

      QRCode.toCanvas(qrCanvas, upiLinkUrl, { width: 200 }, function (error) {
        if (error) console.error(error);
      });

      paymentUploadSection.style.display = 'block';
      paymentProofInput.required = true;
      utrInput.required = true;
      hide(paymentSection);
    }
  });

  // Show screenshot preview
  paymentProofInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) {
      paymentProofPreview.src = '';
      paymentProofPreview.classList.add('hidden');
      return;
    }
    const reader = new FileReader();
    reader.onload = function(evt) {
      paymentProofPreview.src = evt.target.result;
      paymentProofPreview.classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  });

  // Register form submit (after payment proof & UTR)
  registerForm.addEventListener('submit', async e => {
    e.preventDefault();

    if (!paymentProofInput.files[0]) return alert("Upload payment screenshot");
    if (!utrInput.value.trim()) return alert("Enter UTR / Transaction ID");

    const t = tournaments.find(t => t.id === selectedTournamentId);
    if (!t) return alert("Tournament not found");

    const ffIDs = [];
    let count = 1;
    if (t.mode === 'solo') count = 1;
    else if (t.mode === 'duo') count = 2;
    else if (t.mode === 'squad') count = 4;
    for(let i=1; i<=count; i++) {
      const val = document.getElementById(`ffid${i}`).value.trim();
      ffIDs.push(val);
    }

    try {
      // Upload payment screenshot to Firebase Storage
      const file = paymentProofInput.files[0];
      const storageRef = storage.ref().child(`paymentProofs/${currentUser.uid}_${Date.now()}_${file.name}`);
      const snapshot = await storageRef.put(file);
      const paymentProofURL = await snapshot.ref.getDownloadURL();

      // Save registration data to Firestore
      const regData = {
        playerName: playerNameInput.value.trim(),
        phone: phoneNumberInput.value.trim(),
        freefireIDs: ffIDs,
        userId: currentUser.uid,
        email: currentUser.email,
        amountPaid: t.fee,
        paymentDone: true,
        paymentProofURL,
        utr: utrInput.value.trim(),
        createdAt: Date.now()
      };

      // Add registration document
      await db.collection("tournaments").doc(selectedTournamentId).collection("registrations").add(regData);

      alert("Registration successful!");
      clearUserForm();
      loadUserRegistrations();

      // Reset UI
      paymentUploadSection.style.display = 'none';
      paymentProofInput.value = '';
      paymentProofPreview.src = '';
      paymentProofPreview.classList.add('hidden');
      utrInput.value = '';
      show(paymentSection);
      hide(qrContainer);

    } catch(e) {
      alert("Error submitting registration: " + e.message);
    }
  });

  function clearUserForm() {
    playerNameInput.value = '';
    phoneNumberInput.value = '';
    playerModeIdsDiv.querySelectorAll('input').forEach(input => input.value = '');
    paymentProofInput.value = '';
    utrInput.value = '';
    paymentProofPreview.src = '';
    paymentProofPreview.classList.add('hidden');
    totalAmountDiv.textContent = '';
    hide(paymentUploadSection);
    show(paymentSection);
    hide(qrContainer);
  }

  // Initialize UI
  resetAdminForm();
  clearUserForm();

</script>

</body>
</html>

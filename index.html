<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Free Fire Tournament Manager</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  body {
    margin:0; font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #f39c12, #f1c40f);
    color:#eee;
  }
  .container {
    max-width: 960px; margin: 20px auto; background: #1b2631;
    padding: 20px; border-radius: 12px; box-shadow: 0 0 20px #0a1f2e;
  }
  h1,h2,h3 {
    margin-top: 0; font-weight: 700; color: #f39c12;
  }
  label {
    display: block; margin-top: 12px; font-size: 0.9rem; color: #f5c26b;
  }
  input, select, button, textarea {
    width: 100%; margin-top: 6px; padding: 8px 10px; border-radius: 8px;
    border: none; font-size: 1rem; font-family: 'Inter', sans-serif;
  }
  input, select, textarea {
    background: #162029; color: #ddd;
  }
  button {
    background: #f39c12; color: #1b2631; cursor: pointer;
    font-weight: 600; transition: background 0.3s ease;
  }
  button:hover {
    background: #d88e1a;
  }
  .flex {
    display: flex; gap: 15px; flex-wrap: wrap; align-items: center;
  }
  .flex > * {
    flex: 1;
    min-width: 180px;
  }
  .hidden {
    display: none;
  }
  table {
    width: 100%; border-collapse: collapse; margin-top: 20px;
  }
  th, td {
    border: 1px solid #333; padding: 8px; text-align: left;
  }
  th {
    background: #34495e; color: #f5c26b;
  }
  tr:nth-child(even) {
    background: #22313f;
  }
  .message {
    margin-top: 10px; padding: 10px; border-radius: 8px;
  }
  .success {
    background: #27ae60;
    color: white;
  }
  .error {
    background: #c0392b;
    color: white;
  }
  nav {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px; color: #f39c12;
  }
  nav button {
    width: auto; padding: 8px 15px;
  }
  .gradient-btn {
    background: linear-gradient(45deg, #f39c12, #f1c40f);
    border: none; color: #1b2631; font-weight: 700;
  }
  .admin-badge {
    background: #e67e22; padding: 4px 12px; border-radius: 20px;
    font-weight: 700;
  }
  a {
    color: #f39c12; text-decoration: underline;
    cursor: pointer;
  }
  .screenshot-preview {
    max-width: 120px; max-height: 90px; border-radius: 8px; margin-top: 6px;
    border: 1px solid #f39c12;
  }
  .utrsmall {
    font-size: 0.85rem; margin-top: 3px; color: #f5c26b;
  }
  .contact-buttons {
    margin-top: 15px;
  }
  .contact-buttons button {
    margin-right: 10px;
  }
</style>
</head>
<body>

<div class="container">

  <nav>
    <div><h1>Free Fire Tournament Manager</h1></div>
    <div>
      <span id="userEmail" style="margin-right: 15px;"></span>
      <button id="logoutBtn" class="hidden">Logout</button>
    </div>
  </nav>

  <div id="authSection">
    <h2>Login / Signup</h2>
    <label for="emailInput">Email:</label>
    <input type="email" id="emailInput" placeholder="Enter your email" autocomplete="username" />
    <label for="passwordInput">Password:</label>
    <input type="password" id="passwordInput" placeholder="Enter password" autocomplete="current-password" />
    <button id="loginBtn">Login</button>
    <button id="signupBtn">Sign Up</button>
    <div id="authMessage"></div>
  </div>

  <div id="mainApp" class="hidden">

    <div class="flex" style="justify-content: space-between; align-items: center;">
      <h2>Tournaments</h2>
      <span id="adminBadge" class="admin-badge hidden">Admin</span>
    </div>

    <!-- Admin Controls -->
    <div id="adminControls" class="hidden">

      <h3>Create / Edit Tournament</h3>
      <label for="tournNameInput">Tournament Name:</label>
      <input type="text" id="tournNameInput" placeholder="Enter tournament name" />
      <label for="tournDateInput">Date:</label>
      <input type="date" id="tournDateInput" />
      <label for="tournEntryFeeInput">Entry Fee (₹):</label>
      <input type="number" id="tournEntryFeeInput" min="0" step="1" />
      <label for="tournModeSelect">Mode:</label>
      <select id="tournModeSelect">
        <option value="solo">Solo</option>
        <option value="duo">Duo</option>
        <option value="squad">Squad</option>
      </select>
      <label for="tournSlotLimitInput">Slots Limit (number of squads/duos/solos allowed):</label>
      <input type="number" id="tournSlotLimitInput" min="1" step="1" />
      <button id="createTournBtn" class="gradient-btn">Create Tournament</button>
      <div id="createTournMsg"></div>

      <hr />

      <h3>Manage Tournaments</h3>
      <table id="adminTournamentsTable">
        <thead>
          <tr>
            <th>Name</th><th>Date</th><th>Entry Fee</th><th>Mode</th><th>Slots</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- dynamically filled -->
        </tbody>
      </table>

      <hr />

      <h3>View Registrations</h3>
      <label for="selectTournamentReg">Select Tournament:</label>
      <select id="selectTournamentReg"><option value="">--Select Tournament--</option></select>
      <table id="registrationsTable" class="hidden">
        <thead>
          <tr>
            <th>User Email</th>
            <th>Free Fire ID</th>
            <th>Mode</th>
            <th>Players</th>
            <th>Phone Number</th>
            <th>UTR</th>
            <th>Screenshot</th>
            <th>Payment Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

    </div>

    <!-- User Controls -->
    <div id="userControls" class="hidden">
      <h3>Register for Tournament</h3>
      <label for="selectTournamentUser">Select Tournament:</label>
      <select id="selectTournamentUser"><option value="">--Select Tournament--</option></select>

      <label for="freefireIdInput">Your Free Fire ID:</label>
      <input type="text" id="freefireIdInput" placeholder="Enter your Free Fire ID" />

      <label for="phoneInput">Phone Number (for WhatsApp):</label>
      <input type="tel" id="phoneInput" placeholder="Enter phone number" />

      <button id="registerTournBtn" class="gradient-btn">Register & Pay</button>
      <div id="registerMsg"></div>

      <hr />

      <h3>Your Registrations</h3>
      <table id="userRegistrationsTable">
        <thead>
          <tr>
            <th>Tournament</th><th>Free Fire ID</th><th>Mode</th><th>Players</th><th>Phone</th><th>UTR</th><th>Screenshot</th><th>Payment Status</th><th>Upload Payment</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filled dynamically -->
        </tbody>
      </table>
    </div>

    <div class="contact-buttons">
      <button onclick="window.location.href='tel:7976726014'">Call Admin</button>
      <button onclick="window.open('https://wa.me/7976726014','_blank')">WhatsApp Admin</button>
    </div>

  </div>
</div>

<script type="module">
// Firebase SDK imports from CDN
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

// Your Firebase config here (replace with your own!)
const firebaseConfig = {
  apiKey: "AIzaSyCAjiInmaJsHSqhlxZZ0heIdNEMu6m6Y6Y",
  authDomain: "freefire-tournament-2009.firebaseapp.com",
  projectId: "freefire-tournament-2009",
  storageBucket: "freefire-tournament-2009.appspot.com",
  messagingSenderId: "498357283098",
  appId: "1:498357283098:web:2f05123efe6c57e65524a3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const adminEmail = "avinashnaruka89@gmail.com";
const adminPhone = "7976726014";
const phonePeUPI = "7976726014@axl";
const gPayUPI = "avinashnaruka89@okicici";

// DOM Elements
const authSection = document.getElementById("authSection");
const emailInput = document.getElementById("emailInput");
const passwordInput = document.getElementById("passwordInput");
const loginBtn = document.getElementById("loginBtn");
const signupBtn = document.getElementById("signupBtn");
const authMessage = document.getElementById("authMessage");
const logoutBtn = document.getElementById("logoutBtn");
const userEmailSpan = document.getElementById("userEmail");

const mainApp = document.getElementById("mainApp");
const adminBadge = document.getElementById("adminBadge");
const adminControls = document.getElementById("adminControls");
const userControls = document.getElementById("userControls");

// Admin controls inputs
const tournNameInput = document.getElementById("tournNameInput");
const tournDateInput = document.getElementById("tournDateInput");
const tournEntryFeeInput = document.getElementById("tournEntryFeeInput");
const tournModeSelect = document.getElementById("tournModeSelect");
const tournSlotLimitInput = document.getElementById("tournSlotLimitInput");
const createTournBtn = document.getElementById("createTournBtn");
const createTournMsg = document.getElementById("createTournMsg");
const adminTournTableBody = document.querySelector("#adminTournamentsTable tbody");

const selectTournamentReg = document.getElementById("selectTournamentReg");
const registrationsTable = document.getElementById("registrationsTable");
const registrationsTbody = registrationsTable.querySelector("tbody");

const selectTournamentUser = document.getElementById("selectTournamentUser");
const freefireIdInput = document.getElementById("freefireIdInput");
const phoneInput = document.getElementById("phoneInput");
const registerTournBtn = document.getElementById("registerTournBtn");
const registerMsg = document.getElementById("registerMsg");
const userRegistrationsTableBody = document.querySelector("#userRegistrationsTable tbody");

let currentUser = null;
let isAdmin = false;

function clearCreateTournamentForm(){
  tournNameInput.value = "";
  tournDateInput.value = "";
  tournEntryFeeInput.value = "";
  tournSlotLimitInput.value = "";
  tournModeSelect.value = "solo";
  createTournBtn.textContent = "Create Tournament";
  delete createTournBtn.dataset.editingId;
  createTournMsg.textContent = "";
}

// Login handler
loginBtn.onclick = async () => {
  authMessage.textContent = "";
  try {
    await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
  } catch(e) {
    authMessage.textContent = "Login failed: "+e.message;
    authMessage.className = "message error";
  }
}

// Signup handler
signupBtn.onclick = async () => {
  authMessage.textContent = "";
  try {
    await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
  } catch(e) {
    authMessage.textContent = "Signup failed: "+e.message;
    authMessage.className = "message error";
  }
}

// Logout
logoutBtn.onclick = async () => {
  await signOut(auth);
}

// Load tournaments into dropdown for user and admin registration view
async function loadTournamentsForFilter(){
  selectTournamentUser.innerHTML = `<option value="">--Select Tournament--</option>`;
  selectTournamentReg.innerHTML = `<option value="">--Select Tournament--</option>`;

  const tournSnap = await getDocs(collection(db, "tournaments"));
  tournSnap.forEach(docSnap => {
    const t = docSnap.data();
    const option = document.createElement("option");
    option.value = docSnap.id;
    option.textContent = `${t.name} (${t.date}) - ₹${t.entryFee} - ${t.mode} - Slots:${t.slotLimit}`;
    selectTournamentUser.appendChild(option);
    selectTournamentReg.appendChild(option.cloneNode(true));
  });
}

// Load tournaments for admin manage table
async function loadAdminTournaments(){
  adminTournTableBody.innerHTML = "";
  const tournSnap = await getDocs(collection(db, "tournaments"));
  if (tournSnap.empty) {
    adminTournTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No tournaments created yet.</td></tr>`;
    return;
  }
  tournSnap.forEach(docSnap => {
    const t = docSnap.data();
    const id = docSnap.id;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${t.name}</td>
      <td>${t.date}</td>
      <td>₹${t.entryFee}</td>
      <td>${t.mode}</td>
      <td>${t.slotLimit}</td>
      <td>
        <button data-id="${id}" class="editTournBtn">Edit</button>
        <button data-id="${id}" class="deleteTournBtn">Delete</button>
      </td>
    `;
    adminTournTableBody.appendChild(tr);
  });

  document.querySelectorAll(".editTournBtn").forEach(btn => {
    btn.onclick = async () => {
      const tournId = btn.dataset.id;
      const tournDoc = await getDoc(doc(db, "tournaments", tournId));
      if (!tournDoc.exists()) {
        alert("Tournament not found");
        return;
      }
      const t = tournDoc.data();
      tournNameInput.value = t.name;
      tournDateInput.value = t.date;
      tournEntryFeeInput.value = t.entryFee;
      tournModeSelect.value = t.mode;
      tournSlotLimitInput.value = t.slotLimit;
      createTournBtn.textContent = "Update Tournament";
      createTournMsg.textContent = "";
      createTournBtn.dataset.editingId = tournId;
      window.scrollTo({ top: 0, behavior: "smooth" });
    };
  });

  document.querySelectorAll(".deleteTournBtn").forEach(btn => {
    btn.onclick = async () => {
      const tournId = btn.dataset.id;
      if (!confirm("Are you sure you want to DELETE this tournament? This will also delete all registrations for it.")) return;

      try {
        const regQuery = query(collection(db, "registrations"), where("tournamentId", "==", tournId));
        const regSnap = await getDocs(regQuery);
        for(const rDoc of regSnap.docs){
          await deleteDoc(rDoc.ref);
        }
        await deleteDoc(doc(db, "tournaments", tournId));
        alert("Tournament and related registrations deleted.");
        await loadTournamentsForFilter();
        await loadAdminTournaments();
        await loadUserRegistrations();
      } catch(e) {
        alert("Error deleting tournament: " + e.message);
      }
    };
  });
}

// Create or Update Tournament
createTournBtn.onclick = async () => {
  createTournMsg.textContent = "";
  const name = tournNameInput.value.trim();
  const date = tournDateInput.value;
  const entryFee = parseFloat(tournEntryFeeInput.value);
  const mode = tournModeSelect.value;
  let slotLimit = parseInt(tournSlotLimitInput.value);

  if (!name || !date || isNaN(entryFee) || !mode || isNaN(slotLimit) || slotLimit < 1) {
    createTournMsg.textContent = "Please fill all fields correctly.";
    createTournMsg.className = "message error";
    return;
  }

  try {
    if (createTournBtn.dataset.editingId) {
      const editingId = createTournBtn.dataset.editingId;
      await updateDoc(doc(db, "tournaments", editingId), {
        name, date, entryFee, mode, slotLimit
      });
      createTournMsg.textContent = "Tournament updated successfully!";
      createTournBtn.textContent = "Create Tournament";
      delete createTournBtn.dataset.editingId;
    } else {
      await addDoc(collection(db, "tournaments"), {
        name, date, entryFee, mode, slotLimit,
        createdAt: new Date().toISOString()
      });
      createTournMsg.textContent = "Tournament created successfully!";
    }
    createTournMsg.className = "message success";

    clearCreateTournamentForm();
    await loadTournamentsForFilter();
    await loadAdminTournaments();
  } catch (e) {
    createTournMsg.textContent = "Error saving tournament: " + e.message;
    createTournMsg.className = "message error";
  }
};

// Load registrations for selected tournament in admin view
selectTournamentReg.onchange = async () => {
  const tournId = selectTournamentReg.value;
  registrationsTbody.innerHTML = "";
  if (!tournId) {
    registrationsTable.classList.add("hidden");
    return;
  }
  registrationsTable.classList.remove("hidden");
  const q = query(collection(db, "registrations"), where("tournamentId", "==", tournId));
  const snap = await getDocs(q);
  if (snap.empty) {
    registrationsTbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No registrations found.</td></tr>`;
    return;
  }
  for (const docSnap of snap.docs) {
    const reg = docSnap.data();
    const tr = document.createElement("tr");

    // Players display for duo/squad
    let playersText = "";
    if(reg.mode === "solo"){
      playersText = reg.freefireId;
    } else if (reg.players && Array.isArray(reg.players)) {
      playersText = reg.players.join(", ");
    } else {
      playersText = reg.freefireId;
    }

    let imgTag = reg.screenshotUrl ? `<a href="${reg.screenshotUrl}" target="_blank"><img src="${reg.screenshotUrl}" alt="Screenshot" class="screenshot-preview"/></a>` : "No screenshot";

    tr.innerHTML = `
      <td>${reg.userEmail}</td>
      <td>${reg.freefireId}</td>
      <td>${reg.mode}</td>
      <td>${playersText}</td>
      <td>${reg.phone}</td>
      <td class="utrsmall">${reg.utr || "-"}</td>
      <td>${imgTag}</td>
      <td>${reg.paymentStatus || "Pending"}</td>
    `;
    registrationsTbody.appendChild(tr);
  }
};

// Load user's registrations and show in table
async function loadUserRegistrations(){
  userRegistrationsTableBody.innerHTML = "";
  if(!currentUser) return;

  const q = query(collection(db, "registrations"), where("userId", "==", currentUser.uid));
  const snap = await getDocs(q);
  if(snap.empty){
    userRegistrationsTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">No registrations found.</td></tr>`;
    return;
  }
  for(const docSnap of snap.docs){
    const reg = docSnap.data();
    const id = docSnap.id;

    let playersText = "";
    if(reg.mode === "solo"){
      playersText = reg.freefireId;
    } else if(reg.players && Array.isArray(reg.players)){
      playersText = reg.players.join(", ");
    } else {
      playersText = reg.freefireId;
    }

    let imgTag = reg.screenshotUrl ? `<a href="${reg.screenshotUrl}" target="_blank"><img src="${reg.screenshotUrl}" alt="Screenshot" class="screenshot-preview"/></a>` : "No screenshot";

    let paymentUploadHTML = reg.paymentStatus === "Approved" ? "Approved" : `
      <input type="file" data-id="${id}" accept="image/*" class="uploadScreenshotInput" />
      <input type="text" data-id="${id}" placeholder="Enter UTR ID" class="utrInput" style="margin-top:5px;" />
      <button data-id="${id}" class="uploadPaymentBtn gradient-btn" style="margin-top:5px;">Upload Payment</button>
    `;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${reg.tournamentName}</td>
      <td>${reg.freefireId}</td>
      <td>${reg.mode}</td>
      <td>${playersText}</td>
      <td>${reg.phone}</td>
      <td class="utrsmall">${reg.utr || "-"}</td>
      <td>${imgTag}</td>
      <td>${reg.paymentStatus || "Pending"}</td>
      <td>${paymentUploadHTML}</td>
    `;
    userRegistrationsTableBody.appendChild(tr);
  }

  // Add event listeners for upload payment buttons
  document.querySelectorAll(".uploadPaymentBtn").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;
      const tr = btn.closest("tr");
      const fileInput = tr.querySelector(".uploadScreenshotInput");
      const utrInput = tr.querySelector(".utrInput");

      if(!fileInput.files[0]){
        alert("Please select a screenshot image.");
        return;
      }
      if(!utrInput.value.trim()){
        alert("Please enter UTR ID.");
        return;
      }

      const file = fileInput.files[0];
      const utr = utrInput.value.trim();

      try {
        // Upload screenshot to Firebase Storage
        const storageRef = ref(storage, `payments/${id}/${file.name}`);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);

        // Update registration doc with payment info
        await updateDoc(doc(db, "registrations", id), {
          screenshotUrl: url,
          utr: utr,
          paymentStatus: "Pending"
        });

        alert("Payment info uploaded successfully. Admin will verify soon.");
        loadUserRegistrations();
      } catch(e) {
        alert("Error uploading payment info: "+e.message);
      }
    };
  });
}

// Register user for tournament
registerTournBtn.onclick = async () => {
  registerMsg.textContent = "";
  if(!currentUser){
    registerMsg.textContent = "Please login first.";
    registerMsg.className = "message error";
    return;
  }
  const tournId = selectTournamentUser.value;
  const freefireId = freefireIdInput.value.trim();
  const phone = phoneInput.value.trim();

  if(!tournId){
    registerMsg.textContent = "Please select a tournament.";
    registerMsg.className = "message error";
    return;
  }
  if(!freefireId){
    registerMsg.textContent = "Please enter your Free Fire ID.";
    registerMsg.className = "message error";
    return;
  }
  if(!phone || !/^\d{10}$/.test(phone)){
    registerMsg.textContent = "Please enter a valid 10-digit phone number.";
    registerMsg.className = "message error";
    return;
  }

  try {
    // Get tournament details
    const tournDoc = await getDoc(doc(db, "tournaments", tournId));
    if(!tournDoc.exists()){
      registerMsg.textContent = "Tournament not found.";
      registerMsg.className = "message error";
      return;
    }
    const tourn = tournDoc.data();

    // Check slots availability
    const regQuery = query(collection(db, "registrations"), where("tournamentId", "==", tournId));
    const regSnap = await getDocs(regQuery);

    if(regSnap.size >= tourn.slotLimit){
      registerMsg.textContent = "Sorry, tournament slots are full.";
      registerMsg.className = "message error";
      return;
    }

    // Check if user already registered for this tournament
    const userRegQuery = query(collection(db, "registrations"), where("tournamentId", "==", tournId), where("userId", "==", currentUser.uid));
    const userRegSnap = await getDocs(userRegQuery);
    if(!userRegSnap.empty){
      registerMsg.textContent = "You have already registered for this tournament.";
      registerMsg.className = "message error";
      return;
    }

    // Register
    await addDoc(collection(db, "registrations"), {
      tournamentId: tournId,
      tournamentName: tourn.name,
      userId: currentUser.uid,
      userEmail: currentUser.email,
      freefireId,
      phone,
      mode: tourn.mode,
      paymentStatus: "Not Paid",
      createdAt: new Date().toISOString()
    });

    registerMsg.textContent = `Registered successfully! Please pay ₹${tourn.entryFee} via UPI and upload your payment screenshot & UTR in 'Your Registrations'.`;
    registerMsg.className = "message success";

    freefireIdInput.value = "";
    phoneInput.value = "";
    await loadUserRegistrations();

  } catch(e){
    registerMsg.textContent = "Error during registration: " + e.message;
    registerMsg.className = "message error";
  }
};

function updateUI(user){
  if(user){
    currentUser = user;
    userEmailSpan.textContent = user.email;
    logoutBtn.classList.remove("hidden");
    authSection.classList.add("hidden");
    mainApp.classList.remove("hidden");

    isAdmin = (user.email === adminEmail);

    if(isAdmin){
      adminBadge.classList.remove("hidden");
      adminControls.classList.remove("hidden");
      userControls.classList.add("hidden");
      loadTournamentsForFilter();
      loadAdminTournaments();
    } else {
      adminBadge.classList.add("hidden");
      adminControls.classList.add("hidden");
      userControls.classList.remove("hidden");
      loadTournamentsForFilter();
      loadUserRegistrations();
    }

  } else {
    currentUser = null;
    userEmailSpan.textContent = "";
    logoutBtn.classList.add("hidden");
    authSection.classList.remove("hidden");
    mainApp.classList.add("hidden");
    adminBadge.classList.add("hidden");
    adminControls.classList.add("hidden");
    userControls.classList.add("hidden");
  }
}

// Auth state observer
onAuthStateChanged(auth, (user) => {
  updateUI(user);
});
</script>
</body>
</html>

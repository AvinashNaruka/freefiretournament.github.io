<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Free Fire Tournament Manager</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root{--accent:#f39c12;--bg:#071422;--card:#0b1a25;--muted:#9fb0bf}
    body{font-family:Inter,system-ui,Arial;margin:0;background:linear-gradient(135deg,#052837,#072b3a);color:#eef6f9;min-height:100vh;padding:18px}
    .wrap{max-width:1000px;margin:0 auto;background:var(--card);padding:18px;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
    h1,h2,h3{margin:0 0 10px;color:var(--accent)}
    label{display:block;margin-top:10px;color:var(--muted);font-size:14px}
    input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:0;background:transparent;color:inherit}
    .field{background:#071a24;padding:10px;border-radius:8px}
    button{background:var(--accent);color:#071422;border-radius:8px;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent)}
    .flex{display:flex;gap:12px;flex-wrap:wrap}
    .flex> *{flex:1;min-width:140px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .admin-badge{background:#0f172a;padding:6px 10px;border-radius:999px;color:var(--accent);font-weight:700}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:14px}
    th{background:rgba(255,255,255,0.02);color:var(--muted)}
    .muted{color:var(--muted);font-size:13px}
    .notice{background:rgba(243,156,18,0.07);border:1px solid rgba(243,156,18,0.08);padding:10px;border-radius:8px;margin-bottom:12px}
    .screenshot-preview{max-width:140px;max-height:100px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.06)}
    #qrCanvas{background:#fff;border-radius:8px;display:block;margin:12px auto}
    a.link{color:var(--accent);text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Free Fire Tournament Manager</h1>
        <div class="muted">Email login • UPI pay (PhonePe + GPay) • Admin verifies payments</div>
      </div>
      <div>
        <span id="userEmail" class="muted"></span>
        <button id="logoutBtn" class="hidden" style="margin-left:12px">Logout</button>
      </div>
    </div>

    <!-- AUTH -->
    <div id="authSection">
      <h2>Login / Signup</h2>
      <div class="field">
        <label>Email</label>
        <input id="emailInput" type="email" placeholder="you@example.com" />
        <label>Password</label>
        <input id="passwordInput" type="password" placeholder="password" />
        <div class="flex" style="margin-top:10px">
          <button id="loginBtn">Login</button>
          <button id="signupBtn" class="ghost">Sign up</button>
        </div>
        <div id="authMessage" class="muted" style="margin-top:8px"></div>
      </div>
      <div class="notice" style="margin-top:12px">
        Admin email: <strong>avinashnaruka89@gmail.com</strong> — ensure this user exists in Firebase Auth.
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">

      <div class="flex" style="justify-content:space-between;align-items:center">
        <h2>Tournaments</h2>
        <span id="adminBadge" class="admin-badge hidden">Admin</span>
      </div>

      <div class="notice">Payment steps: click <strong>Pay & Register</strong> → mobile: redirects to UPI app, desktop: shows QR + link. After paying, upload screenshot + UTR to complete registration.</div>

      <!-- Admin create/edit -->
      <div id="adminControls" class="hidden" style="margin-bottom:12px">
        <h3>Create / Edit Tournament</h3>
        <div class="field">
          <label>Tournament name</label>
          <input id="tName" placeholder="Sunday Clash">
          <label>Date & time</label>
          <input id="tDate" type="datetime-local">
          <label>Mode</label>
          <select id="tMode"><option value="solo">Solo (1)</option><option value="duo">Duo (2)</option><option value="squad">Squad (4)</option></select>
          <label>Slots (teams)</label>
          <input id="tSlots" type="number" value="12" min="1">
          <label>Entry fee (₹)</label>
          <input id="tFee" type="number" value="20" min="0">
          <div class="flex" style="margin-top:8px">
            <button id="saveTBtn">Save Tournament</button>
            <button id="cancelEditTBtn" class="ghost hidden">Cancel Edit</button>
          </div>
        </div>
      </div>

      <!-- tournament select -->
      <div style="margin-top:10px">
        <label>Select tournament</label>
        <select id="selectTournament"></select>
      </div>

      <!-- registration panel -->
      <div id="registrationPanel" class="hidden" style="margin-top:12px">
        <h3>Register</h3>
        <div class="field">
          <label>Full name</label>
          <input id="playerName" placeholder="Full name" />
          <label>Player nickname / in-game name</label>
          <input id="playerIGN" placeholder="In-game name (optional)" />
          <label>Phone (WhatsApp)</label>
          <input id="playerPhone" placeholder="10 digit number" />

          <div id="ffIdsContainer"></div>

          <div style="margin-top:8px" class="muted">Entry fee: ₹<span id="entryFee">0</span></div>
          <div id="totalAmount" class="muted" style="text-align:right;margin-top:6px"></div>

          <div class="flex" style="margin-top:10px">
            <button id="payAndRegisterBtn">Pay & Register</button>
            <button id="payPhonePeBtn" class="ghost">Pay (PhonePe)</button>
            <button id="payGPayBtn" class="ghost">Pay (GPay)</button>
          </div>

          <!-- QR + link -->
          <div id="qrSection" class="hidden" style="margin-top:12px">
            <div class="muted">Scan QR (desktop) or click link:</div>
            <canvas id="qrCanvas" width="200" height="200"></canvas>
            <div style="text-align:center;margin-top:8px"><a id="upiPaymentLink" class="link" href="#" target="_blank"></a></div>
          </div>

          <!-- upload area after payment -->
          <div id="uploadSection" class="hidden" style="margin-top:12px">
            <label>Upload payment screenshot (1)</label>
            <input id="paymentFile" type="file" accept="image/*">
            <img id="paymentPreview" class="screenshot-preview hidden" alt="preview">
            <label>UTR / Transaction ref</label>
            <input id="utrInput" placeholder="UTR or TXN ID">
            <div class="flex" style="margin-top:10px">
              <button id="submitRegBtn">Submit Registration</button>
              <button id="cancelUploadBtn" class="ghost">Cancel</button>
            </div>
            <div id="uploadMsg" class="muted" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <!-- user registrations -->
      <div id="userRegs" style="margin-top:18px">
        <h3>Your registrations</h3>
        <table id="userRegsTable"><thead><tr><th>Tournament</th><th>Date</th><th>Mode</th><th>Fee</th><th>Payment</th><th>UTR</th><th>Proof</th></tr></thead><tbody></tbody></table>
      </div>

      <!-- admin registrations -->
      <div id="adminRegs" class="hidden" style="margin-top:18px">
        <h3>Registrations (admin)</h3>
        <label>Choose tournament</label>
        <select id="adminSelectTournament"></select>
        <table id="adminRegsTable" style="margin-top:8px"><thead><tr><th>Name</th><th>FF IDs</th><th>Phone</th><th>Paid</th><th>UTR</th><th>Proof</th><th>WA</th><th>Actions</th></tr></thead><tbody></tbody></table>
      </div>

      <div style="margin-top:16px" class="flex">
        <button id="callAdminBtn" class="ghost">Call Admin</button>
        <button id="waAdminBtn" class="ghost">WhatsApp Admin</button>
      </div>

    </div>
  </div>

  <!-- firebase + qrcode -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <script>
  (function(){
    // ---------- CONFIG ----------
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyCAjiInmaJsHSqhlxZZ0heIdNEMu6m6Y6Y",
      authDomain: "freefire-tournament-2009.firebaseapp.com",
      projectId: "freefire-tournament-2009",
      storageBucket: "freefire-tournament-2009.appspot.com",
      messagingSenderId: "498357283098",
      appId: "1:498357283098:web:2f05123efe6c57e65524a3",
      databaseURL: "https://freefire-tournament-2009-default-rtdb.firebaseio.com"
    };
    const ADMIN_EMAIL = 'avinashnaruka89@gmail.com';
    const ADMIN_PHONE = '7976726014';
    const UPI_PHONEPE = '7976726014@axl';
    const UPI_GPAY = 'avinashnaruka89@okicici';
    // ----------------------------

    firebase.initializeApp(FIREBASE_CONFIG);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // DOM
    const authSection = document.getElementById('authSection');
    const appDiv = document.getElementById('app');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authMessage = document.getElementById('authMessage');
    const userEmail = document.getElementById('userEmail');

    const adminControls = document.getElementById('adminControls');
    const adminBadge = document.getElementById('adminBadge');
    const adminRegsDiv = document.getElementById('adminRegs');
    const adminSelectTournament = document.getElementById('adminSelectTournament');
    const adminRegsTableBody = document.querySelector('#adminRegsTable tbody');

    const tName = document.getElementById('tName');
    const tDate = document.getElementById('tDate');
    const tMode = document.getElementById('tMode');
    const tSlots = document.getElementById('tSlots');
    const tFee = document.getElementById('tFee');
    const saveTBtn = document.getElementById('saveTBtn');
    const cancelEditTBtn = document.getElementById('cancelEditTBtn');

    const selectTournament = document.getElementById('selectTournament');
    const registrationPanel = document.getElementById('registrationPanel');
    const playerName = document.getElementById('playerName');
    const playerIGN = document.getElementById('playerIGN');
    const playerPhone = document.getElementById('playerPhone');
    const ffIdsContainer = document.getElementById('ffIdsContainer');
    const entryFee = document.getElementById('entryFee');
    const totalAmount = document.getElementById('totalAmount');
    const payAndRegisterBtn = document.getElementById('payAndRegisterBtn');
    const payPhonePeBtn = document.getElementById('payPhonePeBtn');
    const payGPayBtn = document.getElementById('payGPayBtn');

    const qrSection = document.getElementById('qrSection');
    const qrCanvas = document.getElementById('qrCanvas');
    const upiPaymentLink = document.getElementById('upiPaymentLink');

    const uploadSection = document.getElementById('uploadSection');
    const paymentFile = document.getElementById('paymentFile');
    const paymentPreview = document.getElementById('paymentPreview');
    const utrInput = document.getElementById('utrInput');
    const submitRegBtn = document.getElementById('submitRegBtn');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    const uploadMsg = document.getElementById('uploadMsg');

    const userRegsTable = document.querySelector('#userRegsTable tbody');

    const callAdminBtn = document.getElementById('callAdminBtn');
    const waAdminBtn = document.getElementById('waAdminBtn');

    // state
    let currentUser = null;
    let isAdmin = false;
    let tournaments = [];
    let editingTournamentId = null;
    let selectedTournamentId = null;

    // helpers
    function show(el){ el.classList.remove('hidden') }
    function hide(el){ el.classList.add('hidden') }
    function setAuthMsg(msg, ok=true){ authMessage.textContent = msg; authMessage.style.color = ok? '#9fe8c6' : '#f8c6c6' }
    function isMobile(){ return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) }

    // AUTH
    signupBtn.addEventListener('click', async ()=>{
      setAuthMsg('');
      const email = emailInput.value.trim(); const pass = passwordInput.value;
      if(!email || !pass){ setAuthMsg('Email & password required', false); return; }
      try{ await auth.createUserWithEmailAndPassword(email, pass); setAuthMsg('Signup successful'); }
      catch(e){ setAuthMsg('Signup error: '+e.message, false) }
    });

    loginBtn.addEventListener('click', async ()=>{
      setAuthMsg('');
      const email = emailInput.value.trim(); const pass = passwordInput.value;
      if(!email || !pass){ setAuthMsg('Email & password required', false); return; }
      try{ await auth.signInWithEmailAndPassword(email, pass); setAuthMsg('Login successful'); }
      catch(e){ setAuthMsg('Login error: '+e.message, false) }
    });

    logoutBtn.addEventListener('click', async ()=>{ await auth.signOut(); });

    auth.onAuthStateChanged(async user=>{
      currentUser = user;
      if(user){
        userEmail.textContent = user.email;
        hide(authSection); show(appDiv); show(logoutBtn);
        isAdmin = (user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
        if(isAdmin){ show(adminControls); show(adminBadge); show(adminRegsDiv); } else { hide(adminControls); hide(adminBadge); hide(adminRegsDiv); show(registrationPanel) }
        await loadTournaments();
        restorePending();
      } else {
        userEmail.textContent = '';
        show(authSection); hide(appDiv); hide(logoutBtn);
      }
    });

    // TOURNAMENTS
    saveTBtn.addEventListener('click', async ()=>{
      const name = tName.value.trim(); const dateVal = tDate.value; const mode = tMode.value; const slots = Number(tSlots.value)||0; const fee = Number(tFee.value)||0;
      if(!name || !dateVal || !mode || slots<=0){ alert('Fill tournament details'); return; }
      const dateMs = new Date(dateVal).getTime();
      try{
        if(editingTournamentId){ await db.collection('tournaments').doc(editingTournamentId).update({ name, date:dateMs, mode, slots, fee }); editingTournamentId=null; cancelEditTBtn.classList.add('hidden'); }
        else{ await db.collection('tournaments').add({ name, date:dateMs, mode, slots, fee }); }
        tName.value=''; tDate.value=''; tMode.value='solo'; tSlots.value=12; tFee.value=20;
        await loadTournaments();
      }catch(e){ alert('Save failed: '+e.message) }
    });

    cancelEditTBtn.addEventListener('click', ()=>{ editingTournamentId=null; cancelEditTBtn.classList.add('hidden'); tName.value=''; tDate.value=''; tMode.value='solo'; tSlots.value=12; tFee.value=20; });

    async function loadTournaments(){
      tournaments = []; selectTournament.innerHTML=''; adminSelectTournament.innerHTML='';
      try{ const snap = await db.collection('tournaments').orderBy('date','asc').get(); snap.forEach(d=>{ const o = d.data(); o.id = d.id; tournaments.push(o); }); }
      catch(e){ alert('Load tournaments failed: '+e.message); return; }

      if(tournaments.length===0){ selectTournament.innerHTML='<option value="">No tournaments</option>'; adminSelectTournament.innerHTML='<option value="">No tournaments</option>'; hide(registrationPanel); hide(adminRegsDiv); return; }

      tournaments.forEach(t=>{ const opt=document.createElement('option'); opt.value=t.id; opt.textContent=`${t.name} — ${new Date(t.date).toLocaleString()} (${t.mode})`; selectTournament.appendChild(opt); const opt2=opt.cloneNode(true); adminSelectTournament.appendChild(opt2); });
      selectedTournamentId = selectTournament.value || tournaments[0].id; selectTournament.value=selectedTournamentId; adminSelectTournament.value=selectedTournamentId;
      setupRegistration(selectedTournamentId); if(isAdmin) loadAdminRegs(selectedTournamentId); loadUserRegs();
    }

    selectTournament.addEventListener('change', ()=>{ selectedTournamentId = selectTournament.value; setupRegistration(selectedTournamentId); });
    adminSelectTournament.addEventListener('change', ()=>{ const id = adminSelectTournament.value; if(id) loadAdminRegs(id); });

    document.getElementById('editTournamentBtn').addEventListener('click', ()=>{ const id = adminSelectTournament.value; if(!id) return alert('Select'); const t = tournaments.find(x=>x.id===id); if(!t) return; editingTournamentId=id; tName.value=t.name; tDate.value=new Date(t.date).toISOString().slice(0,16); tMode.value=t.mode; tSlots.value=t.slots; tFee.value=t.fee; cancelEditTBtn.classList.remove('hidden'); });

    document.getElementById('deleteTournamentBtn').addEventListener('click', async ()=>{ const id = adminSelectTournament.value; if(!id) return alert('Select'); if(!confirm('Delete tournament and its registrations?')) return; try{ const regsSnap = await db.collection('tournaments').doc(id).collection('registrations').get(); const batch = db.batch(); regsSnap.forEach(d=>batch.delete(d.ref)); await batch.commit(); await db.collection('tournaments').doc(id).delete(); alert('Deleted'); await loadTournaments(); }catch(e){ alert('Delete failed: '+e.message) } });

    // REGISTRATION SETUP
    function setupRegistration(tid){ const t = tournaments.find(x=>x.id===tid); if(!t){ hide(registrationPanel); return; } show(registrationPanel); ffIdsContainer.innerHTML=''; let count = (t.mode==='solo')?1:(t.mode==='duo')?2:4; for(let i=1;i<=count;i++){ const lbl=document.createElement('label'); lbl.textContent=`Free Fire ID ${i}`; const inp=document.createElement('input'); inp.id=`ffid_${i}`; inp.placeholder=`FF ID ${i}`; ffIdsContainer.appendChild(lbl); ffIdsContainer.appendChild(inp); } entryFee.textContent = Number(t.fee).toFixed(2); totalAmount.textContent = `Total: ₹${Number(t.fee).toFixed(2)}`; hide(uploadSection); hide(qrSection); }

    // PAYMENT FLOW
    function makeUpiUrl(upiId, amount, note){ return `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent('Avinash Naruka')}&am=${encodeURIComponent(Number(amount).toFixed(2))}&cu=INR&tn=${encodeURIComponent(note||'FreeFireTournament')}` }

    payAndRegisterBtn.addEventListener('click', ()=>{ triggerPayment(UPI_PHONEPE); });
    payPhonePeBtn.addEventListener('click', ()=> triggerPayment(UPI_PHONEPE) );
    payGPayBtn.addEventListener('click', ()=> triggerPayment(UPI_GPAY) );

    async function triggerPayment(upiId){
      if(!currentUser) return alert('Login first');
      const t = tournaments.find(x=>x.id===selectedTournamentId); if(!t) return alert('Select tournament');
      if(!playerName.value.trim()) return alert('Enter name'); const phoneVal = playerPhone.value.trim(); if(!/^\d{10,12}$/.test(phoneVal)) return alert('Enter valid phone number');
      let count = (t.mode==='solo')?1:(t.mode==='duo')?2:4; const ffids=[]; for(let i=1;i<=count;i++){ const v=document.getElementById(`ffid_${i}`).value.trim(); if(!v) return alert(`Enter Free Fire ID ${i}`); ffids.push(v); }
      // check slots: treat t.slots as number of teams allowed
      try{ const regsSnap = await db.collection('tournaments').doc(t.id).collection('registrations').get(); if(regsSnap.size >= t.slots) return alert('Tournament full'); }catch(e){ console.error(e) }
      const amount = Number(t.fee); if(isNaN(amount) || amount<=0) return alert('Invalid amount');

      const pending = { tournamentId:t.id, userId:currentUser.uid, amount:amount, playerName:playerName.value.trim(), playerIGN:playerIGN.value.trim(), phone:phoneVal, ffids:ffids };
      localStorage.setItem('ff_pending', JSON.stringify(pending));

      const upiURL = makeUpiUrl(upiId, amount, t.name);
      if(isMobile()){
        if(confirm(`You will be redirected to UPI app to pay ₹${amount.toFixed(2)}. Proceed?`)){
          window.location.href = upiURL;
        }
      } else {
        show(qrSection); upiPaymentLink.href = upiURL; upiPaymentLink.textContent = `Pay ₹${amount.toFixed(2)} via UPI`; QRCode.toCanvas(qrCanvas, upiURL, {width:200}, function(err){ if(err) console.error(err); });
        show(uploadSection);
      }
      alert('Payment started. After finish, upload screenshot & UTR to complete registration.');
    }

    // restore pending
    function restorePending(){ const raw = localStorage.getItem('ff_pending'); if(!raw) return; const p = JSON.parse(raw); if(!currentUser || p.userId !== currentUser.uid) return; try{ selectTournament.value = p.tournamentId; selectedTournamentId = p.tournamentId; setupRegistration(selectedTournamentId); }catch(e){} playerName.value = p.playerName||playerName.value; playerIGN.value = p.playerIGN||playerIGN.value; playerPhone.value = p.phone||playerPhone.value; setTimeout(()=>{ if(p.ffids && Array.isArray(p.ffids)){ for(let i=0;i<p.ffids.length;i++){ const el = document.getElementById(`ffid_${i+1}`); if(el) el.value = p.ffids[i]; } } },200); show(uploadSection); totalAmount.textContent = `Pending: ₹${Number(p.amount).toFixed(2)}`; setAuthMsg('You have a pending payment. Upload proof & UTR to complete.'); }

    cancelUploadBtn.addEventListener('click', ()=>{ localStorage.removeItem('ff_pending'); hide(uploadSection); setAuthMsg('Pending payment cleared'); });

    paymentFile.addEventListener('change', ()=>{ const f = paymentFile.files[0]; if(!f){ paymentPreview.src=''; paymentPreview.classList.add('hidden'); return; } const reader = new FileReader(); reader.onload = e=>{ paymentPreview.src=e.target.result; paymentPreview.classList.remove('hidden'); }; reader.readAsDataURL(f); });

    submitRegBtn.addEventListener('click', async ()=>{
      if(!currentUser) return alert('Login required');
      const raw = localStorage.getItem('ff_pending'); if(!raw) return alert('No pending payment found. Click Pay & Register first.');
      const pending = JSON.parse(raw);
      if(!paymentFile.files[0]) return alert('Upload payment screenshot');
      if(!utrInput.value.trim()) return alert('Enter UTR');
      uploadMsg.textContent = 'Uploading...';
      try{
        const file = paymentFile.files[0];
        const path = `paymentProofs/${currentUser.uid}/${Date.now()}_${file.name}`;
        const ref = storage.ref().child(path);
        const snap = await ref.put(file);
        const url = await snap.ref.getDownloadURL();
        const doc = {
          playerName: pending.playerName,
          playerIGN: pending.playerIGN || '',
          phone: pending.phone,
          freefireIDs: pending.ffids || [],
          userId: currentUser.uid,
          userEmail: currentUser.email,
          amountPaid: pending.amount,
          paymentProofURL: url,
          utr: utrInput.value.trim(),
          paymentStatus: 'Pending',
          createdAt: Date.now()
        };
        await db.collection('tournaments').doc(pending.tournamentId).collection('registrations').add(doc);
        localStorage.removeItem('ff_pending'); uploadMsg.textContent=''; alert('Registration submitted — admin will verify soon.');
        paymentFile.value=''; paymentPreview.src=''; paymentPreview.classList.add('hidden'); utrInput.value=''; hide(uploadSection); hide(qrSection); loadUserRegs(); if(isAdmin) loadAdminRegs(pending.tournamentId);
      }catch(e){ console.error(e); uploadMsg.textContent = 'Upload failed: '+e.message; }
    });

    // load user regs
    async function loadUserRegs(){ if(!currentUser) return; userRegsTable.innerHTML = '<tr><td colspan="7">Loading...</td></tr>'; try{ const rows=[]; for(const t of tournaments){ const snap = await db.collection('tournaments').doc(t.id).collection('registrations').where('userId','==',currentUser.uid).orderBy('createdAt','desc').get(); snap.forEach(d=>{ const r=d.data(); r.id=d.id; r.tournament=t; rows.push(r); }); } if(rows.length===0){ userRegsTable.innerHTML = '<tr><td colspan="7">No registrations</td></tr>'; return; } userRegsTable.innerHTML = rows.map(r=>`<tr><td>${r.tournament.name}</td><td>${new Date(r.tournament.date).toLocaleString()}</td><td>${r.tournament.mode}</td><td>₹${(r.amountPaid||0).toFixed(2)}</td><td>${r.paymentStatus||'Pending'}</td><td>${r.utr||'-'}</td><td>${r.paymentProofURL?`<a href="${r.paymentProofURL}" target="_blank">View</a>`:'-'}</td></tr>`).join(''); }catch(e){ userRegsTable.innerHTML = '<tr><td colspan="7">Error</td></tr>' } }

    // admin regs
    async function loadAdminRegs(tid){ adminRegsTableBody.innerHTML = '<tr><td colspan="8">Loading...</td></tr>'; try{ const snap = await db.collection('tournaments').doc(tid).collection('registrations').orderBy('createdAt','desc').get(); if(snap.empty){ adminRegsTableBody.innerHTML = '<tr><td colspan="8">No regs</td></tr>'; return; } let html=''; snap.forEach(d=>{ const r=d.data(); const ff = Array.isArray(r.freefireIDs)? r.freefireIDs.join(', '):'-'; const wa = r.phone?`<a href="https://wa.me/${r.phone.replace(/\D/g,'')}" target="_blank">WA</a>`:'-'; const proof = r.paymentProofURL?`<a href="${r.paymentProofURL}" target="_blank">View</a>`:'-'; html+=`<tr><td>${r.playerName||'-'}</td><td>${ff}</td><td>${r.phone||'-'}</td><td>₹${(r.amountPaid||0).toFixed(2)}</td><td>${r.utr||'-'}</td><td>${proof}</td><td>${wa}</td><td><button data-id="${d.id}" class="delRegBtn" style="background:#c0392b;color:#fff">Delete</button></td></tr>`; }); adminRegsTableBody.innerHTML = html; Array.from(document.querySelectorAll('.delRegBtn')).forEach(btn=>{ btn.addEventListener('click', async e=>{ const id=e.target.dataset.id; if(!confirm('Delete reg?')) return; try{ await db.collection('tournaments').doc(tid).collection('registrations').doc(id).delete(); loadAdminRegs(tid); }catch(err){ alert('Delete failed: '+err.message) } }); }); }catch(e){ adminRegsTableBody.innerHTML = '<tr><td colspan="8">Error</td></tr>' } }

    // admin select change
    adminSelectTournament.addEventListener('change', ()=>{ const id=adminSelectTournament.value; if(id) loadAdminRegs(id); });

    // call/wa admin
    callAdminBtn.addEventListener('click', ()=> window.location.href = `tel:${ADMIN_PHONE}`);
    waAdminBtn.addEventListener('click', ()=> window.open(`https://wa.me/${ADMIN_PHONE}`,'_blank'));

    // initial restore
    restorePending();

    // expose debug
    window._ff = { loadTournaments, loadUserRegs, loadAdminRegs };

  })();
  </script>
</body>
</html>

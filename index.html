<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Free Fire Tournament</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#0f172a;color:#fff}
    .wrap{max-width:1100px;margin:auto;padding:20px}
    .card{background:#1e293b;padding:18px;border-radius:12px;margin-bottom:20px}
    h1{margin:0 0 10px 0;color:#38bdf8}
    h2{margin:0 0 10px 0;color:#fbbf24}
    label{display:block;margin-top:10px;font-size:14px}
    input,select,button{width:100%;padding:10px;margin-top:5px;border-radius:8px;border:none}
    input,select{background:#0f172a;color:#fff}
    button{background:#fbbf24;color:#000;font-weight:bold;cursor:pointer}
    button:hover{opacity:0.9}
    .btn-ok{background:#22c55e;color:#000}
    .btn-err{background:#ef4444;color:#fff}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid #334155;font-size:14px}
    .hidden{display:none}
    .pill{padding:3px 8px;border-radius:999px;background:#334155}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Free Fire Tournament</h1>
    <div id="whoami">Not logged in</div>
    <button id="btnLogout" class="hidden">Logout</button>
  </div>

  <!-- Auth -->
  <div id="authBox" class="card">
    <h2>Login / Signup</h2>
    <label>Email</label>
    <input id="email" type="email" />
    <label>Password</label>
    <input id="password" type="password" />
    <button id="doLogin">Login</button>
    <button id="doSignup">Signup</button>
    <div id="authMsg"></div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">
    <!-- Admin only -->
    <div id="adminPanel" class="card hidden">
      <h2>Admin — Create Tournament</h2>
      <label>Name</label><input id="tName">
      <label>Date & Time</label><input id="tDate" type="datetime-local">
      <label>Mode</label>
      <select id="tMode">
        <option value="solo">Solo (1)</option>
        <option value="duo">Duo (2)</option>
        <option value="squad">Squad (4)</option>
      </select>
      <label>Team Slots</label><input id="tSlots" type="number" value="10">
      <label>Entry Fee per Player (₹)</label><input id="tFee" type="number" value="20">
      <button id="btnSaveT">Save</button>
      <div id="adminMsg"></div>
      <h2>All Tournaments</h2>
      <select id="adminSel"></select>
      <div id="adminRegBox"></div>
    </div>

    <!-- User Register -->
    <div class="card">
      <h2>Register</h2>
      <label>Select Tournament</label>
      <select id="selTournament"></select>
      <div id="tInfo"></div>
      <label>Team/Player Name</label><input id="rTeamName">
      <div id="ffFields"></div>
      <label>WhatsApp</label><input id="rPhone">
      <label>UTR</label><input id="rUTR">
      <button id="btnRegister" class="btn-ok">Submit</button>
      <div id="regMsg"></div>
    </div>

    <!-- My Regs -->
    <div class="card">
      <h2>My Registrations</h2>
      <div id="myRegs"></div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCAjiInmaJsHSqhlxZZ0heIdNEMu6m6Y6Y",
  authDomain: "freefire-tournament-2009.firebaseapp.com",
  projectId: "freefire-tournament-2009",
  storageBucket: "freefire-tournament-2009.appspot.com",
  messagingSenderId: "498357283098",
  appId: "1:498357283098:web:2f05123efe6c57e65524a3"
};

const ADMIN_EMAIL="avinashnaruka89@gmail.com";
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const $=id=>document.getElementById(id);

let currentUser=null,isAdmin=false;

onAuthStateChanged(auth,async(user)=>{
  currentUser=user||null;
  isAdmin=!!(user && user.email===ADMIN_EMAIL);
  $("whoami").textContent=user?user.email:"Not logged in";
  $("btnLogout").classList.toggle("hidden",!user);
  $("authBox").classList.toggle("hidden",!!user);
  $("app").classList.toggle("hidden",!user);
  $("adminPanel").classList.toggle("hidden",!isAdmin);
  if(user){loadTournaments();loadMyRegs();}
});

$("doLogin").onclick=async()=>{
  try{await signInWithEmailAndPassword(auth,$("email").value,$("password").value);}catch(e){$("authMsg").textContent=e.message;}
};
$("doSignup").onclick=async()=>{
  try{await createUserWithEmailAndPassword(auth,$("email").value,$("password").value);}catch(e){$("authMsg").textContent=e.message;}
};
$("btnLogout").onclick=()=>signOut(auth);

function teamSize(m){return m==="solo"?1:m==="duo"?2:4;}

// Tournaments
async function loadTournaments(){
  $("selTournament").innerHTML="";
  $("adminSel").innerHTML="";
  const snap=await getDocs(query(collection(db,"tournaments"),orderBy("date","asc")));
  snap.forEach(d=>{
    const t={id:d.id,...d.data()};
    const opt=document.createElement("option");
    opt.value=t.id;opt.textContent=`${t.name} (${t.mode})`;
    $("selTournament").appendChild(opt);
    const opt2=opt.cloneNode(true);$("adminSel").appendChild(opt2);
  });
  if($("selTournament").options.length)updateRegisterPanel();
}
$("selTournament").onchange=updateRegisterPanel;
function updateRegisterPanel(){buildFFInputs(teamSize($("tMode").value));}
function buildFFInputs(cnt){$("ffFields").innerHTML="";for(let i=1;i<=cnt;i++){$("ffFields").innerHTML+=`<label>FF ID #${i}</label><input class="ffid">`; }}

// Save Tournament
$("btnSaveT").onclick=async()=>{
  if(!isAdmin)return;
  await addDoc(collection(db,"tournaments"),{name:$("tName").value,date:new Date($("tDate").value).toISOString(),mode:$("tMode").value,teamSlots:Number($("tSlots").value),feePerPlayer:Number($("tFee").value),regCount:0,createdAt:serverTimestamp()});
  $("adminMsg").textContent="Tournament Saved ✔";loadTournaments();
};

// Register
$("btnRegister").onclick=async()=>{
  try{
    const tid=$("selTournament").value;const t=await getDoc(doc(db,"tournaments",tid));
    if(!t.exists())throw new Error("Tournament missing");
    const size=teamSize(t.data().mode);
    const ffids=[...document.querySelectorAll(".ffid")].map(x=>x.value.trim());
    if(ffids.length!==size||ffids.some(x=>!x))throw new Error("All FF IDs required");
    await addDoc(collection(db,"registrations"),{
      tournamentId:tid,userId:currentUser.uid,userEmail:currentUser.email,
      teamName:$("rTeamName").value,phone:$("rPhone").value,ffids,utr:$("rUTR").value,status:"pending",createdAt:serverTimestamp()
    });
    $("regMsg").textContent="Submitted ✔";loadMyRegs();
  }catch(e){$("regMsg").textContent=e.message;}
};

// My Registrations
async function loadMyRegs(){
  const box=$("myRegs");box.innerHTML="";
  const snap=await getDocs(query(collection(db,"registrations"),where("userId","==",currentUser.uid)));
  if(snap.empty){box.textContent="No registrations";return;}
  let html="<table><tr><th>Tournament</th><th>Team</th><th>FF IDs</th><th>Status</th></tr>";
  for(const d of snap.docs){
    const r=d.data();const t=await getDoc(doc(db,"tournaments",r.tournamentId));
    html+=`<tr><td>${t.exists()?t.data().name:"-"}</td><td>${r.teamName}</td><td>${r.ffids.join(",")}</td><td><span class="pill">${r.status}</span></td></tr>`;
  }
  box.innerHTML=html+"</table>";
}

// Admin registrations
$("adminSel").onchange=loadAdminRegs;
async function loadAdminRegs(){
  const tid=$("adminSel").value;const snap=await getDocs(query(collection(db,"registrations"),where("tournamentId","==",tid)));
  if(snap.empty){$("adminRegBox").textContent="No registrations";return;}
  let html="<table><tr><th>Team</th><th>Phone</th><th>UTR</th><th>Status</th><th>Actions</th></tr>";
  for(const d of snap.docs){
    const r={id:d.id,...d.data()};
    html+=`<tr><td>${r.teamName}</td><td>${r.phone}</td><td>${r.utr}</td><td>${r.status}</td>
    <td><button class="btn-ok" onclick="approve('${r.id}')">Approve</button>
    <button class="btn-err" onclick="reject('${r.id}')">Reject</button></td></tr>`;
  }
  $("adminRegBox").innerHTML=html+"</table>";
}
window.approve=async(id)=>{await updateDoc(doc(db,"registrations",id),{status:"approved"});loadAdminRegs();};
window.reject=async(id)=>{await updateDoc(doc(db,"registrations",id),{status:"rejected"});loadAdminRegs();};
</script>
</body>
</html>

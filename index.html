<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Free Fire Tournament Manager</title>
  <style>
    /* clean gradient theme */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    :root { --accent:#f39c12; --bg1:#0e1720; --card:#11161b; --muted:#9aa6b2; }
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Arial;margin:0;background:linear-gradient(135deg,#0b2a3a,#072b3a);color:#eef2f6;min-height:100vh;padding:18px}
    .wrap{max-width:980px;margin:0 auto;background:var(--card);padding:18px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
    h1,h2,h3{margin:0 0 10px;color:var(--accent)}
    label{display:block;margin-top:10px;color:var(--muted);font-size:14px}
    input,select,textarea,button{width:100%;padding:10px;border-radius:8px;border:0;background:#0e1720;color:#eef2f6}
    button{cursor:pointer;font-weight:700;background:var(--accent);color:#091219}
    button.secondary{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.06)}
    .flex{display:flex;gap:12px;flex-wrap:wrap}
    .flex > *{flex:1;min-width:160px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .admin-badge{background:#0f172a;padding:6px 10px;border-radius:999px;color:var(--accent);font-weight:700}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse;margin-top:14px;}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:14px}
    th{background:rgba(255,255,255,0.03);color:var(--muted)}
    .muted{color:var(--muted);font-size:13px}
    .notice{background:rgba(243,156,18,0.08);border:1px solid rgba(243,156,18,0.12);padding:10px;border-radius:8px;margin-bottom:12px;color:#fff}
    .screenshot-preview{max-width:140px;max-height:100px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.06)}
    #qrCanvas{background:#fff;border-radius:8px;display:block;margin:12px auto}
    .small{font-size:13px;padding:7px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Free Fire Tournament Manager</h1>
        <div class="muted">Manage tournaments • players pay via UPI • admin verifies payments</div>
      </div>
      <div>
        <span id="userEmail" class="muted"></span>
        <button id="logoutBtn" class="small hidden">Logout</button>
      </div>
    </div>

    <!-- AUTH -->
    <div id="authSection">
      <h2>Login / Signup</h2>
      <label>Email</label>
      <input id="emailInput" type="email" placeholder="you@example.com" />
      <label>Password</label>
      <input id="passwordInput" type="password" placeholder="password" />
      <div class="flex" style="margin-top:10px">
        <button id="loginBtn">Login</button>
        <button id="signupBtn" class="secondary">Sign up</button>
      </div>
      <div id="authMessage" class="muted" style="margin-top:8px"></div>
      <div class="notice" style="margin-top:12px">
        Admin email: <strong>avinashnaruka89@gmail.com</strong> (make sure this account exists in Firebase Auth with your chosen password)
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">

      <div class="flex" style="align-items:center;justify-content:space-between">
        <h2>Tournaments</h2>
        <span id="adminBadge" class="admin-badge hidden">Admin</span>
      </div>

      <div class="notice">
        <strong>Payment flow:</strong> Click Pay → mobile opens UPI app (redirect) / desktop shows QR. After payment, upload screenshot + enter UTR → Submit registration. Admin will verify.
      </div>

      <!-- Admin create/edit -->
      <div id="adminControls" class="hidden" style="margin-bottom:12px">
        <h3>Create / Edit Tournament</h3>
        <label>Tournament name</label>
        <input id="tName" placeholder="Sunday Clash">
        <label>Date & time</label>
        <input id="tDate" type="datetime-local">
        <label>Mode</label>
        <select id="tMode"><option value="solo">Solo (1)</option><option value="duo">Duo (2)</option><option value="squad">Squad (4)</option></select>
        <label>Slots (teams / solos count)</label>
        <input id="tSlots" type="number" value="12" min="1">
        <label>Entry fee (₹)</label>
        <input id="tFee" type="number" value="20" min="0">
        <div style="margin-top:8px" class="flex">
          <button id="saveTBtn">Save Tournament</button>
          <button id="cancelEditTBtn" class="secondary hidden">Cancel Edit</button>
        </div>
      </div>

      <!-- Tournament list & select -->
      <div style="margin-top:10px">
        <label>Select tournament to open</label>
        <select id="selectTournament"></select>
      </div>

      <!-- Registration panel (users) -->
      <div id="registrationPanel" style="margin-top:12px" class="hidden">
        <h3>Register</h3>
        <label>Your name</label>
        <input id="playerName" placeholder="Name">

        <label>Phone (WhatsApp)</label>
        <input id="playerPhone" placeholder="10 digit number">

        <div id="ffIdsContainer"></div>

        <div style="margin-top:10px" class="muted">Entry fee: ₹<span id="entryFee">0</span></div>
        <div id="totalAmount" class="muted" style="text-align:right;margin-top:6px"></div>

        <div style="margin-top:10px" class="flex">
          <button id="payAndRegisterBtn" class="gradient">Pay & Register</button>
        </div>

        <!-- QR + link -->
        <div id="qrSection" class="hidden" style="margin-top:12px">
          <div class="muted">Scan QR (desktop) or click link below to open UPI app:</div>
          <canvas id="qrCanvas" width="200" height="200"></canvas>
          <div style="text-align:center;margin-top:8px">
            <a id="upiPaymentLink" href="#" target="_blank" style="color:var(--accent)"></a>
          </div>
        </div>

        <!-- Upload screenshot after payment -->
        <div id="uploadSection" class="hidden" style="margin-top:12px">
          <label>Upload payment screenshot (1 image)</label>
          <input id="paymentFile" type="file" accept="image/*">
          <img id="paymentPreview" class="screenshot-preview hidden" alt="preview">
          <label>UTR / Transaction reference</label>
          <input id="utrInput" placeholder="UTR or TXN ID">
          <div style="margin-top:10px" class="flex">
            <button id="submitRegBtn">Submit registration</button>
            <button id="cancelUploadBtn" class="secondary">Cancel</button>
          </div>
          <div id="uploadMsg" class="muted" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- User registrations -->
      <div id="userRegs" style="margin-top:18px">
        <h3>Your registrations</h3>
        <table id="userRegsTable"><thead><tr><th>Tournament</th><th>Date</th><th>Mode</th><th>Fee</th><th>Payment</th><th>UTR</th><th>Proof</th></tr></thead><tbody></tbody></table>
      </div>

      <!-- Admin registrations -->
      <div id="adminRegs" class="hidden" style="margin-top:18px">
        <h3>Registrations (admin)</h3>
        <label>Choose tournament</label>
        <select id="adminSelectTournament"></select>
        <table id="adminRegsTable" style="margin-top:8px"><thead><tr><th>Name</th><th>FF IDs</th><th>Phone</th><th>Paid</th><th>UTR</th><th>Proof</th><th>Actions</th></tr></thead><tbody></tbody></table>
      </div>

      <div style="margin-top:16px" class="flex">
        <button id="callAdminBtn" class="secondary">Call Admin</button>
        <button id="waAdminBtn" class="secondary">WhatsApp Admin</button>
      </div>

    </div>
  </div>

  <!-- Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <script>
  (function(){
    // ---------- CONFIG ----------
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyCAjiInmaJsHSqhlxZZ0heIdNEMu6m6Y6Y",
      authDomain: "freefire-tournament-2009.firebaseapp.com",
      projectId: "freefire-tournament-2009",
      storageBucket: "freefire-tournament-2009.appspot.com",
      messagingSenderId: "498357283098",
      appId: "1:498357283098:web:2f05123efe6c57e65524a3"
    };
    const ADMIN_EMAIL = "avinashnaruka89@gmail.com";
    const ADMIN_PHONE = "7976726014";
    const UPI_ID = "7976726014@axl"; // phonepe example
    // ----------------------------

    // init firebase
    firebase.initializeApp(FIREBASE_CONFIG);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // DOM refs
    const authSection = document.getElementById('authSection');
    const appDiv = document.getElementById('app');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authMessage = document.getElementById('authMessage');
    const userEmailSpan = document.getElementById('userEmail');

    const adminControls = document.getElementById('adminControls');
    const adminBadge = document.getElementById('adminBadge');
    const adminRegsDiv = document.getElementById('adminRegs');
    const adminSelectTournament = document.getElementById('adminSelectTournament');
    const adminRegsTableBody = document.querySelector('#adminRegsTable tbody');

    const tName = document.getElementById('tName');
    const tDate = document.getElementById('tDate');
    const tMode = document.getElementById('tMode');
    const tSlots = document.getElementById('tSlots');
    const tFee = document.getElementById('tFee');
    const saveTBtn = document.getElementById('saveTBtn');
    const cancelEditTBtn = document.getElementById('cancelEditTBtn');

    const selectTournament = document.getElementById('selectTournament');
    const registrationPanel = document.getElementById('registrationPanel');
    const playerName = document.getElementById('playerName');
    const playerPhone = document.getElementById('playerPhone');
    const ffIdsContainer = document.getElementById('ffIdsContainer');
    const entryFeeSpan = document.getElementById('entryFee');
    const totalAmountDiv = document.getElementById('totalAmount');
    const payAndRegisterBtn = document.getElementById('payAndRegisterBtn');

    const qrSection = document.getElementById('qrSection');
    const qrCanvas = document.getElementById('qrCanvas');
    const upiPaymentLink = document.getElementById('upiPaymentLink');

    const uploadSection = document.getElementById('uploadSection');
    const paymentFile = document.getElementById('paymentFile');
    const paymentPreview = document.getElementById('paymentPreview');
    const utrInput = document.getElementById('utrInput');
    const submitRegBtn = document.getElementById('submitRegBtn');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    const uploadMsg = document.getElementById('uploadMsg');

    const userRegsTable = document.querySelector('#userRegsTable tbody');

    const callAdminBtn = document.getElementById('callAdminBtn');
    const waAdminBtn   = document.getElementById('waAdminBtn');

    // state
    let currentUser = null;
    let isAdmin = false;
    let tournaments = []; // array of tournament docs
    let editingTournamentId = null;
    let selectedTournamentId = null;

    // helper
    function show(el){ el.classList.remove('hidden') }
    function hide(el){ el.classList.add('hidden') }
    function setAuthMsg(txt, ok=true){ authMessage.textContent = txt; authMessage.style.color = ok ? '#a7f3d0' : '#f8d7da' }

    // detect mobile
    function isMobile() {
      return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    // ===== AUTH =====
    signupBtn.addEventListener('click', async ()=>{
      setAuthMsg('');
      const email = emailInput.value.trim(), pass = passwordInput.value;
      if(!email || !pass){ setAuthMsg('Provide email and password', false); return; }
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
        setAuthMsg('Signup successful — logged in');
      }catch(e){ setAuthMsg('Signup error: '+e.message,false) }
    });

    loginBtn.addEventListener('click', async ()=>{
      setAuthMsg('');
      const email = emailInput.value.trim(), pass = passwordInput.value;
      if(!email || !pass){ setAuthMsg('Provide email and password', false); return; }
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        setAuthMsg('Login successful');
      }catch(e){ setAuthMsg('Login error: '+e.message,false) }
    });

    logoutBtn.addEventListener('click', async ()=>{ await auth.signOut(); });

    auth.onAuthStateChanged(async user => {
      currentUser = user;
      if(user){
        // logged in
        userEmailSpan.textContent = user.email;
        hide(authSection);
        show(appDiv);
        show(logoutBtn);
        isAdmin = (user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase());
        if(isAdmin){ show(adminControls); show(adminBadge); show(adminRegsDiv); } else { hide(adminControls); hide(adminBadge); hide(adminRegsDiv); show(registrationPanel) }
        // load tournaments
        await loadTournaments();
        // restore pending payment state if any
        restorePendingPayment();
      } else {
        // logged out
        userEmailSpan.textContent = '';
        show(authSection);
        hide(appDiv);
        hide(logoutBtn);
        isAdmin = false;
      }
    });

    // ===== TOURNAMENTS CRUD & LOAD =====

    // Save (create/update) tournament
    saveTBtn.addEventListener('click', async ()=>{
      const name = tName.value.trim();
      const dateVal = tDate.value;
      const mode = tMode.value;
      const slots = Number(tSlots.value) || 0;
      const fee = Number(tFee.value) || 0;
      if(!name || !dateVal || !mode || slots<=0){ alert('Please fill tournament details'); return; }
      const dateMs = new Date(dateVal).getTime();
      try{
        if(editingTournamentId){
          await db.collection('tournaments').doc(editingTournamentId).update({ name, date: dateMs, mode, slots, fee });
          editingTournamentId = null;
          cancelEditTBtn.classList.add('hidden');
        } else {
          await db.collection('tournaments').add({ name, date: dateMs, mode, slots, fee });
        }
        tName.value=''; tDate.value=''; tMode.value='solo'; tSlots.value=12; tFee.value=20;
        await loadTournaments();
      }catch(e){ alert('Save failed: '+e.message) }
    });

    cancelEditTBtn.addEventListener('click', ()=>{
      editingTournamentId = null; cancelEditTBtn.classList.add('hidden');
      tName.value=''; tDate.value=''; tMode.value='solo'; tSlots.value=12; tFee.value=20;
    });

    async function loadTournaments(){
      tournaments = [];
      selectTournament.innerHTML = '';
      adminSelectTournament.innerHTML = '';
      try {
        const snap = await db.collection('tournaments').orderBy('date','asc').get();
        snap.forEach(d=>{ let o = d.data(); o.id = d.id; tournaments.push(o); });
      } catch(e){ alert('Could not load tournaments: '+e.message); return; }

      if(tournaments.length===0){
        selectTournament.innerHTML = '<option value="">No tournaments</option>';
        adminSelectTournament.innerHTML = '<option value="">No tournaments</option>';
        hide(registrationPanel);
        hide(adminRegsDiv);
        return;
      }

      tournaments.forEach(t=>{
        const opt = document.createElement('option'); opt.value=t.id; opt.textContent = `${t.name} — ${new Date(t.date).toLocaleString()} (${t.mode})`;
        selectTournament.appendChild(opt);
        const opt2 = opt.cloneNode(true); adminSelectTournament.appendChild(opt2);
      });

      // default selected
      selectedTournamentId = selectTournament.value || tournaments[0].id;
      selectTournament.value = selectedTournamentId;
      adminSelectTournament.value = selectedTournamentId;

      // update UI for selection
      setupRegistrationFor(selectedTournamentId);
      if(isAdmin) loadAdminRegistrations(selectedTournamentId);
      loadUserRegistrations();
    }

    // when user selects tournament
    selectTournament.addEventListener('change', ()=>{
      selectedTournamentId = selectTournament.value;
      setupRegistrationFor(selectedTournamentId);
    });

    adminSelectTournament.addEventListener('change', ()=>{
      const id = adminSelectTournament.value;
      if(id) loadAdminRegistrations(id);
    });

    // edit selected tournament (admin)
    document.getElementById('editTournamentBtn').addEventListener('click', ()=>{
      const id = adminSelectTournament.value;
      if(!id) return alert('Select tournament');
      const t = tournaments.find(x=>x.id===id);
      if(!t) return alert('Not found');
      editingTournamentId = id;
      tName.value = t.name;
      tDate.value = new Date(t.date).toISOString().slice(0,16);
      tMode.value = t.mode;
      tSlots.value = t.slots;
      tFee.value = t.fee;
      cancelEditTBtn.classList.remove('hidden');
    });

    // delete tournament (admin)
    document.getElementById('deleteTournamentBtn').addEventListener('click', async ()=>{
      const id = adminSelectTournament.value;
      if(!id) return alert('Select tournament');
      if(!confirm('Delete this tournament and ALL registrations?')) return;
      try {
        // delete registrations subcollection documents
        const regsSnap = await db.collection('tournaments').doc(id).collection('registrations').get();
        const batch = db.batch();
        regsSnap.forEach(d=>batch.delete(d.ref));
        await batch.commit();
        // delete tournament doc
        await db.collection('tournaments').doc(id).delete();
        alert('Deleted');
        await loadTournaments();
      } catch(e){ alert('Delete error: '+e.message) }
    });

    // ===== REGISTRATION UI setup per tournament =====
    function setupRegistrationFor(tid){
      const t = tournaments.find(x=>x.id===tid);
      if(!t){ hide(registrationPanel); return; }
      selectedTournamentId = tid;
      show(registrationPanel);

      // build FF ID inputs
      ffIdsContainer.innerHTML = '';
      let count = 1;
      if(t.mode==='duo') count = 2; else if(t.mode==='squad') count = 4;
      for(let i=1;i<=count;i++){
        const lbl = document.createElement('label'); lbl.textContent = `Free Fire ID ${i}`;
        const inp = document.createElement('input'); inp.id = `ffid_${i}`; inp.placeholder = `FF ID ${i}`;
        ffIdsContainer.appendChild(lbl); ffIdsContainer.appendChild(inp);
      }

      entryFeeSpan.textContent = Number(t.fee).toFixed(2);
      totalAmountDiv.textContent = `Payable: ₹${Number(t.fee).toFixed(2)}`;
      // hide upload & qr by default
      hide(uploadSection);
      hide(qrSection);

      // set pay button info via dataset
      payAndRegisterBtn.dataset.tid = tid;
    }

    // ===== Payment flow =====

    // On pay click: set pending payment, show QR on desktop or redirect on mobile.
    payAndRegisterBtn.addEventListener('click', async ()=>{
      if(!currentUser) return alert('Please login first');
      const t = tournaments.find(x=>x.id===selectedTournamentId);
      if(!t) return alert('Select tournament');

      // basic validation: name, phone, FFIDs
      if(!playerName.value.trim()) return alert('Enter your name');
      const phoneVal = playerPhone.value.trim();
      if(!/^\d{10,12}$/.test(phoneVal)) return alert('Enter valid phone (digits only)');

      let count = (t.mode==='solo')?1:(t.mode==='duo')?2:4;
      const ffids = [];
      for(let i=1;i<=count;i++){
        const v = document.getElementById(`ffid_${i}`)?.value.trim();
        if(!v) return alert(`Enter Free Fire ID ${i}`);
        ffids.push(v);
      }

      // Check slot availability: count registrations in tournament
      try {
        const regsSnap = await db.collection('tournaments').doc(t.id).collection('registrations').get();
        // Here we check number of teams/players — this demo treats slots as number of teams (not per-player)
        if(regsSnap.size >= t.slots){
          return alert('Tournament full — registration closed');
        }
      } catch(e){ console.error('slot check err',e) }

      const amount = Number(t.fee);
      if(isNaN(amount) || amount <= 0){
        // for zero-fee tournaments we can directly open upload section
        alert('Tournament fee is zero — proceed to submit registration proof not required');
        return;
      }

      // Save pending payment info to localStorage so when user returns we can restore
      const pending = {
        tournamentId: t.id,
        userId: currentUser.uid,
        amount: amount,
        playerName: playerName.value.trim(),
        phone: phoneVal,
        ffids
      };
      localStorage.setItem('ff_pending_payment', JSON.stringify(pending));

      // If mobile: redirect to UPI scheme. If desktop: show QR and link.
      const upiURL = `upi://pay?pa=${encodeURIComponent(UPI_ID)}&pn=${encodeURIComponent('Avinash Naruka')}&am=${amount.toFixed(2)}&cu=INR&tn=${encodeURIComponent(t.name)}`;

      if(isMobile()){
        // Show uploadSection after user returns — but we set pending in localStorage and navigate now.
        // Some UPI apps may open; user should come back and then click upload.
        if(confirm(`You will be redirected to your UPI / payment app to pay ₹${amount.toFixed(2)}. Proceed?`)){
          // open deep link; fallback to web intent if needed
          window.location.href = upiURL;
          // After redirect user may come back; we already saved pending.
        }
      } else {
        // Desktop: show QR and link and reveal upload area so user can scan and then upload
        show(qrSection);
        upiPaymentLink.textContent = `Pay ₹${amount.toFixed(2)} via UPI link`;
        upiPaymentLink.href = upiURL;
        // generate QR
        QRCode.toCanvas(qrCanvas, upiURL, { width: 200 }, function (err) { if(err) console.error(err) });
        // show upload section immediately (user can scan and then upload)
        show(uploadSection);
      }

      // Provide feedback
      alert('Payment started — once you complete payment, upload screenshot and enter UTR to finish registration.');
    });

    // Restore pending payment when page loads or auth state changes
    function restorePendingPayment(){
      const raw = localStorage.getItem('ff_pending_payment');
      if(!raw) return;
      const pending = JSON.parse(raw);
      // If pending tournament matches selected tournament and user matches, show upload form prefilled
      if(currentUser && pending.userId === currentUser.uid){
        // auto-select tournament if not selected
        if(!selectedTournamentId || selectedTournamentId !== pending.tournamentId){
          // attempt to select
          try{ selectTournament.value = pending.tournamentId; selectedTournamentId = pending.tournamentId; }catch(e){}
        }
        // prefill player info
        playerName.value = pending.playerName || playerName.value;
        playerPhone.value = pending.phone || playerPhone.value;
        // fill FF IDs if available
        setTimeout(()=>{ // after ff inputs are built
          const t = tournaments.find(x=>x.id===pending.tournamentId);
          if(t){
            let count = (t.mode==='solo')?1:(t.mode==='duo')?2:4;
            if(pending.ffids && Array.isArray(pending.ffids)){
              for(let i=0;i<count;i++){
                const el = document.getElementById(`ffid_${i+1}`);
                if(el) el.value = pending.ffids[i] || '';
              }
            }
          }
        },200);
        // show upload section
        show(uploadSection);
        totalAmountDiv.textContent = `Payable: ₹${Number(pending.amount).toFixed(2)} (pending)`;
        setAuthMsg('You have an incomplete payment. Upload proof & UTR to complete registration.');
      }
    }

    // Cancel upload (user decided not to proceed)
    cancelUploadBtn.addEventListener('click', ()=>{
      localStorage.removeItem('ff_pending_payment');
      hide(uploadSection);
      setAuthMsg('Payment cancelled or cleared.');
    });

    // Payment preview
    paymentFile.addEventListener('change', ()=>{
      const f = paymentFile.files[0];
      if(!f){ paymentPreview.src=''; paymentPreview.classList.add('hidden'); return; }
      const reader = new FileReader();
      reader.onload = e => { paymentPreview.src = e.target.result; paymentPreview.classList.remove('hidden'); }
      reader.readAsDataURL(f);
    });

    // Submit registration (after upload)
    submitRegBtn.addEventListener('click', async ()=>{
      // validate
      if(!currentUser) return alert('Login required');
      const pendingRaw = localStorage.getItem('ff_pending_payment');
      if(!pendingRaw) return alert('No pending payment found. Click Pay & Register first.');
      const pending = JSON.parse(pendingRaw);
      if(!paymentFile.files[0]) return alert('Upload payment screenshot');
      if(!utrInput.value.trim()) return alert('Enter UTR');
      // upload image
      try {
        uploadMsg.textContent = 'Uploading proof...';
        const file = paymentFile.files[0];
        const path = `paymentProofs/${currentUser.uid}/${Date.now()}_${file.name}`;
        const storageRef = storage.ref().child(path);
        const snap = await storageRef.put(file);
        const url = await snap.ref.getDownloadURL();

        // prepare registration doc
        const regDoc = {
          playerName: pending.playerName,
          phone: pending.phone,
          freefireIDs: pending.ffids || [],
          userId: currentUser.uid,
          userEmail: currentUser.email,
          amountPaid: pending.amount,
          paymentProofURL: url,
          utr: utrInput.value.trim(),
          paymentStatus: 'Pending',
          createdAt: Date.now()
        };

        // Save in tournaments/{tid}/registrations
        await db.collection('tournaments').doc(pending.tournamentId).collection('registrations').add(regDoc);

        // clear pending state
        localStorage.removeItem('ff_pending_payment');
        uploadMsg.textContent = '';
        alert('Registration submitted — admin will verify payment soon.');
        // reset upload UI
        paymentFile.value=''; paymentPreview.src=''; paymentPreview.classList.add('hidden'); utrInput.value='';
        hide(uploadSection); hide(qrSection);
        loadUserRegistrations();
        if(isAdmin) loadAdminRegistrations(pending.tournamentId);
      } catch(e){
        console.error(e); uploadMsg.textContent = 'Upload failed: '+e.message;
      }
    });

    // ===== Load user & admin registrations =====
    async function loadUserRegistrations(){
      if(!currentUser) return;
      userRegsTable.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
      try{
        // Go through tournaments and fetch regs where userId==currentUser.uid
        const rows = [];
        for(const t of tournaments){
          const regsSnap = await db.collection('tournaments').doc(t.id).collection('registrations').where('userId','==', currentUser.uid).orderBy('createdAt','desc').get();
          regsSnap.forEach(d=>{
            const r = d.data(); r.id = d.id; r.tournament = t; rows.push(r);
          });
        }
        if(rows.length===0) { userRegsTable.innerHTML = '<tr><td colspan="7">No registrations</td></tr>'; return; }
        const html = rows.map(r=>{
          return `<tr>
            <td>${r.tournament.name}</td>
            <td>${new Date(r.tournament.date).toLocaleString()}</td>
            <td>${r.tournament.mode}</td>
            <td>₹${(r.amountPaid||0).toFixed? (r.amountPaid||0).toFixed(2) : (r.amountPaid||0)}</td>
            <td>${r.paymentStatus||'Pending'}</td>
            <td>${r.utr||'-'}</td>
            <td>${r.paymentProofURL ? `<a href="${r.paymentProofURL}" target="_blank">View</a>` : '-'}</td>
          </tr>`}).join('');
        userRegsTable.innerHTML = html;
      }catch(e){ userRegsTable.innerHTML = '<tr><td colspan="7">Error loading</td></tr>' }
    }

    async function loadAdminRegistrations(tid){
      adminRegsTableBody.innerHTML = '<tr><td colspan="8">Loading...</td></tr>';
      try{
        const regsSnap = await db.collection('tournaments').doc(tid).collection('registrations').orderBy('createdAt','desc').get();
        if(regsSnap.empty){ adminRegsTableBody.innerHTML = '<tr><td colspan="8">No registrations</td></tr>'; return; }
        let html = '';
        regsSnap.forEach(d=>{
          const r = d.data(); r.id = d.id;
          const ff = Array.isArray(r.freefireIDs)? r.freefireIDs.join(', ') : (r.freefireIDs||'-');
          const whatsapp = r.phone ? `<a href="https://wa.me/${r.phone.replace(/\D/g,'')}" target="_blank">WA</a>` : '-';
          const proof = r.paymentProofURL ? `<a href="${r.paymentProofURL}" target="_blank">View</a>` : '-';
          html += `<tr>
            <td>${r.playerName||'-'}</td>
            <td>${ff}</td>
            <td>${r.phone||'-'}</td>
            <td>₹${(r.amountPaid||0).toFixed? (r.amountPaid||0).toFixed(2) : (r.amountPaid||0)}</td>
            <td>${r.utr||'-'}</td>
            <td>${proof}</td>
            <td>${whatsapp}</td>
            <td>
              <button data-id="${d.id}" class="adminDeleteBtn" style="background:#c0392b;color:#fff">Delete</button>
            </td>
          </tr>`;
        });
        adminRegsTableBody.innerHTML = html;

        // attach delete buttons
        Array.from(document.querySelectorAll('.adminDeleteBtn')).forEach(btn=>{
          btn.addEventListener('click', async (e)=>{
            const docId = e.target.dataset.id;
            if(!confirm('Delete this registration?')) return;
            try{
              await db.collection('tournaments').doc(tid).collection('registrations').doc(docId).delete();
              loadAdminRegistrations(tid);
            }catch(err){ alert('Delete failed: '+err.message) }
          });
        });
      }catch(e){ adminRegsTableBody.innerHTML = '<tr><td colspan="8">Error loading</td></tr>' }
    }

    // admin select tournament change loads regs
    adminSelectTournament.addEventListener('change', ()=>{ const id = adminSelectTournament.value; if(id) loadAdminRegistrations(id) });

    // call / wa admin buttons
    callAdminBtn.addEventListener('click', ()=> window.location.href = `tel:${ADMIN_PHONE}`);
    waAdminBtn.addEventListener('click', ()=> window.open(`https://wa.me/${ADMIN_PHONE}`,'_blank'));

    // initial restore when page loads
    restorePendingPayment();

    // expose small debug
    window._ff_internal = { loadTournaments, loadUserRegistrations, loadAdminRegistrations };

  })();
  </script>
</body>
</html>

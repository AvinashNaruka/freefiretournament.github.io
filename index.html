<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Free Fire Tournament</title>
  <style>
    :root{
      --bg1:#0f172a; --bg2:#0b1020; --card:#0f1b2d; --muted:#9fb3c8;
      --brand:#f59e0b; --accent:#22d3ee; --ok:#22c55e; --err:#ef4444;
    }
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#e6eef8}
    .wrap{max-width:1100px;margin:24px auto;padding:18px}
    .card{background:rgba(15,27,45,.9);border:1px solid rgba(255,255,255,.06);
      border-radius:16px;padding:18px;box-shadow:0 10px 40px rgba(2,6,23,.35)}
    h1,h2,h3{margin:0 0 8px 0;font-weight:800}
    h1{font-size:28px;color:#fff}
    h2{font-size:22px;color:var(--accent)}
    h3{font-size:18px;color:var(--brand)}
    .muted{color:var(--muted);font-size:14px}

    label{display:block;font-size:13px;color:#cbd5e1;margin-top:10px}
    input,select,textarea,button{
      width:100%;padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:#0b1626;color:#e6eef8;outline:none
    }
    button{cursor:pointer;background:linear-gradient(135deg,var(--brand),#ffd166);
      color:#111827;font-weight:800;border:none;transition:transform .05s ease}
    button:hover{transform:translateY(-1px)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.16);color:#e6eef8}
    .btn-ok{background:linear-gradient(135deg,#16a34a,#86efac);color:#07240f}
    .btn-err{background:linear-gradient(135deg,#ef4444,#fda4af);color:#2a0608}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px dashed rgba(255,255,255,.08);padding:10px;text-align:left;font-size:14px}
    th{color:#cbd5e1;font-weight:700}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;
      border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:12px}
    .admin{background:rgba(34,211,238,.08);border-color:rgba(34,211,238,.25)}

    .hidden{display:none}
    .qrbox{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    #qr{background:#fff;padding:10px;border-radius:12px}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>Free Fire Tournament</h1>
        <div class="muted">Firebase ‚Ä¢ Single File ‚Ä¢ GitHub Pages Ready</div>
      </div>
      <div style="text-align:right">
        <div id="whoami" class="muted">Not logged in</div>
        <div style="margin-top:8px">
          <button id="btnLogin">Login</button>
          <button id="btnSignup" class="btn-ghost">Sign up</button>
          <button id="btnLogout" class="hidden">Logout</button>
        </div>
        <div style="margin-top:6px">
          <span id="adminBadge" class="badge admin hidden">Admin</span>
        </div>
      </div>
    </div>

    <!-- AUTH -->
    <div id="authBox">
      <h2>Sign in / Sign up</h2>
      <label>Email</label>
      <input id="email" type="email" placeholder="your@email.com" />
      <label>Password</label>
      <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div style="margin-top:10px">
        <button id="doLogin">Login</button>
        <button id="doSignup" class="btn-ghost">Create account</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:8px"></div>
      <p class="muted">Support: üìû <a href="tel:7976726014">7976726014</a> | üí¨ <a href="https://wa.me/919776726014" target="_blank">WhatsApp</a></p>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="hidden">
      <div style="display:flex;gap:16px;flex-wrap:wrap">
        <!-- ADMIN -->
        <div class="card" style="flex:1;min-width:300px">
          <h2>Admin ‚Äî Create / Edit Tournament</h2>
          <label>Name</label>
          <input id="tName" />
          <label>Date & Time</label>
          <input id="tDate" type="datetime-local" />
          <label>Mode</label>
          <select id="tMode">
            <option value="solo">Solo (1)</option>
            <option value="duo">Duo (2)</option>
            <option value="squad">Squad (4)</option>
          </select>
          <label>Team Slots</label>
          <input id="tSlots" type="number" min="1" value="12" />
          <label>Entry Fee per Player (‚Çπ)</label>
          <input id="tFee" type="number" min="1" value="20" />
          <div style="margin-top:10px">
            <button id="btnSaveT">Save Tournament</button>
            <button id="btnResetT" class="btn-ghost">Reset</button>
          </div>
          <div id="adminMsg" class="muted" style="margin-top:8px"></div>
        </div>
        <!-- USER -->
        <div class="card" style="flex:2;min-width:300px">
          <h2>Available Tournaments</h2>
          <div id="tList" class="muted">Loading tournaments...</div>
        </div>
      </div>

      <div style="margin-top:20px" class="card">
        <h2>Register for Tournament</h2>
        <label>Select Tournament</label>
        <select id="regTid"></select>
        <div id="playerFields"></div>
        <label>WhatsApp Number</label>
        <input id="regPhone" type="tel" placeholder="10-digit number" />
        <label>UTR Number</label>
        <input id="regUTR" placeholder="Payment UTR" />
        <label>Payment Screenshot</label>
        <input id="regSS" type="file" accept="image/*" />
        <div style="margin-top:10px">
          <button id="btnPay" class="btn-ok">Pay & Register</button>
        </div>
        <div id="regMsg" class="muted" style="margin-top:8px"></div>
      </div>

      <div style="margin-top:20px" class="card">
        <h2>My Registrations</h2>
        <div id="myRegs" class="muted">No registrations yet</div>
      </div>

      <!-- ADMIN LIST -->
      <div style="margin-top:20px" class="card hidden" id="adminListBox">
        <h2>Participants (Selected Tournament)</h2>
        <label>Select Tournament</label>
        <select id="admTid"></select>
        <div id="admRegs" class="muted">Select tournament to view participants</div>
      </div>

      <!-- QR Modal -->
      <div id="qrModal" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center">
        <div class="card" style="max-width:400px;text-align:center">
          <h2>Scan to Pay</h2>
          <div class="qrbox">
            <div id="qr"></div>
            <div>
              <p>PhonePe: <b>7976726014@axl</b></p>
              <p>GPay: <b>avinashnaruka89@okicici</b></p>
              <p>Amount: ‚Çπ<span id="qrAmt"></span></p>
            </div>
          </div>
          <div style="margin-top:10px">
            <button onclick="document.getElementById('qrModal').classList.add('hidden')">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
  <!-- QR Code lib -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <!-- Firebase + App Logic -->
  <script type="module">
    // ====== CONSTANTS (as per your project) ======
    const ADMIN_EMAIL = 'avinashnaruka89@gmail.com';
    const ADMIN_PHONE = '7976726014';
    const UPI_PHONEPE = '7976726014@axl';
    const UPI_GPAY   = 'avinashnaruka89@okicici';

    // ====== Firebase CDN (v12) ======
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
    import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js';

    // ====== Your Firebase Config ======
    const firebaseConfig = {
      apiKey: "AIzaSyCAjiInmaJsHSqhlxZZ0heIdNEMu6m6Y6Y",
      authDomain: "freefire-tournament-2009.firebaseapp.com",
      databaseURL: "https://freefire-tournament-2009-default-rtdb.firebaseio.com",
      projectId: "freefire-tournament-2009",
      storageBucket: "freefire-tournament-2009.firebasestorage.app",
      messagingSenderId: "498357283098",
      appId: "1:498357283098:web:2f05123efe6c57e65524a3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const storage = getStorage(app);

    // ===== Utilities =====
    const $ = id => document.getElementById(id);
    const isMobile = () => /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    const teamSize = (mode) => mode==='solo'?1 : mode==='duo'?2 : 4;
    const upiLink = (vpa, amount, note='FreeFire Tournament') => {
      if(!amount || amount<=0) return '';
      const p = new URLSearchParams({ pa:vpa, pn:'Avinash', am:String(amount), cu:'INR', tn:note });
      return `upi://pay?${p.toString()}`;
    };

    // ===== Grab DOM =====
    const whoami = $('whoami');
    const btnLogin = $('btnLogin'); const btnSignup = $('btnSignup'); const btnLogout = $('btnLogout');
    const doLogin = $('doLogin'); const doSignup = $('doSignup'); const authMsg = $('authMsg');
    const email = $('email'); const password = $('password');
    const authBox = $('authBox'); const appBox = $('app'); const adminBadge = $('adminBadge');

    // Admin Create/Edit form
    const tName=$('tName'), tDate=$('tDate'), tMode=$('tMode'), tSlots=$('tSlots'), tFee=$('tFee'), btnSaveT=$('btnSaveT'), btnResetT=$('btnResetT'), adminMsg=$('adminMsg');

    // Lists & selects
    const tList = $('tList');
    const regTid = $('regTid');
    const myRegs = $('myRegs');

    // Register fields
    const playerFields = $('playerFields');
    const regPhone = $('regPhone');
    const regUTR = $('regUTR');
    const regSS = $('regSS');
    const btnPay = $('btnPay');
    const regMsg = $('regMsg');

    // Admin list
    const adminListBox = $('adminListBox');
    const admTid = $('admTid');
    const admRegs = $('admRegs');

    // QR modal
    const qrModal = $('qrModal'); const qrDiv = $('qr'); const qrAmt = $('qrAmt');

    // Dynamically tag Admin card for toggle (since Part1 has no id on that card)
    let adminCard = null;
    (function tagAdminCard(){
      const allH2 = document.querySelectorAll('h2');
      for(const h of allH2){
        if(h.textContent.trim().toLowerCase().startsWith('admin ‚Äî create')){
          adminCard = h.closest('.card'); break;
        }
      }
    })();

    // ===== Auth handlers =====
    btnLogin.addEventListener('click', ()=> doLogin.click());
    btnSignup.addEventListener('click', ()=> doSignup.click());
    btnLogout.addEventListener('click', ()=> signOut(auth));

    doLogin.addEventListener('click', async ()=>{
      authMsg.textContent = 'Logging in...';
      try{
        await signInWithEmailAndPassword(auth, email.value.trim(), password.value.trim());
        authMsg.textContent = 'Logged in ‚úîÔ∏è';
      }catch(e){ authMsg.textContent = 'Login error: ' + e.message; }
    });
    doSignup.addEventListener('click', async ()=>{
      authMsg.textContent = 'Creating account...';
      try{
        await createUserWithEmailAndPassword(auth, email.value.trim(), password.value.trim());
        authMsg.textContent = 'Account created ‚úîÔ∏è';
      }catch(e){ authMsg.textContent = 'Signup error: ' + e.message; }
    });

    let currentUser = null;
    let isAdmin = false;

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;
      isAdmin = !!(user && user.email === ADMIN_EMAIL);

      whoami.textContent = user ? user.email : 'Not logged in';
      adminBadge.classList.toggle('hidden', !isAdmin);
      btnLogout.classList.toggle('hidden', !user);

      // show/hide sections
      authBox.classList.toggle('hidden', !!user);
      appBox.classList.toggle('hidden', !user);
      if(adminCard) adminCard.classList.toggle('hidden', !isAdmin);
      adminListBox.classList.toggle('hidden', !isAdmin);

      // Load data
      if(user){
        await loadTournaments();
        await loadMyRegistrations();
      } else {
        tList.innerHTML = 'Please login to view tournaments.';
        regTid.innerHTML = '';
        myRegs.innerHTML = '‚Äî';
        admTid.innerHTML = '';
        admRegs.innerHTML = '‚Äî';
      }
    });

    // ===== Tournaments =====
    let editingId = null;

    async function loadTournaments(){
      // list + dropdowns
      tList.innerHTML = 'Loading...';
      regTid.innerHTML = '';
      admTid.innerHTML = '';

      const qSnap = await getDocs(query(collection(db,'tournaments'), orderBy('date','asc')));
      if(qSnap.empty){
        tList.innerHTML = '<div class="muted">No tournaments yet</div>';
        regTid.innerHTML = '<option value="">(None)</option>';
        admTid.innerHTML = '<option value="">(None)</option>';
        return;
      }

      let html = '<table><thead><tr><th>Name</th><th>Date</th><th>Mode</th><th>Slots</th><th>Registered</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
      const opts = [];
      const aopts = [];

      for(const d of qSnap.docs){
        const t = { id:d.id, ...d.data() };
        const regCount = t.regCount || 0;
        const status = t.closed ? 'Closed' : 'Open';
        html += `<tr>
          <td>${t.name}</td>
          <td>${new Date(t.date).toLocaleString()}</td>
          <td>${t.mode}</td>
          <td>${t.teamSlots}</td>
          <td>${regCount}</td>
          <td>${status}</td>
          <td>
            ${isAdmin ? `
              <button data-act="edit" data-id="${t.id}">Edit</button>
              <button data-act="del" class="btn-err" data-id="${t.id}">Delete</button>
              <button data-act="toggle" class="btn-ghost" data-id="${t.id}">${t.closed?'Open':'Close'}</button>
            ` : '-'}
          </td>
        </tr>`;

        opts.push(`<option value="${t.id}">${t.name} ‚Äî ${new Date(t.date).toLocaleString()}</option>`);
        aopts.push(`<option value="${t.id}">${t.name} ‚Äî ${new Date(t.date).toLocaleString()}</option>`);
      }
      html+='</tbody></table>';
      tList.innerHTML = html;

      regTid.innerHTML = opts.join('');
      admTid.innerHTML = aopts.join('');

      // bind table actions for admin
      if(isAdmin){
        tList.querySelector('tbody').addEventListener('click', async (e)=>{
          const b = e.target.closest('button'); if(!b) return;
          const id = b.dataset.id; const act = b.dataset.act;
          const tRef = doc(db,'tournaments',id);
          const snap = await getDoc(tRef);
          if(!snap.exists()) return;

          if(act==='edit'){
            const t = snap.data();
            editingId = id;
            tName.value = t.name;
            tDate.value = new Date(t.date).toISOString().slice(0,16);
            tMode.value = t.mode;
            tSlots.value = t.teamSlots;
            tFee.value = t.feePerPlayer;
            adminMsg.textContent = 'Editing...';
            window.scrollTo({ top: 0, behavior:'smooth' });
          } else if(act==='del'){
            if(confirm('Delete this tournament and its registrations?')){
              // delete registrations under it
              const rSnap = await getDocs(query(collection(db,'registrations'), where('tournamentId','==',id)));
              const dels = [];
              for(const r of rSnap.docs){ dels.push(deleteDoc(doc(db,'registrations',r.id))); }
              await Promise.all(dels);
              await deleteDoc(tRef);
              await loadTournaments();
              await loadMyRegistrations();
              if(isAdmin) await loadAdminRegs();
            }
          } else if(act==='toggle'){
            const t = snap.data();
            await updateDoc(tRef, { closed: !t.closed });
            await loadTournaments();
          }
        }, { once:true });
      }

      // render player fields for first tournament
      if(regTid.value){ await renderPlayerFields(); }
      if(isAdmin && admTid.value){ await loadAdminRegs(); }
    }

    btnSaveT.addEventListener('click', async ()=>{
      if(!isAdmin) return alert('Admin only');
      try{
        const name = tName.value.trim(); if(!name) throw new Error('Name required');
        const dt = tDate.value; if(!dt) throw new Error('Date required');
        const mode = tMode.value;
        const teamSlots = Number(tSlots.value||0); if(teamSlots<=0) throw new Error('Slots > 0');
        const fee = Number(tFee.value||0); if(fee<=0) throw new Error('Fee per player > 0');

        const payload = {
          name,
          date: new Date(dt).toISOString(),
          mode,
          teamSlots,
          feePerPlayer: fee,
          closed: false,
          regCount: 0,
          updatedAt: serverTimestamp(),
          createdAt: serverTimestamp(),
        };

        if(editingId){
          await updateDoc(doc(db,'tournaments',editingId), payload);
          adminMsg.textContent = 'Tournament updated ‚úîÔ∏è';
        }else{
          await addDoc(collection(db,'tournaments'), payload);
          adminMsg.textContent = 'Tournament created ‚úîÔ∏è';
        }
        editingId=null;
        tName.value=''; tDate.value=''; tMode.value='solo'; tSlots.value='12'; tFee.value='20';
        await loadTournaments();
      }catch(e){ adminMsg.textContent='Error: '+e.message; }
    });

    btnResetT.addEventListener('click', ()=>{
      editingId=null; tName.value=''; tDate.value=''; tMode.value='solo'; tSlots.value='12'; tFee.value='20'; adminMsg.textContent='';
    });

    // ===== Registration UI =====
    regTid.addEventListener('change', renderPlayerFields);

    async function renderPlayerFields(){
      playerFields.innerHTML = 'Loading...';
      regMsg.textContent = '';
      const tid = regTid.value; if(!tid){ playerFields.innerHTML='‚Äî'; return; }
      const tSnap = await getDoc(doc(db,'tournaments',tid)); if(!tSnap.exists()){ playerFields.innerHTML='‚Äî'; return; }
      const t = tSnap.data();
      const size = teamSize(t.mode);
      const amount = (t.feePerPlayer||0) * size;

      // build fields: team name + FF IDs based on mode + UPI choice + amount
      let html = `
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
          <div style="flex:1;min-width:220px">
            <label>${t.mode==='solo'?'Player Name':'Team Name'}</label>
            <input id="regTeam" placeholder="${t.mode==='solo'?'Player name':'Team name'}" />
          </div>
          <div style="flex:1;min-width:220px">
            <label>Choose UPI App</label>
            <select id="upiApp">
              <option value="phonepe">PhonePe</option>
              <option value="gpay">Google Pay</option>
            </select>
          </div>
          <div style="flex:1;min-width:160px">
            <label>Total Amount (auto)</label>
            <input id="regAmount" type="number" value="${amount}" readonly />
          </div>
        </div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
      `;
      for(let i=1;i<=size;i++){
        html += `
          <div style="flex:1;min-width:180px">
            <label>Free Fire ID #${i}</label>
            <input class="ffid" placeholder="FF ID ${i}" />
          </div>
        `;
      }
      html += `</div>
        <div class="muted" style="margin-top:6px">
          Mode: <b>${t.mode.toUpperCase()}</b> ‚Ä¢ Entry per player ‚Çπ${t.feePerPlayer} ‚áí Team pays <b>‚Çπ${amount}</b>
        </div>
      `;
      playerFields.innerHTML = html;
    }

    // ===== Pay & Register =====
    btnPay.addEventListener('click', async ()=>{
      try{
        regMsg.textContent = 'Processing...';

        if(!currentUser) throw new Error('Please login');

        const tid = regTid.value; if(!tid) throw new Error('Select a tournament');
        const tRef = doc(db,'tournaments',tid);
        const tSnap = await getDoc(tRef); if(!tSnap.exists()) throw new Error('Tournament not found');
        const t = tSnap.data(); if(t.closed) throw new Error('Tournament closed');

        // slot check
        const currentReg = t.regCount || 0;
        if(currentReg >= (t.teamSlots || 0)) throw new Error('Seats full');

        // collect fields
        const team = (document.getElementById('regTeam')?.value || '').trim();
        if(!team) throw new Error('Enter team/player name');

        const phone = regPhone.value.trim();
        if(!/^\d{10}$/.test(phone)) throw new Error('Enter 10 digit WhatsApp number');

        const size = teamSize(t.mode);
        const ffids = [...document.querySelectorAll('.ffid')].map(x=>x.value.trim());
        if(ffids.length !== size || ffids.some(x=>!x)) throw new Error('Fill all Free Fire IDs');

        const utr = regUTR.value.trim(); if(!utr || utr.length<6) throw new Error('Enter valid UTR');

        const file = regSS.files[0]; if(!file) throw new Error('Upload payment screenshot');

        const amount = (t.feePerPlayer||0) * size;
        if(!amount || amount<=0) throw new Error('Invalid amount');

        // Trigger payment (mobile redirect or show QR)
        const appSel = (document.getElementById('upiApp')?.value || 'phonepe');
        const vpa = appSel==='gpay' ? UPI_GPAY : UPI_PHONEPE;
        const link = upiLink(vpa, amount, t.name);
        if(isMobile()){
          // redirect first
          if(link) window.location.href = link;
        }else{
          // show QR
          qrAmt.textContent = String(amount);
          qrDiv.innerHTML='';
          await QRCode.toCanvas(document.createElement('canvas'), link, {width:200})
            .then(canvas => qrDiv.appendChild(canvas));
          qrModal.classList.remove('hidden');
        }

        // upload screenshot to Storage
        const path = `proofs/${tid}/${currentUser.uid}_${Date.now()}_${file.name}`;
        const ref = sRef(storage, path);
        const up = await uploadBytes(ref, file);
        const proofUrl = await getDownloadURL(up.ref);

        // add registration
        const regPayload = {
          tournamentId: tid,
          userId: currentUser.uid,
          userEmail: currentUser.email,
          teamName: team,
          phone,
          ffids,
          utr,
          amount,
          proofUrl,
          status: 'pending',
          createdAt: serverTimestamp()
        };
        await addDoc(collection(db,'registrations'), regPayload);

        // safe increment of regCount
        const tSnap2 = await getDoc(tRef);
        if(tSnap2.exists()){
          const current = tSnap2.data().regCount || 0;
          await updateDoc(tRef, { regCount: current + 1 });
        }

        regMsg.textContent = 'Registration submitted ‚úîÔ∏è (pending approval)';
        regPhone.value=''; regUTR.value=''; regSS.value='';
        const teamEl = document.getElementById('regTeam'); if(teamEl) teamEl.value='';
        await loadMyRegistrations();
        await loadTournaments();

      }catch(e){
        regMsg.textContent = 'Error: ' + e.message;
      }
    });

    // ===== My Registrations =====
    async function loadMyRegistrations(){
      if(!currentUser){ myRegs.innerHTML='‚Äî'; return; }
      const qSnap = await getDocs(query(collection(db,'registrations'), where('userId','==',currentUser.uid)));
      if(qSnap.empty){ myRegs.innerHTML = '<div class="muted">No registrations yet</div>'; return; }
      let html = '<table><thead><tr><th>Tournament</th><th>Team</th><th>FF IDs</th><th>Amount</th><th>Status</th><th>UTR</th><th>Proof</th></tr></thead><tbody>';
      for(const d of qSnap.docs){
        const r = d.data();
        const t = await getDoc(doc(db,'tournaments',r.tournamentId));
        const tname = t.exists()? t.data().name : r.tournamentId;
        html += `<tr>
          <td>${tname}</td>
          <td>${r.teamName}</td>
          <td>${(r.ffids||[]).join(', ')}</td>
          <td>‚Çπ${r.amount}</td>
          <td><span class="pill">${r.status}</span></td>
          <td>${r.utr}</td>
          <td>${r.proofUrl? `<a class="link" target="_blank" href="${r.proofUrl}">view</a>`:'-'}</td>
        </tr>`;
      }
      html+='</tbody></table>';
      myRegs.innerHTML = html;
    }

    // ===== Admin: view & approve/reject regs =====
    admTid.addEventListener('change', loadAdminRegs);

    async function loadAdminRegs(){
      const tid = admTid.value; if(!tid){ admRegs.innerHTML='‚Äî'; return; }
      const qSnap = await getDocs(query(collection(db,'registrations'), where('tournamentId','==',tid)));
      if(qSnap.empty){ admRegs.innerHTML = '<div class="muted">No registrations</div>'; return; }
      let html = '<table><thead><tr><th>Team</th><th>Phone</th><th>FF IDs</th><th>UTR</th><th>Proof</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
      for(const d of qSnap.docs){
        const r = { id:d.id, ...d.data() };
        html += `<tr>
          <td>${r.teamName}<div class="muted">${r.userEmail||''}</div></td>
          <td><a class="link" target="_blank" href="https://wa.me/91${r.phone}">${r.phone}</a></td>
          <td>${(r.ffids||[]).join('<br>')}</td>
          <td>${r.utr}</td>
          <td>${r.proofUrl? `<a class="link" target="_blank" href="${r.proofUrl}">view</a>`:'-'}</td>
          <td><span class="pill">${r.status}</span></td>
          <td>
            <button data-a="approve" data-id="${r.id}" class="btn-ok">Approve</button>
            <button data-a="reject" data-id="${r.id}" class="btn-err">Reject</button>
            <button data-a="remove" data-id="${r.id}" class="btn-ghost">Remove</button>
          </td>
        </tr>`;
      }
      html+='</tbody></table>';
      admRegs.innerHTML = html;

      // bind actions
      admRegs.querySelector('tbody').addEventListener('click', async (e)=>{
        const b = e.target.closest('button'); if(!b) return;
        if(!isAdmin) return alert('Admin only');
        const id=b.dataset.id; const a=b.dataset.a;
        const rRef = doc(db,'registrations',id);
        if(a==='approve'){ await updateDoc(rRef,{ status:'approved' }); }
        else if(a==='reject'){ await updateDoc(rRef,{ status:'rejected' }); }
        else if(a==='remove'){
          if(confirm('Delete this registration?')) await deleteDoc(rRef);
        }
        await loadAdminRegs();
        await loadMyRegistrations();
      }, { once:true });
    }

    // ===== Small safety: close QR on ESC click =====
    window.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){ qrModal.classList.add('hidden'); }
    });
    qrModal.addEventListener('click', (e)=>{
      if(e.target === qrModal) qrModal.classList.add('hidden');
    });

  </script>
</body>
</html>

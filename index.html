<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Free Fire Tournament Manager</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #1f1c2c, #928dab);
    color: #eee;
    margin: 0; padding: 0;
    min-height: 100vh;
  }
  .container {
    max-width: 960px; margin: 20px auto;
    background: #1b2631;
    padding: 20px; border-radius: 12px;
    box-shadow: 0 0 30px #0a1f2e;
  }
  h1,h2,h3 {
    margin-top: 0;
    font-weight: 700;
    color: #f39c12;
  }
  label {
    display: block;
    margin-top: 12px;
    font-size: 0.9rem;
    color: #f5c26b;
  }
  input, select, button, textarea {
    width: 100%;
    margin-top: 6px;
    padding: 8px 10px;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
    font-family: 'Inter', sans-serif;
    background: #162029;
    color: #ddd;
  }
  button {
    background: #f39c12;
    color: #1b2631;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #d88e1a;
  }
  .flex {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
  }
  .flex > * {
    flex: 1;
    min-width: 180px;
  }
  .hidden {
    display: none;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    color: #eee;
  }
  th, td {
    border: 1px solid #333;
    padding: 8px;
    text-align: left;
  }
  th {
    background: #34495e;
    color: #f5c26b;
  }
  tr:nth-child(even) {
    background: #22313f;
  }
  .message {
    margin-top: 10px;
    padding: 10px;
    border-radius: 8px;
  }
  .success {
    background: #27ae60;
    color: white;
  }
  .error {
    background: #c0392b;
    color: white;
  }
  nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    color: #f39c12;
  }
  nav button {
    width: auto;
    padding: 8px 15px;
  }
  .gradient-btn {
    background: linear-gradient(45deg, #f39c12, #f1c40f);
    border: none;
    color: #1b2631;
    font-weight: 700;
  }
  .admin-badge {
    background: #e67e22;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 700;
  }
  a {
    color: #f39c12;
    text-decoration: underline;
    cursor: pointer;
  }
  .screenshot-preview {
    max-width: 120px;
    max-height: 90px;
    border-radius: 8px;
    margin-top: 6px;
    border: 1px solid #f39c12;
  }
  .utrsmall {
    font-size: 0.85rem;
    margin-top: 3px;
    color: #f5c26b;
  }
  #qrContainer img {
    display: block;
    margin: auto;
  }
  .contact-buttons {
    margin-top: 15px;
    display: flex;
    gap: 10px;
  }
  .contact-buttons a {
    background: #f39c12;
    color: #1b2631;
    padding: 10px 15px;
    border-radius: 8px;
    font-weight: 600;
    text-align: center;
    text-decoration: none;
  }
  .contact-buttons a:hover {
    background: #d88e1a;
  }
</style>
</head>
<body>

<div class="container">

  <nav>
    <div><h1>Free Fire Tournament Manager</h1></div>
    <div>
      <span id="userEmail" style="margin-right: 15px;"></span>
      <button id="logoutBtn" class="hidden">Logout</button>
    </div>
  </nav>

  <div id="authSection">
    <h2>Login / Signup</h2>
    <label for="emailInput">Email:</label>
    <input type="email" id="emailInput" placeholder="Enter your email" autocomplete="username"/>
    <label for="passwordInput">Password:</label>
    <input type="password" id="passwordInput" placeholder="Enter password" autocomplete="current-password"/>
    <button id="loginBtn">Login</button>
    <button id="signupBtn">Sign Up</button>
    <div id="authMessage"></div>
  </div>

  <div id="mainApp" class="hidden">

    <div class="flex" style="justify-content: space-between; align-items: center;">
      <h2>Tournaments</h2>
      <span id="adminBadge" class="admin-badge hidden">Admin</span>
    </div>

    <div id="adminControls" class="hidden" style="margin-bottom:20px; border: 1px solid #34495e; padding: 15px; border-radius: 8px;">
      <h3>Create / Edit Tournament</h3>
      <label for="tournamentNameInput">Tournament Name:</label>
      <input type="text" id="tournamentNameInput" placeholder="Enter tournament name" />
      
      <label for="tournamentDateInput">Date & Time:</label>
      <input type="datetime-local" id="tournamentDateInput" />

      <label for="modeSelect">Mode:</label>
      <select id="modeSelect">
        <option value="solo">Solo</option>
        <option value="duo">Duo</option>
        <option value="squad">Squad</option>
      </select>

      <label for="entryFeeInput">Entry Fee (₹):</label>
      <input type="number" id="entryFeeInput" placeholder="Enter entry fee" min="0" />

      <label for="slotLimitInput">Slot Limit (Total Players):</label>
      <input type="number" id="slotLimitInput" placeholder="Max total player slots" min="1" />

      <button id="saveTournamentBtn" class="gradient-btn" style="margin-top:10px;">Save Tournament</button>
      <button id="cancelEditTournamentBtn" style="margin-top:10px; background:#c0392b;">Cancel Edit</button>
      <div id="tournamentFormMessage"></div>
    </div>

    <label for="selectTournamentUser">Select Tournament to Register:</label>
    <select id="selectTournamentUser">
      <option value="">-- Select --</option>
    </select>
    <button id="registerBtn" disabled>Register</button>

    <div id="registrationModal" class="hidden" style="background:#162029; padding:15px; border-radius:8px; margin-top:20px;">
      <h3>Register for Tournament & Payment</h3>
      <div>
        <strong>Entry Fee:</strong> ₹<span id="entryFeeDisplay"></span><br/>
        <strong>Mode:</strong> <span id="modeDisplay"></span>
      </div>

      <div id="ffIdsContainer" style="margin-top: 15px;">
        <!-- FF ID inputs inserted dynamically -->
      </div>

      <label for="phoneInput">Phone Number (WhatsApp):</label>
      <input type="tel" id="phoneInput" placeholder="Enter your WhatsApp phone number" />

      <div style="margin-top: 15px;">
        <button id="payRedirectBtn" class="gradient-btn">Pay via UPI Link</button>
        <button id="showQrBtn" class="gradient-btn">Show UPI QR Code</button>
      </div>

      <div id="qrContainer" style="margin-top: 15px; display:none; text-align:center;">
        <img id="upiQrImage" alt="UPI QR Code" style="max-width: 220px; margin:auto;"/>
        <button id="hideQrBtn" style="margin-top:10px; background:#c0392b;">Hide QR</button>
      </div>

      <hr style="margin-top: 20px;"/>

      <label for="utrInput">Enter UTR Number after Payment:</label>
      <input type="text" id="utrInput" placeholder="Enter UTR Number" />
      <label for="screenshotInput">Upload Payment Screenshot:</label>
      <input type="file" id="screenshotInput" accept="image/*" />
      <img id="screenshotPreview" class="screenshot-preview hidden" alt="Screenshot preview" />
      <button id="submitRegistrationBtn" disabled>Submit Registration</button>
      <button id="cancelRegistrationBtn" style="background:#c0392b; margin-top:10px;">Cancel</button>
      <div id="registrationMessage"></div>
    </div>

    <div id="userRegistrationsSection" style="margin-top:30px;">
      <h3>Your Registrations</h3>
      <table id="userRegistrationsTable">
        <thead>
          <tr>
            <th>Tournament</th><th>Mode</th><th>FF IDs</th><th>Phone</th><th>Payment Status</th><th>UTR</th><th>Screenshot</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="adminRegistrationsSection" class="hidden" style="margin-top:30px;">
      <h3>All Registrations</h3>
      <table id="adminRegistrationsTable">
        <thead>
          <tr>
            <th>Tournament</th><th>User Email</th><th>Mode</th><th>FF IDs</th><th>Phone</th><th>Payment Status</th><th>UTR</th><th>Screenshot</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="contact-buttons">
      <a href="tel:+917976726014">Call Admin</a>
      <a href="https://wa.me/917976726014" target="_blank">WhatsApp Admin</a>
    </div>

  </div>

</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCAjiInmaJsHSqhlxZZ0heIdNEMu6m6Y6Y",
    authDomain: "freefire-tournament-2009.firebaseapp.com",
    projectId: "freefire-tournament-2009",
    storageBucket: "freefire-tournament-2009.appspot.com",
    messagingSenderId: "498357283098",
    appId: "1:498357283098:web:2f05123efe6c57e65524a3"
  };

  // Init Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // Elements
  const emailInput = document.getElementById("emailInput");
  const passwordInput = document.getElementById("passwordInput");
  const loginBtn = document.getElementById("loginBtn");
  const signupBtn = document.getElementById("signupBtn");
  const authMessage = document.getElementById("authMessage");
  const logoutBtn = document.getElementById("logoutBtn");
  const userEmailSpan = document.getElementById("userEmail");

  const authSection = document.getElementById("authSection");
  const mainApp = document.getElementById("mainApp");

  const adminBadge = document.getElementById("adminBadge");
  const adminControls = document.getElementById("adminControls");
  const tournamentNameInput = document.getElementById("tournamentNameInput");
  const tournamentDateInput = document.getElementById("tournamentDateInput");
  const modeSelect = document.getElementById("modeSelect");
  const entryFeeInput = document.getElementById("entryFeeInput");
  const slotLimitInput = document.getElementById("slotLimitInput");
  const saveTournamentBtn = document.getElementById("saveTournamentBtn");
  const cancelEditTournamentBtn = document.getElementById("cancelEditTournamentBtn");
  const tournamentFormMessage = document.getElementById("tournamentFormMessage");

  const selectTournamentUser = document.getElementById("selectTournamentUser");
  const registerBtn = document.getElementById("registerBtn");

  const registrationModal = document.getElementById("registrationModal");
  const entryFeeDisplay = document.getElementById("entryFeeDisplay");
  const modeDisplay = document.getElementById("modeDisplay");
  const ffIdsContainer = document.getElementById("ffIdsContainer");
  const phoneInput = document.getElementById("phoneInput");
  const payRedirectBtn = document.getElementById("payRedirectBtn");
  const showQrBtn = document.getElementById("showQrBtn");
  const qrContainer = document.getElementById("qrContainer");
  const upiQrImage = document.getElementById("upiQrImage");
  const hideQrBtn = document.getElementById("hideQrBtn");
  const utrInput = document.getElementById("utrInput");
  const screenshotInput = document.getElementById("screenshotInput");
  const screenshotPreview = document.getElementById("screenshotPreview");
  const submitRegistrationBtn = document.getElementById("submitRegistrationBtn");
  const cancelRegistrationBtn = document.getElementById("cancelRegistrationBtn");
  const registrationMessage = document.getElementById("registrationMessage");

  const userRegistrationsTableBody = document.querySelector("#userRegistrationsTable tbody");
  const adminRegistrationsSection = document.getElementById("adminRegistrationsSection");
  const adminRegistrationsTableBody = document.querySelector("#adminRegistrationsTable tbody");

  let currentUser = null;
  let isAdmin = false;

  let editTournamentId = null;
  let currentTournamentData = null;
  let currentTournamentId = null;

  // Admin credentials
  const ADMIN_EMAIL = "avinashnaruka89@gmail.com";
  const ADMIN_PASS = "031105";

  // UPI Payment info
  const phonePeUPI = "7976726014@axl";
  const googlePayUPI = "avinashnaruka89@okicici";

  // Fixed amount helper
  const upiAmountFixed = (amount) => amount.toFixed(2);

  // Generate UPI link (using PhonePe ID here)
  function generateUPILink(amount) {
    return `upi://pay?pa=${phonePeUPI}&pn=Avinash&am=${upiAmountFixed(amount)}&cu=INR`;
  }
  // Generate QR code URL (Google Charts API)
  function generateUPIQRCodeURL(amount) {
    const link = generateUPILink(amount);
    return `https://chart.googleapis.com/chart?cht=qr&chs=220x220&chl=${encodeURIComponent(link)}`;
  }

  // --- AUTH ---

  loginBtn.onclick = async () => {
    authMessage.textContent = "";
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) {
      authMessage.textContent = "Email and password required.";
      authMessage.className = "message error";
      return;
    }
    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch (e) {
      authMessage.textContent = e.message;
      authMessage.className = "message error";
    }
  };

  signupBtn.onclick = async () => {
    authMessage.textContent = "";
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) {
      authMessage.textContent = "Email and password required.";
      authMessage.className = "message error";
      return;
    }
    try {
      await auth.createUserWithEmailAndPassword(email, password);
      alert("Signup successful. You can now login.");
    } catch (e) {
      authMessage.textContent = e.message;
      authMessage.className = "message error";
    }
  };

  logoutBtn.onclick = () => {
    auth.signOut();
  };

  auth.onAuthStateChanged(async user => {
    currentUser = user;
    if (user) {
      authSection.classList.add("hidden");
      mainApp.classList.remove("hidden");
      userEmailSpan.textContent = user.email;
      logoutBtn.classList.remove("hidden");
      // Check admin
      isAdmin = (user.email === ADMIN_EMAIL);
      adminBadge.classList.toggle("hidden", !isAdmin);
      adminControls.classList.toggle("hidden", !isAdmin);
      adminRegistrationsSection.classList.toggle("hidden", !isAdmin);

      await loadTournaments();
      await loadUserRegistrations();
      if(isAdmin) await loadAllRegistrations();

    } else {
      authSection.classList.remove("hidden");
      mainApp.classList.add("hidden");
      userEmailSpan.textContent = "";
      logoutBtn.classList.add("hidden");
      adminBadge.classList.add("hidden");
      adminControls.classList.add("hidden");
      adminRegistrationsSection.classList.add("hidden");
    }
  });

  // --- TOURNAMENT CRUD ---

  async function loadTournaments() {
    selectTournamentUser.innerHTML = `<option value="">-- Select --</option>`;
    try {
      const snapshot = await db.collection("tournaments").orderBy("dateTime", "asc").get();
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        // Calculate slots filled to disable registration if full
        calculateSlotsFilled(docSnap.id).then(slotsFilled => {
          let disabled = false;
          if(data.mode === "solo") {
            if(slotsFilled >= data.slotLimit) disabled = true;
          } else if(data.mode === "duo") {
            if(slotsFilled >= data.slotLimit) disabled = true;
          } else if(data.mode === "squad") {
            if(slotsFilled >= data.slotLimit) disabled = true;
          }
          const option = document.createElement("option");
          option.value = docSnap.id;
          option.textContent = `${data.name} (${data.mode.toUpperCase()}) - ₹${data.entryFee} - ${new Date(data.dateTime).toLocaleString()}${disabled ? " [FULL]" : ""}`;
          option.disabled = disabled;
          selectTournamentUser.appendChild(option);
        });
      });
    } catch (e) {
      console.error("Error loading tournaments:", e);
    }
  }

  // Calculate total slots filled for tournament
  async function calculateSlotsFilled(tournamentId) {
    const registrationsSnap = await db.collection("registrations")
      .where("tournamentId", "==", tournamentId)
      .get();
    let slots = 0;
    registrationsSnap.forEach(doc => {
      const reg = doc.data();
      if(reg.mode === "solo") slots += 1;
      else if(reg.mode === "duo") slots += 2;
      else if(reg.mode === "squad") slots += 4;
    });
    return slots;
  }

  saveTournamentBtn.onclick = async () => {
    tournamentFormMessage.textContent = "";
    const name = tournamentNameInput.value.trim();
    const dateTime = tournamentDateInput.value;
    const mode = modeSelect.value;
    const entryFee = parseFloat(entryFeeInput.value);
    const slotLimit = parseInt(slotLimitInput.value);

    if(!name || !dateTime || !mode || isNaN(entryFee) || isNaN(slotLimit) || slotLimit < 1) {
      tournamentFormMessage.textContent = "Please fill all fields correctly.";
      tournamentFormMessage.className = "message error";
      return;
    }

    try {
      if(editTournamentId){
        await db.collection("tournaments").doc(editTournamentId).update({
          name, dateTime, mode, entryFee, slotLimit
        });
        editTournamentId = null;
      } else {
        await db.collection("tournaments").add({
          name, dateTime, mode, entryFee, slotLimit
        });
      }
      tournamentFormMessage.textContent = "Tournament saved successfully.";
      tournamentFormMessage.className = "message success";
      tournamentNameInput.value = "";
      tournamentDateInput.value = "";
      entryFeeInput.value = "";
      slotLimitInput.value = "";
      modeSelect.value = "solo";
      await loadTournaments();
    } catch (e) {
      tournamentFormMessage.textContent = e.message;
      tournamentFormMessage.className = "message error";
    }
  };

  cancelEditTournamentBtn.onclick = () => {
    editTournamentId = null;
    tournamentFormMessage.textContent = "";
    tournamentNameInput.value = "";
    tournamentDateInput.value = "";
    entryFeeInput.value = "";
    slotLimitInput.value = "";
    modeSelect.value = "solo";
  };

  // --- USER REGISTRATION MODAL LOGIC ---

  let registrationTournament = null;

  selectTournamentUser.onchange = async () => {
    const tid = selectTournamentUser.value;
    registerBtn.disabled = !tid;
    if(!tid) return;
    try {
      const docSnap = await db.collection("tournaments").doc(tid).get();
      if(docSnap.exists){
        registrationTournament = docSnap.data();
        registrationTournament.id = tid;
      } else {
        registrationTournament = null;
      }
    } catch (e) {
      console.error("Error fetching tournament data", e);
      registrationTournament = null;
    }
  };

  registerBtn.onclick = () => {
    if(!registrationTournament) {
      alert("Select a tournament first.");
      return;
    }

    registrationMessage.textContent = "";
    utrInput.value = "";
    screenshotInput.value = "";
    screenshotPreview.src = "";
    screenshotPreview.classList.add("hidden");
    phoneInput.value = "";

    entryFeeDisplay.textContent = registrationTournament.entryFee;
    modeDisplay.textContent = registrationTournament.mode;

    ffIdsContainer.innerHTML = "";
    let ffCount = 1;
    if(registrationTournament.mode === "duo") ffCount = 2;
    else if(registrationTournament.mode === "squad") ffCount = 4;

    for(let i=1; i<=ffCount; i++){
      const label = document.createElement("label");
      label.textContent = `Free Fire ID ${i}:`;
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = `Enter Free Fire ID ${i}`;
      input.id = `ffIdInput${i}`;
      input.required = true;
      ffIdsContainer.appendChild(label);
      ffIdsContainer.appendChild(input);
    }

    qrContainer.style.display = "none";
    submitRegistrationBtn.disabled = true;

    registrationModal.classList.remove("hidden");
  };

  utrInput.oninput = screenshotInput.onchange = () => {
    submitRegistrationBtn.disabled = !(utrInput.value.trim() && screenshotInput.files.length > 0);
    if(screenshotInput.files.length > 0){
      const file = screenshotInput.files[0];
      const reader = new FileReader();
      reader.onload = e => {
        screenshotPreview.src = e.target.result;
        screenshotPreview.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    } else {
      screenshotPreview.src = "";
      screenshotPreview.classList.add("hidden");
    }
  };

  payRedirectBtn.onclick = () => {
    if(!registrationTournament) return;
    const upiLink = generateUPILink(registrationTournament.entryFee);
    window.open(upiLink, "_blank");
    alert("Complete payment, then enter UTR number and upload screenshot.");
  };

  showQrBtn.onclick = () => {
    if(!registrationTournament) return;
    const qrUrl = generateUPIQRCodeURL(registrationTournament.entryFee);
    upiQrImage.src = qrUrl;
    qrContainer.style.display = "block";
  };

  hideQrBtn.onclick = () => {
    qrContainer.style.display = "none";
  };

  cancelRegistrationBtn.onclick = () => {
    registrationModal.classList.add("hidden");
  };

  submitRegistrationBtn.onclick = async () => {
    registrationMessage.textContent = "";

    if(!registrationTournament){
      registrationMessage.textContent = "Tournament data missing.";
      registrationMessage.className = "message error";
      return;
    }

    // Collect FF IDs
    let ffIds = [];
    const ffCount = (registrationTournament.mode === "duo") ? 2 : (registrationTournament.mode === "squad") ? 4 : 1;
    for(let i=1; i<=ffCount; i++){
      const val = document.getElementById(`ffIdInput${i}`).value.trim();
      if(!val){
        registrationMessage.textContent = `Please enter Free Fire ID ${i}.`;
        registrationMessage.className = "message error";
        return;
      }
      ffIds.push(val);
    }

    // Validate phone
    const phone = phoneInput.value.trim();
    if(!/^\d{10}$/.test(phone)){
      registrationMessage.textContent = "Phone number must be 10 digits.";
      registrationMessage.className = "message error";
      return;
    }

    const utr = utrInput.value.trim();
    if(!utr){
      registrationMessage.textContent = "Please enter UTR number.";
      registrationMessage.className = "message error";
      return;
    }

    if(screenshotInput.files.length === 0){
      registrationMessage.textContent = "Please upload payment screenshot.";
      registrationMessage.className = "message error";
      return;
    }
    const file = screenshotInput.files[0];

    // Upload screenshot & add registration
    registrationMessage.textContent = "Uploading payment screenshot...";

    try {
      const storageRef = storage.ref(`screenshots/${currentUser.uid}/${Date.now()}_${file.name}`);
      const uploadResult = await storageRef.put(file);
      const screenshotUrl = await uploadResult.ref.getDownloadURL();

      // Check slot availability
      const slotsFilled = await calculateSlotsFilled(registrationTournament.id);
      const maxSlots = registrationTournament.slotLimit;
      let requiredSlots = (registrationTournament.mode === "solo") ? 1 : (registrationTournament.mode === "duo") ? 2 : 4;

      if(slotsFilled + requiredSlots > maxSlots) {
        registrationMessage.textContent = "Sorry, slots are full.";
        registrationMessage.className = "message error";
        return;
      }

      await db.collection("registrations").add({
        tournamentId: registrationTournament.id,
        userId: currentUser.uid,
        userEmail: currentUser.email,
        ffIds,
        phone,
        utr,
        screenshotUrl,
        mode: registrationTournament.mode,
        entryFee: registrationTournament.entryFee,
        paymentStatus: "Pending",
        createdAt: new Date().toISOString()
      });

      registrationMessage.textContent = "Registration successful!";
      registrationMessage.className = "message success";
      registrationModal.classList.add("hidden");
      await loadUserRegistrations();
      await loadTournaments();

    } catch (e) {
      registrationMessage.textContent = "Error: " + e.message;
      registrationMessage.className = "message error";
    }
  };

  // --- LOAD USER REGISTRATIONS ---

  async function loadUserRegistrations() {
    if(!currentUser) return;
    userRegistrationsTableBody.innerHTML = "";
    try {
      const snap = await db.collection("registrations")
        .where("userId", "==", currentUser.uid)
        .orderBy("createdAt", "desc")
        .get();
      if(snap.empty){
        userRegistrationsTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No registrations found</td></tr>`;
        return;
      }
      snap.forEach(docSnap => {
        const reg = docSnap.data();
        const ffList = reg.ffIds.join(", ");
        userRegistrationsTableBody.innerHTML += `
          <tr>
            <td>${getTournamentName(reg.tournamentId)}</td>
            <td>${reg.mode.toUpperCase()}</td>
            <td>${ffList}</td>
            <td>${reg.phone}</td>
            <td>${reg.paymentStatus}</td>
            <td>${reg.utr}</td>
            <td>${reg.screenshotUrl ? `<a href="${reg.screenshotUrl}" target="_blank">View</a>` : "No"}</td>
          </tr>
        `;
      });
    } catch(e) {
      userRegistrationsTableBody.innerHTML = `<tr><td colspan="7" style="color:#c0392b;">Error loading registrations</td></tr>`;
    }
  }

  // Cache tournaments by ID to show name
  let tournamentCache = {};

  async function loadTournamentsCache() {
    tournamentCache = {};
    const snap = await db.collection("tournaments").get();
    snap.forEach(doc => {
      tournamentCache[doc.id] = doc.data();
    });
  }

  function getTournamentName(tId) {
    return tournamentCache[tId]?.name || tId;
  }

  // --- LOAD ADMIN REGISTRATIONS ---

  async function loadAllRegistrations() {
    if(!isAdmin) return;
    adminRegistrationsTableBody.innerHTML = "";
    await loadTournamentsCache();
    try {
      const snap = await db.collection("registrations")
        .orderBy("createdAt", "desc")
        .get();
      if(snap.empty){
        adminRegistrationsTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No registrations found</td></tr>`;
        return;
      }
      snap.forEach(docSnap => {
        const reg = docSnap.data();
        const ffList = reg.ffIds.join(", ");
        adminRegistrationsTableBody.innerHTML += `
          <tr>
            <td>${getTournamentName(reg.tournamentId)}</td>
            <td>${reg.userEmail}</td>
            <td>${reg.mode.toUpperCase()}</td>
            <td>${ffList}</td>
            <td>${reg.phone}</td>
            <td>${reg.paymentStatus}</td>
            <td>${reg.utr}</td>
            <td>${reg.screenshotUrl ? `<a href="${reg.screenshotUrl}" target="_blank">View</a>` : "No"}</td>
          </tr>
        `;
      });
    } catch(e){
      adminRegistrationsTableBody.innerHTML = `<tr><td colspan="8" style="color:#c0392b;">Error loading registrations</td></tr>`;
    }
  }

  // --- TOURNAMENT EDIT & DELETE (ADMIN) ---

  // For simplicity, list tournaments below admin controls with edit/delete buttons

  async function reloadTournamentListForAdmin() {
    if(!isAdmin) return;
    let listHtml = "<h3>Manage Tournaments</h3><table><thead><tr><th>Name</th><th>Date</th><th>Mode</th><th>Fee</th><th>Slots</th><th>Actions</th></tr></thead><tbody>";
    try {
      const snap = await db.collection("tournaments").orderBy("dateTime", "asc").get();
      snap.forEach(doc => {
        const d = doc.data();
        listHtml += `<tr>
          <td>${d.name}</td>
          <td>${new Date(d.dateTime).toLocaleString()}</td>
          <td>${d.mode.toUpperCase()}</td>
          <td>₹${d.entryFee}</td>
          <td>${d.slotLimit}</td>
          <td>
            <button onclick="editTournament('${doc.id}')">Edit</button>
            <button onclick="deleteTournament('${doc.id}')">Delete</button>
          </td>
        </tr>`;
      });
      listHtml += "</tbody></table>";
      adminControls.innerHTML += listHtml;
    } catch (e) {
      adminControls.innerHTML += `<p style="color:#c0392b;">Error loading tournaments for admin</p>`;
    }
  }

  window.editTournament = async (id) => {
    if(!isAdmin) return alert("Admin only.");
    editTournamentId = id;
    try {
      const docSnap = await db.collection("tournaments").doc(id).get();
      if(!docSnap.exists) return alert("Tournament not found.");
      const data = docSnap.data();
      tournamentNameInput.value = data.name;
      tournamentDateInput.value = data.dateTime;
      modeSelect.value = data.mode;
      entryFeeInput.value = data.entryFee;
      slotLimitInput.value = data.slotLimit;
      tournamentFormMessage.textContent = "Editing tournament...";
      tournamentFormMessage.className = "";
      window.scrollTo(0,0);
    } catch (e) {
      alert("Error loading tournament: " + e.message);
    }
  };

  window.deleteTournament = async (id) => {
    if(!isAdmin) return alert("Admin only.");
    if(!confirm("Are you sure you want to delete this tournament? This will remove all its registrations too.")) return;
    try {
      // Delete registrations of this tournament first
      const regsSnap = await db.collection("registrations").where("tournamentId","==",id).get();
      const batch = db.batch();
      regsSnap.forEach(doc => batch.delete(doc.ref));
      batch.delete(db.collection("tournaments").doc(id));
      await batch.commit();
      alert("Tournament and its registrations deleted.");
      await loadTournaments();
      await reloadTournamentListForAdmin();
      await loadAllRegistrations();
    } catch (e) {
      alert("Error deleting tournament: " + e.message);
    }
  };

  // Init
  (async () => {
    await loadTournaments();
    await loadTournamentsCache();
    if(isAdmin) {
      reloadTournamentListForAdmin();
    }
  })();

</script>

</body>
</html>

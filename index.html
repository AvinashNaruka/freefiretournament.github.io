<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Free Fire Tournament Manager</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');
  body {
    margin: 0; font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #1f4037, #99f2c8);
    color: #eee;
  }
  .container {
    max-width: 960px; margin: 20px auto; background: #1b2631;
    padding: 20px; border-radius: 12px; box-shadow: 0 0 20px #0a1f2e;
  }
  h1,h2,h3 {
    margin-top: 0; font-weight: 700; color: #f39c12;
  }
  label {
    display: block; margin-top: 12px; font-size: 0.9rem; color: #f5c26b;
  }
  input, select, button, textarea {
    width: 100%; margin-top: 6px; padding: 8px 10px; border-radius: 8px;
    border: none; font-size: 1rem; font-family: 'Inter', sans-serif;
  }
  input, select, textarea {
    background: #162029; color: #ddd;
  }
  button {
    background: #f39c12; color: #1b2631; cursor: pointer;
    font-weight: 600; transition: background 0.3s ease;
  }
  button:hover {
    background: #d88e1a;
  }
  .flex {
    display: flex; gap: 15px; flex-wrap: wrap; align-items: center;
  }
  .flex > * {
    flex: 1;
    min-width: 180px;
  }
  .hidden {
    display: none;
  }
  table {
    width: 100%; border-collapse: collapse; margin-top: 20px;
  }
  th, td {
    border: 1px solid #333; padding: 8px; text-align: left;
  }
  th {
    background: #34495e; color: #f5c26b;
  }
  tr:nth-child(even) {
    background: #22313f;
  }
  .message {
    margin-top: 10px; padding: 10px; border-radius: 8px;
  }
  .success {
    background: #27ae60;
    color: white;
  }
  .error {
    background: #c0392b;
    color: white;
  }
  nav {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px; color: #f39c12;
  }
  nav button {
    width: auto; padding: 8px 15px;
  }
  .gradient-btn {
    background: linear-gradient(45deg, #f39c12, #f1c40f);
    border: none; color: #1b2631; font-weight: 700;
  }
  .admin-badge {
    background: #e67e22; padding: 4px 12px; border-radius: 20px;
    font-weight: 700;
  }
  a {
    color: #f39c12; text-decoration: underline;
    cursor: pointer;
  }
  .screenshot-preview {
    max-width: 120px; max-height: 90px; border-radius: 8px; margin-top: 6px;
    border: 1px solid #f39c12;
  }
  .utrsmall {
    font-size: 0.85rem; margin-top: 3px; color: #f5c26b;
  }
  .contact-buttons {
    margin-top: 20px;
    display: flex; gap: 10px;
  }
  .contact-buttons button {
    flex: 1;
  }
</style>
</head>
<body>

<div class="container">

  <nav>
    <div><h1>Free Fire Tournament Manager</h1></div>
    <div>
      <span id="userEmail" style="margin-right: 15px;"></span>
      <button id="logoutBtn" class="hidden">Logout</button>
    </div>
  </nav>

  <!-- Authentication Section -->
  <div id="authSection">
    <h2>Login / Signup</h2>
    <label for="emailInput">Email:</label>
    <input type="email" id="emailInput" placeholder="Enter your email" autocomplete="username" />
    <label for="passwordInput">Password:</label>
    <input type="password" id="passwordInput" placeholder="Enter password" autocomplete="current-password" />
    <button id="loginBtn">Login</button>
    <button id="signupBtn">Sign Up</button>
    <div id="authMessage"></div>
  </div>

  <!-- Main App Section -->
  <div id="mainApp" class="hidden">

    <!-- Admin Badge -->
    <div class="flex" style="justify-content: space-between; align-items: center;">
      <h2>Tournaments</h2>
      <span id="adminBadge" class="admin-badge hidden">Admin</span>
    </div>

    <!-- Tournament List for Users -->
    <div id="userSection">
      <h3>Available Tournaments</h3>
      <select id="selectTournamentUser">
        <option value="">--Select Tournament--</option>
      </select>
      <button id="registerBtn" disabled>Register</button>

      <h3>Your Registrations</h3>
      <table id="userRegistrationsTable">
        <thead>
          <tr>
            <th>Tournament</th><th>Mode</th><th>Entry Fee</th><th>Payment Status</th><th>Free Fire ID</th><th>Phone</th><th>UTR</th><th>Screenshot</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="hidden" style="background:#162029; padding:15px; border-radius:8px; margin-top:20px;">
      <h3>Register for Tournament</h3>
      <label for="ffIdInput">Free Fire ID:</label>
      <input type="text" id="ffIdInput" placeholder="Enter your Free Fire ID" />
      <label for="phoneInput">Phone Number (WhatsApp):</label>
      <input type="tel" id="phoneInput" placeholder="Enter your WhatsApp phone number" />
      <label for="utrInput">UTR Number:</label>
      <input type="text" id="utrInput" placeholder="Enter UTR Number" />
      <label for="screenshotInput">Upload Payment Screenshot:</label>
      <input type="file" id="screenshotInput" accept="image/*" />
      <img id="screenshotPreview" class="screenshot-preview hidden" alt="Screenshot preview" />
      <button id="submitRegistrationBtn">Submit Registration</button>
      <button id="cancelRegistrationBtn" style="background:#c0392b; margin-top:10px;">Cancel</button>
      <div id="registrationMessage"></div>
    </div>

    <!-- Admin Section -->
    <div id="adminSection" class="hidden" style="margin-top:30px;">
      <h3>Create / Edit Tournament</h3>
      <label for="tournNameInput">Name:</label>
      <input type="text" id="tournNameInput" placeholder="Tournament name" />
      <label for="tournDateInput">Date:</label>
      <input type="date" id="tournDateInput" />
      <label for="tournTimeInput">Time:</label>
      <input type="time" id="tournTimeInput" />
      <label for="tournModeSelect">Mode:</label>
      <select id="tournModeSelect">
        <option value="solo">Solo</option>
        <option value="duo">Duo</option>
        <option value="squad">Squad</option>
      </select>
      <label for="tournEntryFeeInput">Entry Fee (â‚¹):</label>
      <input type="number" id="tournEntryFeeInput" placeholder="Entry Fee in INR" min="0" />
      <label for="tournSlotLimitInput">Slot Limit:</label>
      <input type="number" id="tournSlotLimitInput" placeholder="Max slots (e.g., 48 for squads)" min="1" />
      <button id="createTournBtn" class="gradient-btn">Create Tournament</button>
      <div id="createTournMsg"></div>

      <h3 style="margin-top:30px;">All Tournaments</h3>
      <table id="adminTournTable">
        <thead>
          <tr>
            <th>Name</th><th>Date & Time</th><th>Mode</th><th>Entry Fee</th><th>Slot Limit</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h3 style="margin-top:30px;">Tournament Registrations</h3>
      <label for="selectTournamentReg">Select Tournament:</label>
      <select id="selectTournamentReg">
        <option value="">--Select Tournament--</option>
      </select>
      <table id="adminRegistrationsTable">
        <thead>
          <tr>
            <th>Free Fire ID</th><th>Phone</th><th>UTR</th><th>Screenshot</th><th>Payment Status</th><th>WhatsApp</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="contact-buttons">
      <button onclick="window.open('tel:7976726014')">Call Admin</button>
      <button onclick="window.open('https://wa.me/917976726014')">WhatsApp Admin</button>
    </div>
  </div>

</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, query, where, onSnapshot, orderBy
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import {
    getStorage, ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCAjiInmaJsHSqhlxZZ0heIdNEMu6m6Y6Y",
    authDomain: "freefire-tournament-2009.firebaseapp.com",
    projectId: "freefire-tournament-2009",
    storageBucket: "freefire-tournament-2009.appspot.com",
    messagingSenderId: "498357283098",
    appId: "1:498357283098:web:2f05123efe6c57e65524a3"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Admin credentials (email + password)
  const adminEmail = "avinashnaruka89@gmail.com";

  // Elements
  const authSection = document.getElementById("authSection");
  const emailInput = document.getElementById("emailInput");
  const passwordInput = document.getElementById("passwordInput");
  const loginBtn = document.getElementById("loginBtn");
  const signupBtn = document.getElementById("signupBtn");
  const authMessage = document.getElementById("authMessage");

  const mainApp = document.getElementById("mainApp");
  const userEmailSpan = document.getElementById("userEmail");
  const logoutBtn = document.getElementById("logoutBtn");
  const adminBadge = document.getElementById("adminBadge");

  // Admin Controls
  const adminSection = document.getElementById("adminSection");
  const tournNameInput = document.getElementById("tournNameInput");
  const tournDateInput = document.getElementById("tournDateInput");
  const tournTimeInput = document.getElementById("tournTimeInput");
  const tournModeSelect = document.getElementById("tournModeSelect");
  const tournEntryFeeInput = document.getElementById("tournEntryFeeInput");
  const tournSlotLimitInput = document.getElementById("tournSlotLimitInput");
  const createTournBtn = document.getElementById("createTournBtn");
  const createTournMsg = document.getElementById("createTournMsg");
  const adminTournTableBody = document.querySelector("#adminTournTable tbody");
  const selectTournamentReg = document.getElementById("selectTournamentReg");
  const adminRegistrationsTableBody = document.querySelector("#adminRegistrationsTable tbody");

  // User Controls
  const userSection = document.getElementById("userSection");
  const selectTournamentUser = document.getElementById("selectTournamentUser");
  const registerBtn = document.getElementById("registerBtn");
  const userRegistrationsTableBody = document.querySelector("#userRegistrationsTable tbody");

  // Registration modal
  const registrationModal = document.getElementById("registrationModal");
  const ffIdInput = document.getElementById("ffIdInput");
  const phoneInput = document.getElementById("phoneInput");
  const utrInput = document.getElementById("utrInput");
  const screenshotInput = document.getElementById("screenshotInput");
  const screenshotPreview = document.getElementById("screenshotPreview");
  const submitRegistrationBtn = document.getElementById("submitRegistrationBtn");
  const cancelRegistrationBtn = document.getElementById("cancelRegistrationBtn");
  const registrationMessage = document.getElementById("registrationMessage");

  // Helper - format Date & Time nicely
  function formatDateTime(isoString){
    if(!isoString) return "";
    const dt = new Date(isoString);
    return dt.toLocaleDateString() + " " + dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  }

  // Show/hide parts depending on role
  let currentUser = null;
  let isAdmin = false;

  // Login logic
  loginBtn.onclick = () => {
    authMessage.textContent = "";
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if(!email || !password){
      authMessage.textContent = "Please enter email and password.";
      authMessage.className = "message error";
      return;
    }
    signInWithEmailAndPassword(auth, email, password)
      .then(() => {
        // Success handled by onAuthStateChanged
      })
      .catch(e => {
        authMessage.textContent = "Login failed: "+e.message;
        authMessage.className = "message error";
      });
  };

  // Signup logic
  signupBtn.onclick = () => {
    authMessage.textContent = "";
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if(!email || !password){
      authMessage.textContent = "Please enter email and password.";
      authMessage.className = "message error";
      return;
    }
    createUserWithEmailAndPassword(auth, email, password)
      .then(() => {
        authMessage.textContent = "Account created. Please login.";
        authMessage.className = "message success";
      })
      .catch(e => {
        authMessage.textContent = "Signup failed: "+e.message;
        authMessage.className = "message error";
      });
  };

  // Logout
  logoutBtn.onclick = () => {
    signOut(auth);
  };

  // On auth state change
  onAuthStateChanged(auth, user => {
    if(user){
      currentUser = user;
      isAdmin = (user.email === adminEmail);
      authSection.classList.add("hidden");
      mainApp.classList.remove("hidden");
      logoutBtn.classList.remove("hidden");
      userEmailSpan.textContent = user.email;
      adminBadge.classList.toggle("hidden", !isAdmin);
      adminSection.classList.toggle("hidden", !isAdmin);
      userSection.classList.toggle("hidden", isAdmin);

      // Load data
      loadTournamentsForUser();
      loadUserRegistrations();
      if(isAdmin){
        loadAdminTournaments();
        loadTournamentsForAdminSelect();
      }
    } else {
      currentUser = null;
      isAdmin = false;
      authSection.classList.remove("hidden");
      mainApp.classList.add("hidden");
      logoutBtn.classList.add("hidden");
      userEmailSpan.textContent = "";
      adminBadge.classList.add("hidden");
      adminSection.classList.add("hidden");
      userSection.classList.remove("hidden");
      clearCreateTournamentForm();
    }
  });

  // Load tournaments dropdown for users
  async function loadTournamentsForUser(){
    selectTournamentUser.innerHTML = `<option value="">--Select Tournament--</option>`;
    const tournSnap = await getDocs(collection(db, "tournaments"));
    for(const docSnap of tournSnap.docs){
      const t = docSnap.data();
      const slotsTaken = await getSlotsTaken(docSnap.id);
      const slotsLeft = t.slotLimit - slotsTaken;
      const closed = slotsLeft <= 0;
      const option = document.createElement("option");
      option.value = docSnap.id;
      option.textContent = `${t.name} (${formatDateTime(t.dateTime)}) - â‚¹${t.entryFee} - ${t.mode} - Slots left: ${slotsLeft}`;
      option.disabled = closed;
      selectTournamentUser.appendChild(option);
    }
    registerBtn.disabled = true;
  }

  // Load tournaments dropdown for admin registrations filter
  async function loadTournamentsForAdminSelect(){
    selectTournamentReg.innerHTML = `<option value="">--Select Tournament--</option>`;
    const tournSnap = await getDocs(collection(db, "tournaments"));
    for(const docSnap of tournSnap.docs){
      const t = docSnap.data();
      const option = document.createElement("option");
      option.value = docSnap.id;
      option.textContent = `${t.name} (${formatDateTime(t.dateTime)})`;
      selectTournamentReg.appendChild(option);
    }
  }

  // Get total slots taken in a tournament (based on mode)
  async function getSlotsTaken(tournId){
    const regSnap = await getDocs(query(collection(db,"registrations"), where("tournamentId","==",tournId)));
    if(regSnap.empty) return 0;
    let count = 0;
    for(const regDoc of regSnap.docs){
      const reg = regDoc.data();
      if(reg.mode==="solo") count += 1;
      else if(reg.mode==="duo") count += 2;
      else if(reg.mode==="squad") count += 4;
    }
    return count;
  }

  // Enable register button only when tournament selected
  selectTournamentUser.onchange = () => {
    registerBtn.disabled = selectTournamentUser.value === "";
  };

  // Show registration modal
  registerBtn.onclick = () => {
    registrationMessage.textContent = "";
    ffIdInput.value = "";
    phoneInput.value = "";
    utrInput.value = "";
    screenshotInput.value = "";
    screenshotPreview.src = "";
    screenshotPreview.classList.add("hidden");
    registrationModal.classList.remove("hidden");
  };

  // Preview screenshot
  screenshotInput.onchange = () => {
    const file = screenshotInput.files[0];
    if(!file) {
      screenshotPreview.src = "";
      screenshotPreview.classList.add("hidden");
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      screenshotPreview.src = e.target.result;
      screenshotPreview.classList.remove("hidden");
    };
    reader.readAsDataURL(file);
  };

  // Submit registration
  submitRegistrationBtn.onclick = async () => {
    registrationMessage.textContent = "";
    const tournamentId = selectTournamentUser.value;
    const ffId = ffIdInput.value.trim();
    const phone = phoneInput.value.trim();
    const utr = utrInput.value.trim();
    const file = screenshotInput.files[0];

    if(!tournamentId || !ffId || !phone || !utr || !file){
      registrationMessage.textContent = "All fields including screenshot upload are mandatory.";
      registrationMessage.className = "message error";
      return;
    }
    if(!/^\d{10}$/.test(phone)){
      registrationMessage.textContent = "Phone number must be 10 digits.";
      registrationMessage.className = "message error";
      return;
    }

    // Check slots available again before upload
    const tournDoc = await getDoc(doc(db,"tournaments",tournamentId));
    if(!tournDoc.exists()){
      registrationMessage.textContent = "Tournament not found.";
      registrationMessage.className = "message error";
      return;
    }
    const tournData = tournDoc.data();
    const slotsTaken = await getSlotsTaken(tournamentId);
    let slotsRequired = 1;
    if(tournData.mode==="duo") slotsRequired = 2;
    else if(tournData.mode==="squad") slotsRequired = 4;
    if(slotsTaken + slotsRequired > tournData.slotLimit){
      registrationMessage.textContent = "Slots full, registration closed.";
      registrationMessage.className = "message error";
      return;
    }

    // Upload screenshot to Firebase Storage
    registrationMessage.textContent = "Uploading screenshot...";
    const storageRef = ref(storage, `screenshots/${currentUser.uid}/${Date.now()}_${file.name}`);
    try {
      const uploadResult = await uploadBytes(storageRef, file);
      const downloadURL = await getDownloadURL(uploadResult.ref);

      // Add registration doc
      await addDoc(collection(db, "registrations"), {
        tournamentId,
        userId: currentUser.uid,
        userEmail: currentUser.email,
        ffId,
        phone,
        utr,
        screenshotUrl: downloadURL,
        mode: tournData.mode,
        entryFee: tournData.entryFee,
        paymentStatus: "Pending",
        createdAt: new Date().toISOString()
      });

      registrationMessage.textContent = "Registration submitted successfully!";
      registrationMessage.className = "message success";
      registrationModal.classList.add("hidden");
      await loadUserRegistrations();
      await loadTournamentsForUser();
    } catch(e){
      registrationMessage.textContent = "Error uploading screenshot: " + e.message;
      registrationMessage.className = "message error";
    }
  };

  cancelRegistrationBtn.onclick = () => {
    registrationModal.classList.add("hidden");
  };

  // Load user registrations
  async function loadUserRegistrations(){
    userRegistrationsTableBody.innerHTML = "";
    const regSnap = await getDocs(query(collection(db,"registrations"), where("userId","==",currentUser.uid)));
    if(regSnap.empty){
      userRegistrationsTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No registrations found.</td></tr>`;
      return;
    }
    for(const regDoc of regSnap.docs){
      const r = regDoc.data();
      const tournDoc = await getDoc(doc(db,"tournaments",r.tournamentId));
      const tournName = tournDoc.exists() ? tournDoc.data().name : "Deleted";
      const paymentCls = r.paymentStatus==="Approved" ? "success" : (r.paymentStatus==="Rejected" ? "error" : "");
      const paymentText = r.paymentStatus;
      userRegistrationsTableBody.innerHTML += `
      <tr>
        <td>${tournName}</td>
        <td>${r.mode}</td>
        <td>â‚¹${r.entryFee}</td>
        <td class="${paymentCls}">${paymentText}</td>
        <td>${r.ffId}</td>
        <td>${r.phone}</td>
        <td>${r.utr}</td>
        <td><a href="${r.screenshotUrl}" target="_blank">View</a></td>
      </tr>`;
    }
  }

  // Load admin tournaments list
  async function loadAdminTournaments(){
    adminTournTableBody.innerHTML = "";
    const tournSnap = await getDocs(collection(db,"tournaments"));
    if(tournSnap.empty){
      adminTournTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No tournaments created yet.</td></tr>`;
      return;
    }
    for(const docSnap of tournSnap.docs){
      const t = docSnap.data();
      const id = docSnap.id;
      adminTournTableBody.innerHTML += `
      <tr>
        <td>${t.name}</td>
        <td>${formatDateTime(t.dateTime)}</td>
        <td>${t.mode}</td>
        <td>â‚¹${t.entryFee}</td>
        <td>${t.slotLimit}</td>
        <td>
          <button data-id="${id}" class="editTournBtn">Edit</button>
          <button data-id="${id}" class="deleteTournBtn">Delete</button>
        </td>
      </tr>`;
    }
    // Add edit button events
    document.querySelectorAll(".editTournBtn").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.dataset.id;
        const docSnap = await getDoc(doc(db,"tournaments",id));
        if(!docSnap.exists()){
          alert("Tournament not found");
          return;
        }
        const t = docSnap.data();
        tournNameInput.value = t.name;
        if(t.dateTime){
          const dt = new Date(t.dateTime);
          tournDateInput.value = dt.toISOString().slice(0,10);
          tournTimeInput.value = dt.toTimeString().slice(0,5);
        } else {
          tournDateInput.value = "";
          tournTimeInput.value = "";
        }
        tournModeSelect.value = t.mode;
        tournEntryFeeInput.value = t.entryFee;
        tournSlotLimitInput.value = t.slotLimit;
        createTournBtn.textContent = "Update Tournament";
        createTournMsg.textContent = "";
        createTournBtn.dataset.editingId = id;
        window.scrollTo({top:0, behavior:"smooth"});
      };
    });
    // Delete buttons events
    document.querySelectorAll(".deleteTournBtn").forEach(btn => {
      btn.onclick = async () => {
        if(!confirm("Are you sure you want to delete this tournament? This will also delete all registrations.")) return;
        const id = btn.dataset.id;
        try {
          // Delete all registrations for this tournament first
          const regSnap = await getDocs(query(collection(db,"registrations"), where("tournamentId","==",id)));
          for(const regDoc of regSnap.docs){
            await deleteDoc(doc(db,"registrations",regDoc.id));
          }
          await deleteDoc(doc(db,"tournaments",id));
          createTournMsg.textContent = "Tournament deleted successfully.";
          createTournMsg.className = "message success";
          clearCreateTournamentForm();
          await loadAdminTournaments();
          await loadTournamentsForAdminSelect();
          await loadTournamentsForUser();
          await loadUserRegistrations();
        } catch(e){
          createTournMsg.textContent = "Error deleting tournament: "+e.message;
          createTournMsg.className = "message error";
        }
      };
    });
  }

  // Create or update tournament
  createTournBtn.onclick = async () => {
    createTournMsg.textContent = "";
    const name = tournNameInput.value.trim();
    const date = tournDateInput.value;
    const time = tournTimeInput.value;
    const mode = tournModeSelect.value;
    const entryFee = parseFloat(tournEntryFeeInput.value);
    const slotLimit = parseInt(tournSlotLimitInput.value);

    if(!name || !date || !time || !mode || isNaN(entryFee) || isNaN(slotLimit) || slotLimit <= 0){
      createTournMsg.textContent = "Please fill all fields correctly.";
      createTournMsg.className = "message error";
      return;
    }
    const dateTimeISO = new Date(date+"T"+time+":00").toISOString();

    try {
      if(createTournBtn.dataset.editingId){
        await updateDoc(doc(db,"tournaments",createTournBtn.dataset.editingId), {
          name, dateTime: dateTimeISO, mode, entryFee, slotLimit
        });
        createTournMsg.textContent = "Tournament updated successfully!";
        createTournBtn.textContent = "Create Tournament";
        delete createTournBtn.dataset.editingId;
      } else {
        await addDoc(collection(db,"tournaments"), {
          name, dateTime: dateTimeISO, mode, entryFee, slotLimit,
          createdAt: new Date().toISOString()
        });
        createTournMsg.textContent = "Tournament created successfully!";
      }
      createTournMsg.className = "message success";
      clearCreateTournamentForm();
      await loadAdminTournaments();
      await loadTournamentsForAdminSelect();
      await loadTournamentsForUser();
    } catch(e){
      createTournMsg.textContent = "Error saving tournament: "+e.message;
      createTournMsg.className = "message error";
    }
  };

  function clearCreateTournamentForm(){
    tournNameInput.value = "";
    tournDateInput.value = "";
    tournTimeInput.value = "";
    tournModeSelect.value = "solo";
    tournEntryFeeInput.value = "";
    tournSlotLimitInput.value = "";
    createTournBtn.textContent = "Create Tournament";
    createTournMsg.textContent = "";
    delete createTournBtn.dataset.editingId;
  }

  // Load admin registrations for selected tournament
  selectTournamentReg.onchange = async () => {
    const tournId = selectTournamentReg.value;
    adminRegistrationsTableBody.innerHTML = "";
    if(!tournId) return;

    const regSnap = await getDocs(query(collection(db,"registrations"), where("tournamentId","==",tournId)));
    if(regSnap.empty){
      adminRegistrationsTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No registrations for this tournament.</td></tr>`;
      return;
    }

    for(const regDoc of regSnap.docs){
      const r = regDoc.data();
      adminRegistrationsTableBody.innerHTML += `
      <tr>
        <td>${r.ffId}</td>
        <td>${r.phone}</td>
        <td>${r.utr}</td>
        <td><a href="${r.screenshotUrl}" target="_blank">View</a></td>
        <td>
          <select data-id="${regDoc.id}" class="paymentStatusSelect">
            <option value="Pending" ${r.paymentStatus==="Pending"?"selected":""}>Pending</option>
            <option value="Approved" ${r.paymentStatus==="Approved"?"selected":""}>Approved</option>
            <option value="Rejected" ${r.paymentStatus==="Rejected"?"selected":""}>Rejected</option>
          </select>
        </td>
        <td><a href="https://wa.me/91${r.phone}" target="_blank">WhatsApp</a></td>
      </tr>`;
    }
    // Payment status update event
    document.querySelectorAll(".paymentStatusSelect").forEach(sel => {
      sel.onchange = async () => {
        const id = sel.dataset.id;
        const val = sel.value;
        try {
          await updateDoc(doc(db,"registrations",id), { paymentStatus: val });
        } catch(e) {
          alert("Error updating payment status: "+e.message);
          sel.value = (val === "Pending") ? "Pending" : (val === "Approved") ? "Approved" : "Rejected";
        }
      };
    });
  };

  // Initialize
  function init(){
    // Nothing here yet
  }
  init();

</script>
</body>
</html>

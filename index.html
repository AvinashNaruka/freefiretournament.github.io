<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Free Fire Tournament ‚Äî Avinash</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0f172a; --bg2:#111827; --card:#0b1220; --accent:#f59e0b; --accent2:#fbbf24;
    --text:#e5e7eb; --muted:#93a4b5; --ok:#22c55e; --bad:#ef4444; --border:#1f2937;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Arial;
    background: radial-gradient(1200px 600px at 0% 0%, #0b1220, #0f172a 40%, #111827 100%);
    color:var(--text);
  }
  .wrap{max-width:1100px;margin:18px auto;padding:18px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);
        border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:16px}
  h1,h2,h3{margin:0 0 12px}
  h1{font-size:28px}
  h2{font-size:22px}
  label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
  input,select,textarea,button{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
    background:#0a1220;color:var(--text);font-size:14px
  }
  input::placeholder,textarea::placeholder{color:#6b7280}
  button{background:linear-gradient(45deg,var(--accent),var(--accent2));border:none;color:#0b1220;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:1px solid #263243;color:var(--text)}
  button.warn{background:#ef4444}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:900px){.row{grid-template-columns:360px 1fr}}
  .grid{display:grid;gap:10px}
  .muted{color:var(--muted)}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#0f1a2b;border:1px solid #223048;font-size:12px}
  .ok{color:#10b981}.bad{color:#ef4444}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left;font-size:14px}
  th{color:#f5c26b;background:#101827;position:sticky;top:0}
  .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .hidden{display:none}
  .topbar{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:12px}
  .admin{background:#ffe7b3;color:#5b3a00}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#0d1b2d;border:1px solid #1f2e45;font-size:12px}
  .qr{max-width:220px;border-radius:12px;border:2px solid #2a394e}
  .thumb{max-width:90px;max-height:70px;border-radius:8px;border:1px solid #2a394e}
  a{color:#f59e0b}
  .sectionTitle{display:flex;justify-content:space-between;align-items:center;margin:8px 0 6px}
  .pill{padding:6px 10px;border-radius:999px;background:#0f1a2b;border:1px solid #243249}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>Free Fire Tournament</h1>
      <div class="muted">Manage tournaments ‚Ä¢ UPI payments ‚Ä¢ Proof upload ‚Ä¢ Manual UTR verify</div>
    </div>
    <div class="flex">
      <a class="pill" href="tel:7976726014">üìû Call: 7976726014</a>
      <a class="pill" target="_blank" href="https://wa.me/919776726014">üí¨ WhatsApp</a>
    </div>
  </div>

  <!-- AUTH -->
  <div id="authCard" class="card">
    <div class="sectionTitle">
      <h2>Login / Signup</h2>
      <span id="whoami" class="badge">Not logged in</span>
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div>
        <label>Email</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="username"/>
      </div>
      <div>
        <label>Password</label>
        <input id="password" type="password" placeholder="Min 6 chars" autocomplete="current-password"/>
      </div>
    </div>
    <div class="flex" style="margin-top:10px">
      <button id="loginBtn" style="flex:0 0 160px">Login</button>
      <button id="signupBtn" class="ghost" style="flex:0 0 160px">Sign up</button>
      <button id="logoutBtn" class="hidden" style="flex:0 0 160px">Logout</button>
      <span id="adminBadge" class="badge admin hidden">Admin</span>
    </div>
    <div id="authMsg" class="muted" style="margin-top:8px"></div>
  </div>

  <div class="row" style="margin-top:14px">
    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="card hidden">
      <div class="sectionTitle">
        <h2>Admin ‚Äî Tournaments</h2>
        <span class="badge">Create / Edit / Delete / Close</span>
      </div>
      <label>Name</label>
      <input id="tName" placeholder="e.g., Sunday Clash">
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <label>Date & Time</label>
          <input id="tDate" type="datetime-local">
        </div>
        <div>
          <label>Mode</label>
          <select id="tMode">
            <option value="solo">Solo (1)</option>
            <option value="duo">Duo (2)</option>
            <option value="squad">Squad (4)</option>
          </select>
        </div>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <label>Entry Fee (‚Çπ)</label>
          <input id="tFee" type="number" min="1" value="20">
        </div>
        <div>
          <label>Slots (teams/players)</label>
          <input id="tSlots" type="number" min="1" value="12">
        </div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button id="createTournamentBtn">Save / Create</button>
        <button id="resetFormBtn" class="ghost">Reset</button>
      </div>

      <h3 style="margin-top:14px">All Tournaments</h3>
      <div class="muted" style="margin-bottom:6px">‚ÄúSlots‚Äù ka matlab: Solo=players, Duo/Squad=teams. Booked count registrations ke hisaab se hota hai.</div>
      <table>
        <thead><tr><th>Name</th><th>Date</th><th>Mode</th><th>Fee</th><th>Slots</th><th>Booked</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="adminTBody"></tbody>
      </table>

      <div id="adminRegsBlock" class="hidden" style="margin-top:16px">
        <h3>Registrations ‚Äî <span id="adminRegTitle"></span></h3>
        <table>
          <thead>
            <tr><th>When</th><th>Player</th><th>WhatsApp</th><th>FF IDs</th><th>UTR</th><th>Proof</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody id="adminRegsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- USER PANEL -->
    <div id="userPanel" class="card hidden">
      <div class="sectionTitle">
        <h2>Register</h2>
        <span class="badge">Pay ‚Üí Upload proof ‚Üí Submit</span>
      </div>

      <label>Select Tournament</label>
      <select id="selTournament"></select>
      <div id="selInfo" class="muted" style="margin:6px 0"></div>

      <label>Player Name</label>
      <input id="pName" placeholder="Your name">

      <label>WhatsApp Number</label>
      <input id="pWhats" placeholder="e.g., 98xxxxxx90">

      <div id="ffBlock"></div>

      <div class="card" style="margin-top:12px">
        <h3 style="margin-bottom:8px">Payment</h3>
        <div class="flex">
          <label class="pill"><input type="radio" name="payMethod" value="gpay" checked> Google Pay</label>
          <label class="pill"><input type="radio" name="payMethod" value="phonepe"> PhonePe</label>
          <span id="amtChip" class="chip">Amount: ‚Çπ0</span>
        </div>
        <div id="qrRow" class="flex" style="align-items:center;margin-top:10px">
          <img id="qrImg" class="qr" src="" alt="QR"/>
          <div class="grid" style="min-width:240px">
            <button id="payNowBtn">Pay Now</button>
            <button id="paidBtn" class="ghost">I have completed payment</button>
          </div>
        </div>
        <div id="postPay" class="hidden" style="margin-top:10px">
          <label>UTR / Transaction ID</label>
          <input id="utr" placeholder="Enter UTR">
          <label>Payment Screenshot</label>
          <input id="ss" type="file" accept="image/*">
          <button id="submitRegBtn" style="margin-top:10px">Submit Registration</button>
        </div>
      </div>

      <h3 style="margin-top:18px">Your registrations</h3>
      <table>
        <thead><tr><th>When</th><th>Tournament</th><th>Mode</th><th>Amount</th><th>Status</th></tr></thead>
        <tbody id="myRegsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Firebase SDKs (CDN modules) -->
<script type="module">
  // === Your Firebase config ===
  const firebaseConfig = {
    apiKey: "AIzaSyCAjiInmaJsHSqhlxZZ0heIdNEMu6m6Y6Y",
    authDomain: "freefire-tournament-2009.firebaseapp.com",
    databaseURL: "https://freefire-tournament-2009-default-rtdb.firebaseio.com",
    projectId: "freefire-tournament-2009",
    storageBucket: "freefire-tournament-2009.firebasestorage.app",
    messagingSenderId: "498357283098",
    appId: "1:498357283098:web:2f05123efe6c57e65524a3"
  };

  // === Imports ===
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getStorage, ref as sRef, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // === Init ===
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // === Admin identity ===
  const ADMIN_EMAIL = "avinashnaruka89@gmail.com";

  // === UI refs ===
  const whoami = document.getElementById('whoami');
  const authCard = document.getElementById('authCard');
  const adminPanel = document.getElementById('adminPanel');
  const userPanel = document.getElementById('userPanel');
  const adminBadge = document.getElementById('adminBadge');
  const authMsg = document.getElementById('authMsg');

  const email = document.getElementById('email');
  const password = document.getElementById('password');
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  // Admin form
  const tName = document.getElementById('tName');
  const tDate = document.getElementById('tDate');
  const tMode = document.getElementById('tMode');
  const tFee  = document.getElementById('tFee');
  const tSlots= document.getElementById('tSlots');
  const createTournamentBtn = document.getElementById('createTournamentBtn');
  const resetFormBtn = document.getElementById('resetFormBtn');
  const adminTBody = document.getElementById('adminTBody');
  const adminRegsBlock = document.getElementById('adminRegsBlock');
  const adminRegTitle = document.getElementById('adminRegTitle');
  const adminRegsBody = document.getElementById('adminRegsBody');

  // User form
  const selTournament = document.getElementById('selTournament');
  const selInfo = document.getElementById('selInfo');
  const pName = document.getElementById('pName');
  const pWhats = document.getElementById('pWhats');
  const ffBlock = document.getElementById('ffBlock');
  const payNowBtn = document.getElementById('payNowBtn');
  const paidBtn = document.getElementById('paidBtn');
  const postPay = document.getElementById('postPay');
  const utr = document.getElementById('utr');
  const ss = document.getElementById('ss');
  const submitRegBtn = document.getElementById('submitRegBtn');
  const myRegsBody = document.getElementById('myRegsBody');
  const amtChip = document.getElementById('amtChip');
  const qrImg = document.getElementById('qrImg');

  let editingTournamentId = null; // admin edit mode
  let currentUser = null;
  let tournamentsCache = []; // for quick find

  // ===== AUTH =====
  loginBtn.onclick = async ()=>{
    authMsg.textContent='';
    try{
      await signInWithEmailAndPassword(auth, email.value.trim(), password.value.trim());
    }catch(e){ authMsg.textContent = 'Login failed: '+e.message; }
  };
  signupBtn.onclick = async ()=>{
    authMsg.textContent='';
    try{
      await createUserWithEmailAndPassword(auth, email.value.trim(), password.value.trim());
      authMsg.textContent='Signup success. You are logged in.';
    }catch(e){ authMsg.textContent = 'Signup failed: '+e.message; }
  };
  logoutBtn.onclick = async ()=>{ await signOut(auth); };

  onAuthStateChanged(auth, async (user)=>{
    currentUser = user || null;
    whoami.textContent = user ? user.email : 'Not logged in';
    logoutBtn.classList.toggle('hidden', !user);
    loginBtn.classList.toggle('hidden', !!user);
    signupBtn.classList.toggle('hidden', !!user);

    const isAdmin = !!user && user.email === ADMIN_EMAIL;
    adminBadge.classList.toggle('hidden', !isAdmin);
    adminPanel.classList.toggle('hidden', !isAdmin);
    userPanel.classList.toggle('hidden', !user);

    if(user){
      loadTournaments();
      loadMyRegistrations();
    }else{
      selTournament.innerHTML = '';
      myRegsBody.innerHTML = '';
      adminTBody.innerHTML = '';
    }
  });

  // ===== ADMIN: CREATE / EDIT / DELETE / CLOSE =====
  resetFormBtn.onclick = ()=>{ editingTournamentId=null; tName.value=''; tDate.value=''; tMode.value='solo'; tFee.value='20'; tSlots.value='12'; };

  createTournamentBtn.onclick = async ()=>{
    const name = tName.value.trim();
    const dateTime = tDate.value;
    const mode = tMode.value;
    const fee = Number(tFee.value);
    const slots = Number(tSlots.value);
    if(!name||!dateTime){ alert('Name & Date/Time required'); return; }
    if(!fee || isNaN(fee) || fee<=0){ alert('Please enter a valid entry fee (>0)'); return; }
    if(!slots || isNaN(slots) || slots<=0){ alert('Please enter valid slots'); return; }

    const payload = {
      name, dateTime, mode,
      entryFee: fee,
      slots,
      status:'open',
      createdBy: currentUser.email,
      createdAt: serverTimestamp()
    };

    try{
      if(editingTournamentId){
        await updateDoc(doc(db,'tournaments',editingTournamentId), payload);
        alert('Tournament updated');
      }else{
        const ref = await addDoc(collection(db,'tournaments'), payload);
        editingTournamentId = ref.id; // optional
        alert('Tournament created');
      }
      resetFormBtn.click();
    }catch(e){
      alert('Error saving tournament: '+e.message);
    }
  };

  async function loadTournaments(){
    const q = query(collection(db,'tournaments'), orderBy('createdAt','desc'));
    onSnapshot(q, (snap)=>{
      tournamentsCache = [];
      adminTBody.innerHTML = '';
      selTournament.innerHTML = '';

      if(snap.empty){
        adminTBody.innerHTML = '<tr><td colspan="8">No tournaments yet</td></tr>';
        selTournament.innerHTML = '<option value="">(No tournaments)</option>';
        return;
      }

      snap.forEach(d=>{
        const t = { id:d.id, ...d.data() };
        tournamentsCache.push(t);
      });

      // Fill admin table
      tournamentsCache.forEach(t=>{
        const booked = t.booked ?? 0; // optional field
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.name}</td>
          <td>${fmtDate(t.dateTime)}</td>
          <td>${t.mode}</td>
          <td>‚Çπ${t.entryFee}</td>
          <td>${t.slots}</td>
          <td>${booked}</td>
          <td>${t.status}</td>
          <td>
            <div class="flex">
              <button class="ghost" data-edit="${t.id}">Edit</button>
              <button class="ghost" data-open="${t.id}">Open</button>
              <button class="ghost" data-close="${t.id}">Close</button>
              <button class="warn" data-del="${t.id}">Delete</button>
              <button class="ghost" data-view="${t.id}">View Regs</button>
            </div>
          </td>`;
        adminTBody.appendChild(tr);
      });

      // Fill user select
      selTournament.innerHTML = '';
      tournamentsCache.forEach(t=>{
        const leftText = ` ‚Äî ‚Çπ${t.entryFee} ‚Äî ${t.status}`;
        const o = document.createElement('option');
        o.value = t.id; o.textContent = `${t.name} (${fmtDate(t.dateTime)}) ${leftText}`;
        o.disabled = t.status!=='open';
        selTournament.appendChild(o);
      });

      updateSelectedTournamentInfo();
    });

    // admin action handlers (event delegation)
    adminTBody.onclick = async (e)=>{
      const id = e.target.getAttribute('data-edit') || e.target.getAttribute('data-open') || e.target.getAttribute('data-close') || e.target.getAttribute('data-del') || e.target.getAttribute('data-view');
      if(!id) return;

      const t = tournamentsCache.find(x=>x.id===id);
      if(e.target.hasAttribute('data-edit')){
        editingTournamentId = id;
        tName.value = t.name; tDate.value = toLocalInput(t.dateTime); tMode.value = t.mode; tFee.value = t.entryFee; tSlots.value = t.slots;
        window.scrollTo({top:0,behavior:'smooth'});
      }
      else if(e.target.hasAttribute('data-open')){
        await updateDoc(doc(db,'tournaments',id), {status:'open'});
      }
      else if(e.target.hasAttribute('data-close')){
        await updateDoc(doc(db,'tournaments',id), {status:'closed'});
      }
      else if(e.target.hasAttribute('data-del')){
        if(confirm('Delete this tournament? Registrations remain in DB.')) await deleteDoc(doc(db,'tournaments',id));
      }
      else if(e.target.hasAttribute('data-view')){
        openAdminRegs(id);
      }
    };
  }

  function toLocalInput(dt){
    const d = new Date(dt);
    const iso = new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
    return iso;
  }
  function fmtDate(dt){ if(!dt) return '-'; const d=new Date(dt); return d.toLocaleString(); }

  // ===== ADMIN: VIEW & APPROVE REGS =====
  async function openAdminRegs(tid){
    const t = tournamentsCache.find(x=>x.id===tid);
    if(!t){ alert('Tournament missing'); return; }
    adminRegTitle.textContent = `${t.name} ‚Äî ${fmtDate(t.dateTime)} ‚Äî ${t.mode} ‚Äî ‚Çπ${t.entryFee}`;
    adminRegsBlock.classList.remove('hidden');

    const q = query(collection(db,'registrations'), where('tournamentId','==',tid), orderBy('createdAt','desc'));
    onSnapshot(q, (snap)=>{
      adminRegsBody.innerHTML='';
      if(snap.empty){
        adminRegsBody.innerHTML = '<tr><td colspan="8">No registrations yet</td></tr>';
        return;
      }
      let count = 0;
      snap.forEach(d=>{
        const r = { id:d.id, ...d.data() }; count++;
        const tr = document.createElement('tr');
        const wa = r.whatsapp ? r.whatsapp.replace(/\D/g,'') : '';
        tr.innerHTML = `
          <td>${r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : '-'}</td>
          <td>${esc(r.playerName||'-')}<br><span class="muted">${esc(r.userEmail||'-')}</span></td>
          <td>${r.whatsapp||'-'} ${wa? `<a target="_blank" href="https://wa.me/91${wa}">[WA]</a>`:''}</td>
          <td>${(r.ffids||[]).map(esc).join(', ')}</td>
          <td>${esc(r.utr||'-')}</td>
          <td>${r.screenshotUrl? `<a target="_blank" href="${r.screenshotUrl}"><img class="thumb" src="${r.screenshotUrl}"></a>`:'-'}</td>
          <td>${r.status||'pending'}</td>
          <td class="flex">
            <button class="ghost" data-approve="${r.id}">Approve</button>
            <button class="ghost" data-reject="${r.id}">Reject</button>
            <button class="warn" data-rdel="${r.id}">Remove</button>
          </td>`;
        adminRegsBody.appendChild(tr);
      });

      // optionally auto close when booked == slots
      if(typeof t.slots==='number'){
        if(count >= t.slots && t.status==='open'){
          updateDoc(doc(db,'tournaments',tid), {status:'closed'});
        }
      }
    });

    adminRegsBody.onclick = async (e)=>{
      const rid = e.target.getAttribute('data-approve') || e.target.getAttribute('data-reject') || e.target.getAttribute('data-rdel');
      if(!rid) return;
      if(e.target.hasAttribute('data-approve')){
        await updateDoc(doc(db,'registrations',rid), {status:'approved'});
      }else if(e.target.hasAttribute('data-reject')){
        await updateDoc(doc(db,'registrations',rid), {status:'rejected'});
      }else if(e.target.hasAttribute('data-rdel')){
        if(confirm('Remove this registration?')) await deleteDoc(doc(db,'registrations',rid));
      }
    };
  }

  // ===== USER SIDE =====
  selTournament.onchange = updateSelectedTournamentInfo;
  document.querySelectorAll('input[name=payMethod]').forEach(r=>{
    r.addEventListener('change', ()=> updateQR());
  });

  function updateSelectedTournamentInfo(){
    const tid = selTournament.value;
    const t = tournamentsCache.find(x=>x.id===tid);
    if(!t){ selInfo.textContent=''; ffBlock.innerHTML=''; amtChip.textContent='Amount: ‚Çπ0'; qrImg.src=''; return; }
    const perTeam = t.mode==='solo'?1: t.mode==='duo'?2:4;
    selInfo.innerHTML = `Date: <b>${fmtDate(t.dateTime)}</b> ‚Ä¢ Mode: <b>${t.mode}</b> ‚Ä¢ Entry Fee: <b>‚Çπ${t.entryFee}</b> ‚Ä¢ Slots: <b>${t.slots}</b> (teams/players)`;
    // FF ID inputs
    let html = '';
    for(let i=1;i<=perTeam;i++){
      html += `
        <label>Free Fire ID #${i}</label>
        <input class="ffid" placeholder="FF ID ${i}">
      `;
    }
    ffBlock.innerHTML = html;
    amtChip.textContent = `Amount: ‚Çπ${t.entryFee}`;
    updateQR();
  }

  function getFFIDs(){
    return Array.from(document.querySelectorAll('.ffid')).map(i=>i.value.trim()).filter(Boolean);
  }

  function upiLink(method, amount){
    const pa = method==='gpay' ? 'avinashnaruka89@okicici' : '7976726014@axl';
    const pn = 'Avinash';
    return `upi://pay?pa=${encodeURIComponent(pa)}&pn=${encodeURIComponent(pn)}&am=${encodeURIComponent(amount)}&cu=INR`;
  }
  function updateQR(){
    const tid = selTournament.value;
    const t = tournamentsCache.find(x=>x.id===tid);
    if(!t){ qrImg.src=''; return; }
    const method = document.querySelector('input[name=payMethod]:checked').value;
    const url = upiLink(method, Number(t.entryFee)||0);
    const qr = `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(url)}`;
    qrImg.src = qr;
  }

  payNowBtn.onclick = ()=>{
    const tid = selTournament.value;
    const t = tournamentsCache.find(x=>x.id===tid);
    if(!t){ alert('Select a tournament first'); return; }

    // basic validations
    const pname = pName.value.trim();
    const wa = pWhats.value.trim();
    if(!pname){ alert('Please enter player name'); return; }
    if(!/^\d{8,15}$/.test(wa.replace(/\D/g,''))){ alert('Enter valid WhatsApp number'); return; }

    const perTeam = t.mode==='solo'?1: t.mode==='duo'?2:4;
    const ffids = getFFIDs();
    if(ffids.length !== perTeam){ alert(`Please enter ${perTeam} Free Fire ID(s)`); return; }

    // mobile redirect else QR already visible
    const link = upiLink(document.querySelector('input[name=payMethod]:checked').value, Number(t.entryFee)||0);
    if (/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent)) {
      window.location.href = link;
    } else {
      alert('Scan the QR to pay, then click "I have completed payment".');
    }
  };

  paidBtn.onclick = ()=>{
    // show UTR + screenshot after user confirms payment
    postPay.classList.remove('hidden');
    ss.scrollIntoView({behavior:'smooth',block:'center'});
  };

  submitRegBtn.onclick = async ()=>{
    const tid = selTournament.value;
    const t = tournamentsCache.find(x=>x.id===tid);
    if(!t){ alert('Select a tournament'); return; }
    if(t.status!=='open'){ alert('Tournament is closed'); return; }

    const pname = pName.value.trim();
    const wa = pWhats.value.trim();
    const ffids = getFFIDs();
    const perTeam = t.mode==='solo'?1: t.mode==='duo'?2:4;

    if(!pname){ alert('Please enter player name'); return; }
    if(ffids.length !== perTeam){ alert(`Please enter ${perTeam} Free Fire ID(s)`); return; }
    const phoneDigits = wa.replace(/\D/g,'');
    if(!/^\d{8,15}$/.test(phoneDigits)){ alert('Enter valid WhatsApp number'); return; }

    const utrVal = utr.value.trim();
    if(!utrVal){ alert('Enter UTR'); return; }
    if(!ss.files[0]){ alert('Upload payment screenshot'); return; }

    // upload screenshot
    try{
      const file = ss.files[0];
      const path = `screenshots/${currentUser.uid}/${Date.now()}_${file.name}`;
      const r = sRef(storage, path);
      await uploadBytes(r, file);
      const url = await getDownloadURL(r);

      const reg = {
        tournamentId: tid,
        userId: currentUser.uid,
        userEmail: currentUser.email,
        playerName: pname,
        whatsapp: phoneDigits,
        ffids,
        amount: Number(t.entryFee)||0,
        utr: utrVal,
        screenshotUrl: url,
        status:'pending',
        createdAt: serverTimestamp()
      };
      await addDoc(collection(db,'registrations'), reg);

      alert('Registration submitted. Wait for approval.');
      // reset only proof fields
      utr.value=''; ss.value='';
      loadMyRegistrations();
    }catch(e){
      alert('Error submitting registration: '+e.message);
    }
  };

  // ===== USER: MY REGS =====
  function loadMyRegistrations(){
    if(!currentUser) return;
    const q = query(collection(db,'registrations'), where('userId','==', currentUser.uid), orderBy('createdAt','desc'));
    onSnapshot(q, async (snap)=>{
      myRegsBody.innerHTML = '';
      if(snap.empty){ myRegsBody.innerHTML = '<tr><td colspan="5">No registrations yet</td></tr>'; return; }
      // To map tournament name quickly
      const tmap = {}; tournamentsCache.forEach(t=> tmap[t.id]=t);
      snap.forEach(d=>{
        const r = { id:d.id, ...d.data() };
        const t = tmap[r.tournamentId];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : '-'}</td>
          <td>${t? t.name:'-'}</td>
          <td>${t? t.mode:'-'}</td>
          <td>‚Çπ${r.amount||0}</td>
          <td>${r.status||'pending'}</td>
        `;
        myRegsBody.appendChild(tr);
      });
    });
  }

  // small util
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Free Fire Tournament Manager</title>
<style>
  :root{--bg1:#0f172a;--bg2:#0b1020;--card:#0f1b2d;--muted:#9fb3c8;--brand:#f59e0b;--accent:#22d3ee;--ok:#22c55e;--err:#ef4444;}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#e6eef8}
  .wrap{max-width:1100px;margin:24px auto;padding:18px}
  .card{background:rgba(15,27,45,.9);border:1px solid rgba(255,255,255,.06);box-shadow:0 10px 40px rgba(2,6,23,.35);border-radius:16px;padding:18px}
  h1,h2,h3{margin:0 0 8px 0;font-weight:800}
  h1{font-size:28px}
  h2{font-size:22px;color:var(--accent)}
  h3{font-size:18px;color:var(--brand)}
  .muted{color:var(--muted);font-size:14px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .col{flex:1;min-width:280px}
  label{display:block;font-size:13px;color:#cbd5e1;margin-top:10px}
  input,select,textarea,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0b1626;color:#e6eef8;outline:none}
  button{cursor:pointer;background:linear-gradient(135deg,var(--brand),#ffd166);color:#111827;font-weight:800;border:none;box-shadow:0 8px 24px rgba(245,158,11,.25);transition:transform .05s ease}
  button:hover{transform:translateY(-1px)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.16);color:#e6eef8;box-shadow:none}
  .btn-ok{background:linear-gradient(135deg,#16a34a,#86efac);color:#07240f}
  .btn-err{background:linear-gradient(135deg,#ef4444,#fda4af);color:#2a0608}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px dashed rgba(255,255,255,.08);padding:10px;text-align:left;font-size:14px}
  th{color:#cbd5e1;font-weight:700}
  tr:hover td{background:rgba(255,255,255,.02)}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:12px}
  .admin{background:rgba(34,211,238,.08);border-color:rgba(34,211,238,.25)}
  .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.06);font-size:12px}
  .hidden{display:none}
  .qrbox{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  #qr{background:#fff;padding:10px;border-radius:12px}
  .footer{margin-top:18px;text-align:center;color:#9fb3c8;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <h1>Free Fire Tournament Manager</h1>
        <div class="muted">Single-file • Firebase • UPI + UTR • GitHub Pages Ready</div>
      </div>
      <div style="text-align:right">
        <div id="whoami" class="muted">Not logged in</div>
        <div class="btn-row" style="margin-top:8px">
          <button id="btnLogin">Login</button>
          <button id="btnSignup" class="btn-ghost">Sign up</button>
          <button id="btnLogout" class="hidden">Logout</button>
        </div>
        <div style="margin-top:6px">
          <span id="adminBadge" class="badge admin hidden">Admin</span>
        </div>
      </div>
    </div>

    <!-- AUTH -->
    <div id="authBox" class="row">
      <div class="col">
        <h2>Sign in</h2>
        <label>Email</label>
        <input id="email" type="email" placeholder="your@email.com" autocomplete="username"/>
        <label>Password</label>
        <input id="password" type="password" placeholder="••••••••" autocomplete="current-password"/>
        <div class="btn-row" style="margin-top:10px">
          <button id="doLogin">Login</button>
          <button id="doSignup" class="btn-ghost">Create account</button>
        </div>
        <div id="authMsg" class="muted" style="margin-top:8px"></div>
      </div>
      <div class="col">
        <h3>Support</h3>
        <p class="muted">Koi dikkat ho to call/WhatsApp:</p>
        <div class="btn-row">
          <a class="muted" href="tel:7976726014">📞 7976726014</a>
          <a class="muted" target="_blank" href="https://wa.me/919776726014">💬 WhatsApp</a>
        </div>
        <p class="muted" style="margin-top:10px">Admin email: <code>avinashnaruka89@gmail.com</code></p>
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <div class="row">
        <!-- ADMIN -->
        <div class="col card" id="adminCard" class="hidden">
          <h2>Admin — Create / Edit Tournament</h2>
          <p class="muted">Sirf admin ko yeh section dikhega.</p>
          <label>Name</label>
          <input id="tName" placeholder="Sunday Clash"/>
          <label>Date & Time</label>
          <input id="tDate" type="datetime-local"/>
          <label>Mode</label>
          <select id="tMode">
            <option value="solo">Solo (1)</option>
            <option value="duo">Duo (2)</option>
            <option value="squad">Squad (4)</option>
          </select>
          <label>Team Slots (Solo=players, Duo=duos, Squad=squads)</label>
          <input id="tSlots" type="number" min="1" value="12"/>
          <label>Entry Fee per Player (₹)</label>
          <input id="tFee" type="number" min="1" value="20"/>
          <div class="btn-row" style="margin-top:10px">
            <button id="btnSaveT">Save Tournament</button>
            <button id="btnResetT" class="btn-ghost">Reset</button>
          </div>
          <div id="adminMsg" class="muted" style="margin-top:8px"></div>
        </div>

        <!-- REGISTER -->
        <div class="col card">
          <h2>Register</h2>
          <label>Select Tournament</label>
          <select id="selTournament"></select>
          <div id="tInfo" class="muted" style="margin:6px 0">—</div>

          <label>Mode Details</label>
          <div id="modeTip" class="muted">—</div>

          <label>Your Team / Player Name</label>
          <input id="rTeamName" placeholder="Team Phoenix"/>

          <div id="ffFields"></div>

          <label>WhatsApp Number</label>
          <input id="rPhone" placeholder="10 digit number"/>

          <h3 style="margin-top:12px">Pay & UTR</h3>
          <div class="muted">Mobile: UPI app redirect • Desktop: QR scan</div>
          <div class="row">
            <div class="col">
              <label>UPI App</label>
              <select id="upiApp">
                <option value="phonepe">PhonePe</option>
                <option value="gpay">Google Pay</option>
              </select>
            </div>
            <div class="col">
              <label>Amount (auto)</label>
              <input id="payAmount" type="number" readonly/>
            </div>
          </div>
          <div class="qrbox">
            <div id="qr"></div>
            <div>
              <button id="btnPay">Open UPI App</button>
              <div class="muted"></div>
            </div>
          </div>

          <label style="margin-top:10px">UTR / Transaction ID</label>
          <input id="rUTR" placeholder="UTR (12+ digits)"/>

          <div class="btn-row" style="margin-top:10px">
            <button id="btnRegister" class="btn-ok">Submit Registration</button>
            <button id="btnClearForm" class="btn-ghost">Clear</button>
          </div>
          <div id="regMsg" class="muted" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="row">
        <div class="col card">
          <h2>All Tournaments</h2>
          <table id="tTable">
            <thead>
              <tr><th>Name</th><th>Date</th><th>Mode</th><th>Slots</th><th>Regd</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="btn-row" style="margin-top:10px">
            <button id="btnExportCSV" class="btn-ghost">Download Registrations CSV</button>
          </div>
        </div>

        <div class="col card">
          <h2>My Registrations</h2>
          <div id="myRegs">—</div>
        </div>
      </div>

      <!-- ADMIN REG LIST -->
     <!-- ===== Admin Registrations View ===== -->
<div id="adminPanel" class="section hidden">
  <div class="card">
    <h2>Admin — Registrations (per tournament)</h2>
    <label>Pick tournament</label>
    <select id="adminSel"></select>
    <div id="adminRegBox" style="margin-top:10px">—</div>
  </div>
</div>

<script type="module">
  // ...upar wala sara code same rahega (auth, tournaments, register)

  const adminSel = $('adminSel');
  const adminRegBox = $('adminRegBox');
  adminSel.addEventListener('change', loadAdminRegs);

  async function loadAdminRegs(){
    adminRegBox.innerHTML='Loading…';
    const tid=adminSel.value; if(!tid){ adminRegBox.textContent='—'; return; }
    const regs = await getDocs(query(collection(db,'registrations'), where('tournamentId','==',tid)));
    if(regs.empty){ adminRegBox.innerHTML='<div class="muted">No registrations</div>'; return; }
    let html='<table><thead><tr><th>Team</th><th>Phone</th><th>FF IDs</th><th>UTR</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
    for(const d of regs.docs){
      const r={id:d.id, ...d.data()};
      html+=`<tr>
        <td>${r.teamName}<div class="muted">${r.userEmail||''}</div></td>
        <td><a class="link" href="https://wa.me/91${r.phone}" target="_blank">${r.phone}</a></td>
        <td>${(r.ffids||[]).join('<br>')}</td>
        <td>${r.utr||'-'}</td>
        <td><span class="pill">${r.status}</span></td>
        <td>
          <button data-a="approve" data-id="${r.id}" class="btn-ok">Approve</button>
          <button data-a="reject" data-id="${r.id}" class="btn-err">Reject</button>
        </td>
      </tr>`;
    }
    html+='</tbody></table>';
    adminRegBox.innerHTML=html;
  }

  adminRegBox.addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b) return; if(!isAdmin) return alert('Admin only');
    const id=b.dataset.id; const a=b.dataset.a;
    const ref=doc(db,'registrations',id);
    if(a==='approve'){ await updateDoc(ref,{ status:'approved' }); }
    else if(a==='reject'){ await updateDoc(ref,{ status:'rejected' }); }
    await loadAdminRegs(); await loadMyRegs();
  });
</script>
      
<!-- QR Code lib -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<!-- Firebase v12 (CDN modules) -->
<script type="module">
  // ====== CONFIG ======
  const ADMIN_EMAIL = 'avinashnaruka89@gmail.com';
  const ADMIN_PHONE = '7976726014';
  const UPI_PHONEPE = '7976726014@axl';
  const UPI_GPAY = 'avinashnaruka89@okicici';

  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
  import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: 'AIzaSyCAjiInmaJsHSqhlxZZ0heIdNEMu6m6Y6Y',
    authDomain: 'freefire-tournament-2009.firebaseapp.com',
    databaseURL: 'https://freefire-tournament-2009-default-rtdb.firebaseio.com',
    projectId: 'freefire-tournament-2009',
    storageBucket: 'freefire-tournament-2009.firebasestorage.app',
    messagingSenderId: '498357283098',
    appId: '1:498357283098:web:2f05123efe6c57e65524a3'
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ===== helpers =====
  const $ = id => document.getElementById(id);
  const isMobile = ()=> /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  const teamSize = m => m==='solo'?1: m==='duo'?2:4;
  function buildUPILink(vpa, amount, note='FreeFire Tournament'){
    if(!amount || amount<=0) return '';
    const p = new URLSearchParams({ pa:vpa, pn:'Avinash', am:String(amount), cu:'INR', tn:note });
    return `upi://pay?${p.toString()}`;
  }
  async function makeQR(text){
    const el = $('qr'); el.innerHTML='';
    if(!text){ el.innerHTML='<div class="muted">Amount set hone par QR aayega</div>'; return; }
    const canvas = document.createElement('canvas');
    el.appendChild(canvas);
    await QRCode.toCanvas(canvas, text, { width: 180 });
  }

  // ===== auth ui =====
  const whoami=$('whoami'), adminBadge=$('adminBadge'), authBox=$('authBox'), appBox=$('app');
  const btnLogin=$('btnLogin'), btnSignup=$('btnSignup'), btnLogout=$('btnLogout');
  const email=$('email'), password=$('password'), authMsg=$('authMsg');

  $('doLogin').addEventListener('click', async ()=>{
    try{ await signInWithEmailAndPassword(auth, email.value.trim(), password.value.trim()); authMsg.textContent='Logged in ✔️'; }
    catch(e){ authMsg.textContent='Login error: '+e.message; }
  });
  $('doSignup').addEventListener('click', async ()=>{
    try{ await createUserWithEmailAndPassword(auth, email.value.trim(), password.value.trim()); authMsg.textContent='Account created ✔️'; }
    catch(e){ authMsg.textContent='Signup error: '+e.message; }
  });
  btnLogin.addEventListener('click', ()=> $('doLogin').click());
  btnSignup.addEventListener('click', ()=> $('doSignup').click());
  btnLogout.addEventListener('click', ()=> signOut(auth));

  let currentUser=null, isAdmin=false;

  onAuthStateChanged(auth, async (user)=>{
    currentUser=user||null;
    isAdmin=!!(user && user.email===ADMIN_EMAIL);
    whoami.textContent = user? user.email : 'Not logged in';
    adminBadge.classList.toggle('hidden', !isAdmin);
    btnLogout.classList.toggle('hidden', !user);
    authBox.classList.toggle('hidden', !!user);
    appBox.classList.toggle('hidden', !user);
    // admin-only sections
    document.getElementById('adminCard').classList.toggle('hidden', !isAdmin);
    document.getElementById('adminPanel').classList.toggle('hidden', !isAdmin);
    await loadTournaments();
    await loadMyRegs();
  });

  // ===== tournaments =====
  const tTableBody = document.querySelector('#tTable tbody');
  const selTournament=$('selTournament'), tInfo=$('tInfo'), modeTip=$('modeTip');

  async function loadTournaments(){
    tTableBody.innerHTML=''; selTournament.innerHTML=''; $('adminSel').innerHTML='';
    const snap = await getDocs(query(collection(db,'tournaments'), orderBy('date','asc')));
    if(snap.empty){
      tTableBody.innerHTML='<tr><td colspan="7" class="muted">No tournaments yet</td></tr>';
      selTournament.innerHTML='<option value="">(None)</option>';
      $('adminSel').innerHTML='<option value="">(None)</option>';
      return;
    }
    snap.forEach(d=>{
      const t={id:d.id, ...d.data()};
      const regd=t.regCount||0, slots=t.teamSlots||0, status=t.closed?'Closed':'Open';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${t.name}</td>
        <td>${new Date(t.date).toLocaleString()}</td>
        <td>${t.mode}</td>
        <td>${slots}</td>
        <td>${regd}</td>
        <td>${status}</td>
        <td>${isAdmin?
          `<button data-act="edit" data-id="${t.id}">Edit</button>
           <button class="btn-err" data-act="del" data-id="${t.id}">Delete</button>
           <button class="btn-ghost" data-act="toggle" data-id="${t.id}">${t.closed?'Open':'Close'}</button>`
          : ''}</td>`;
      tTableBody.appendChild(tr);
      const o=document.createElement('option'); o.value=t.id; o.textContent=`${t.name} — ${new Date(t.date).toLocaleString()}`; selTournament.appendChild(o);
      const o2=document.createElement('option'); o2.value=t.id; o2.textContent=o.textContent; $('adminSel').appendChild(o2);
    });
    if(selTournament.options.length>0) selTournament.selectedIndex=0;
    await updateRegisterPanel();
  }

  const tName=$('tName'), tDate=$('tDate'), tMode=$('tMode'), tSlots=$('tSlots'), tFee=$('tFee');
  const btnSaveT=$('btnSaveT'), btnResetT=$('btnResetT'), adminMsg=$('adminMsg');
  let editingId=null;

  btnSaveT.addEventListener('click', async ()=>{
    if(!isAdmin) return alert('Admin only');
    try{
      const name=tName.value.trim(); if(!name) throw new Error('Name required');
      const date=tDate.value; if(!date) throw new Error('Date required');
      const mode=tMode.value; const teamSlots=Number(tSlots.value||0); const fee=Number(tFee.value||0);
      if(teamSlots<=0) throw new Error('Team slots must be > 0');
      if(fee<=0) throw new Error('Fee per player must be > 0');
      const payload={ name, date:new Date(date).toISOString(), mode, teamSlots, feePerPlayer:fee, closed:false, regCount:0, updatedAt:serverTimestamp() };
      if(editingId){ await updateDoc(doc(db,'tournaments',editingId), payload); adminMsg.textContent='Tournament updated ✔️'; }
      else{ await addDoc(collection(db,'tournaments'), { ...payload, createdAt:serverTimestamp() }); adminMsg.textContent='Tournament created ✔️'; }
      editingId=null; tName.value=''; tDate.value=''; tMode.value='solo'; tSlots.value='12'; tFee.value='20';
      await loadTournaments();
    }catch(e){ adminMsg.textContent='Error: '+e.message; }
  });
  btnResetT.addEventListener('click', ()=>{ editingId=null; tName.value=''; tDate.value=''; tMode.value='solo'; tSlots.value='12'; tFee.value='20'; adminMsg.textContent=''; });

  tTableBody.addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b || !isAdmin) return;
    const id=b.dataset.id, act=b.dataset.act; const ref=doc(db,'tournaments',id); const d=await getDoc(ref); if(!d.exists()) return;
    if(act==='edit'){
      const t=d.data(); editingId=id; tName.value=t.name; tDate.value=new Date(t.date).toISOString().slice(0,16); tMode.value=t.mode; tSlots.value=t.teamSlots; tFee.value=t.feePerPlayer; adminMsg.textContent='Editing…';
    }else if(act==='del'){
      if(confirm('Delete this tournament? This removes all its registrations too.')){
        const regs = await getDocs(query(collection(db,'registrations'), where('tournamentId','==',id)));
        await Promise.all(regs.docs.map(x=>deleteDoc(doc(db,'registrations',x.id))));
        await deleteDoc(ref); await loadTournaments();
      }
    }else if(act==='toggle'){
      const t=d.data(); await updateDoc(ref,{ closed:!t.closed }); await loadTournaments();
    }
  });

  // ===== register ui =====
  const rTeamName=$('rTeamName'), rPhone=$('rPhone'), rUTR=$('rUTR');
  const payAmount=$('payAmount'), upiApp=$('upiApp'), btnPay=$('btnPay'), btnRegister=$('btnRegister'), regMsg=$('regMsg'), btnClearForm=$('btnClearForm');

  const ffFields = document.createElement('div'); ffFields.id='ffFields';
  document.getElementById('ffFields').replaceWith(ffFields);

  selTournament.addEventListener('change', updateRegisterPanel);
  upiApp.addEventListener('change', updateRegisterPanel);

  function buildFFInputs(cnt){
    ffFields.innerHTML='';
    for(let i=1;i<=cnt;i++){
      const w=document.createElement('div');
      w.innerHTML=`<label>Free Fire ID #${i}</label><input class="ffid" placeholder="FF ID ${i}">`;
      ffFields.appendChild(w);
    }
  }

  async function updateRegisterPanel(){
    const id = selTournament.value; if(!id){ tInfo.textContent='—'; ffFields.innerHTML=''; payAmount.value=''; makeQR(''); return; }
    const d = await getDoc(doc(db,'tournaments',id)); if(!d.exists()) return;
    const t=d.data(); const size=teamSize(t.mode); const due=(t.feePerPlayer||0)*size;
    tInfo.textContent = `${t.name} • ${new Date(t.date).toLocaleString()} • ${t.mode.toUpperCase()} • ₹${t.feePerPlayer}/player • Team pays ₹${due}`;
    modeTip.textContent = t.mode==='solo'?'Solo: 1 FF ID': t.mode==='duo'?'Duo: 2 FF IDs':'Squad: 4 FF IDs';
    payAmount.value = due;
    buildFFInputs(size);
    // QR
    const vpa = (upiApp.value==='phonepe')? UPI_PHONEPE : UPI_GPAY;
    const link = buildUPILink(vpa, due, `${t.name}`);
    makeQR(link);
  }

  btnPay.addEventListener('click', async ()=>{
    const id = selTournament.value; if(!id) return alert('Select tournament');
    const d = await getDoc(doc(db,'tournaments',id)); if(!d.exists()) return;
    const t=d.data(); const amount=(t.feePerPlayer||0)*teamSize(t.mode);
    if(!amount || amount<=0) return alert('Invalid amount');
    const vpa = (upiApp.value==='phonepe')? UPI_PHONEPE : UPI_GPAY;
    const link = buildUPILink(vpa, amount, `${t.name}`);
    if(isMobile()) window.location.href = link; else makeQR(link);
  });

  btnRegister.addEventListener('click', async ()=>{
    try{
      regMsg.textContent='Processing…';
      if(!currentUser) throw new Error('Login required');
      const tid=selTournament.value; if(!tid) throw new Error('Select tournament');
      const tDoc=await getDoc(doc(db,'tournaments',tid)); if(!tDoc.exists()) throw new Error('Tournament missing');
      const t=tDoc.data(); if(t.closed) throw new Error('Tournament closed');
      const size=teamSize(t.mode); const amount=(t.feePerPlayer||0)*size; if(!amount) throw new Error('Invalid amount');
      const name=rTeamName.value.trim(); if(!name) throw new Error('Team/Player name required');
      const phone=rPhone.value.trim(); if(!/^\d{10}$/.test(phone)) throw new Error('Enter 10 digit WhatsApp');
      const ffids=[...document.querySelectorAll('.ffid')].map(x=>x.value.trim()); if(ffids.length!==size || ffids.some(x=>!x)) throw new Error('Fill all Free Fire IDs');
      const utr=rUTR.value.trim(); if(!utr || utr.length<6) throw new Error('Enter valid UTR');

      // seat check
      const regSnap = await getDocs(query(collection(db,'registrations'), where('tournamentId','==',tid)));
      const regCount=regSnap.size;
      if(regCount >= (t.teamSlots||0)) throw new Error('Seats full');

      // save
      await addDoc(collection(db,'registrations'), {
        tournamentId: tid,
        userId: currentUser.uid,
        userEmail: currentUser.email,
        teamName: name,
        phone,
        ffids,
        amount,
        utr,
        status:'pending',
        createdAt: serverTimestamp()
      });
      await updateDoc(doc(db,'tournaments',tid), { regCount: regCount+1 });

      regMsg.textContent='Registration submitted ✔️ (pending approval)';
      rTeamName.value=''; rPhone.value=''; rUTR.value=''; buildFFInputs(size);
      await loadMyRegs(); await loadAdminRegs();
    }catch(e){ regMsg.textContent='Error: '+e.message; }
  });

  btnClearForm.addEventListener('click', ()=>{ rTeamName.value=''; rPhone.value=''; rUTR.value=''; regMsg.textContent=''; });

  // ===== my regs =====
  async function loadMyRegs(){
    const box=$('myRegs'); if(!currentUser){ box.textContent='—'; return; }
    const snap = await getDocs(query(collection(db,'registrations'), where('userId','==',currentUser.uid)));
    if(snap.empty){ box.innerHTML='<div class="muted">No registrations yet</div>'; return; }
    let html='<table><thead><tr><th>Tournament</th><th>Team</th><th>FF IDs</th><th>Amount</th><th>Status</th><th>UTR</th></tr></thead><tbody>';
    for(const d of snap.docs){
      const r=d.data(); const t=await getDoc(doc(db,'tournaments',r.tournamentId));
      html+=`<tr>
        <td>${t.exists()? t.data().name: '-'}</td>
        <td>${r.teamName}</td>
        <td>${(r.ffids||[]).join(', ')}</td>
        <td>₹${r.amount}</td>
        <td><span class="pill">${r.status}</span></td>
        <td>${r.utr}</td>
      </tr>`;
    }
    html+='</tbody></table>'; box.innerHTML=html;
  }

  // ===== admin regs =====
  const adminSel=$('adminSel'), adminRegBox=$('adminRegBox');
  adminSel.addEventListener('change', loadAdminRegs);

  async function loadAdminRegs(){
    if(!isAdmin){ adminRegBox.innerHTML='—'; return; }
    const tid=adminSel.value; if(!tid){ adminRegBox.textContent='—'; return; }
    const regs = await getDocs(query(collection(db,'registrations'), where('tournamentId','==',tid)));
    if(regs.empty){ adminRegBox.innerHTML='<div class="muted">No registrations</div>'; return; }
    let html='<table><thead><tr><th>Team</th><th>Phone</th><th>FF IDs</th><th>UTR</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
    for(const d of regs.docs){
      const r={id:d.id, ...d.data()};
      html+=`<tr>
        <td>${r.teamName}<div class="muted">${r.userEmail||''}</div></td>
        <td><a class="muted" href="https://wa.me/91${r.phone}" target="_blank">${r.phone}</a></td>
        <td>${(r.ffids||[]).join('<br>')}</td>
        <td>${r.utr||'-'}</td>
        <td><span class="pill">${r.status}</span></td>
        <td>
          <button data-a="approve" data-id="${r.id}" class="btn-ok">Approve</button>
          <button data-a="reject" data-id="${r.id}" class="btn-err">Reject</button>
          <button data-a="remove" data-id="${r.id}" class="btn-ghost">Remove</button>
        </td>
      </tr>`;
    }
    html+='</tbody></table>'; adminRegBox.innerHTML=html;
  }

  adminRegBox.addEventListener('click', async (e)=>{
    const b=e.target.closest('button'); if(!b || !isAdmin) return;
    const id=b.dataset.id, a=b.dataset.a; const ref=doc(db,'registrations',id);
    if(a==='approve'){ await updateDoc(ref,{ status:'approved' }); }
    else if(a==='reject'){ await updateDoc(ref,{ status:'rejected' }); }
    else if(a==='remove'){ if(confirm('Delete this registration?')) await deleteDoc(ref); }
    await loadAdminRegs(); await loadMyRegs();
  });

  // CSV export
  $('btnExportCSV').addEventListener('click', async ()=>{
    const regs = await getDocs(collection(db,'registrations'));
    const header=['Tournament','Team','UserEmail','Phone','FFIDs','Amount','Status','UTR','CreatedAt'];
    const rows=[header];
    for(const d of regs.docs){
      const r=d.data(); const t=await getDoc(doc(db,'tournaments',r.tournamentId));
      rows.push([
        t.exists()? t.data().name : r.tournamentId,
        r.teamName||'', r.userEmail||'', r.phone||'', (r.ffids||[]).join(' '), r.amount||0, r.status||'', r.utr||'', ''
      ]);
    }
    const csv=rows.map(row=>row.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='registrations.csv'; a.click(); URL.revokeObjectURL(url);
  });
</script>
</body>
</html>




<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Free Fire Tournament Manager</title>
<style>
  /* Gradient background */
  body {
    margin:0; font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #f39c12, #8e44ad);
    color:#fff;
    min-height:100vh;
  }
  .container {
    max-width: 960px; margin: 30px auto; background: #222;
    padding: 20px 30px; border-radius: 12px; box-shadow: 0 0 40px rgba(0,0,0,0.8);
  }
  h1,h2,h3 {
    margin:0 0 10px 0; font-weight:700; color:#f1c40f;
  }
  label {
    display:block; margin-top:12px; font-size:0.9rem; color:#f1c40f;
  }
  input, select, button, textarea {
    width: 100%; margin-top:6px; padding: 10px 12px; border-radius:8px;
    border:none; font-size: 1rem; font-family: 'Inter', sans-serif;
    background:#333; color:#fff;
  }
  button {
    background: #f1c40f; color:#222; font-weight:700;
    cursor:pointer; transition: background 0.3s ease;
  }
  button:hover {
    background:#d4ac0d;
  }
  .flex {
    display:flex; gap: 15px; flex-wrap: wrap; align-items: center;
  }
  .flex > * {
    flex: 1; min-width: 180px;
  }
  .hidden {
    display:none;
  }
  table {
    width: 100%; border-collapse: collapse; margin-top: 20px;
    color:#fff;
  }
  th, td {
    border: 1px solid #555; padding: 8px; text-align: left;
  }
  th {
    background: #8e44ad;
  }
  tr:nth-child(even) {
    background: #333;
  }
  .message {
    margin-top: 10px; padding: 10px; border-radius: 8px;
  }
  .success {
    background: #27ae60; color: white;
  }
  .error {
    background: #c0392b; color: white;
  }
  nav {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px; color: #f1c40f;
  }
  nav button {
    width: auto; padding: 8px 15px;
  }
  .gradient-btn {
    background: linear-gradient(45deg, #f1c40f, #d4ac0d);
    border: none; color: #222; font-weight: 700;
  }
  .admin-badge {
    background: #8e44ad; padding: 5px 15px; border-radius: 30px;
    font-weight: 700;
  }
  a {
    color: #f1c40f; text-decoration: underline;
    cursor: pointer;
  }
  .screenshot-preview {
    max-width: 120px; max-height: 90px; border-radius: 8px; margin-top: 6px;
    border: 1px solid #f1c40f;
  }
  .utrsmall {
    font-size: 0.85rem; margin-top: 3px; color: #f1c40f;
  }
  /* QR container for payment */
  #qrContainer {
    text-align:center; margin-top:20px;
  }
  #qrCanvas {
    margin: auto; background: #fff; border-radius: 12px;
  }
</style>
</head>
<body>

<div class="container">

<nav>
  <div><h1>Free Fire Tournament Manager</h1></div>
  <div>
    <span id="userEmail"></span>
    <button id="logoutBtn" class="hidden">Logout</button>
  </div>
</nav>

<!-- Auth Section -->
<div id="authSection">
  <h2>Login / Signup</h2>
  <label for="emailInput">Email:</label>
  <input type="email" id="emailInput" placeholder="Enter your email" autocomplete="username" />
  <label for="passwordInput">Password:</label>
  <input type="password" id="passwordInput" placeholder="Enter password" autocomplete="current-password" />
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Sign Up</button>
  <div id="authMessage" class="message"></div>
</div>

<!-- Main App -->
<div id="mainApp" class="hidden">

  <div class="flex" style="justify-content: space-between; align-items: center;">
    <h2>Tournaments</h2>
    <span id="adminBadge" class="admin-badge hidden">Admin</span>
  </div>

  <div id="tournamentCreateSection" class="hidden" style="margin-bottom: 20px; border:1px solid #f1c40f; padding:15px; border-radius:8px;">
    <h3>Create / Edit Tournament</h3>
    <label for="tName">Tournament Name:</label>
    <input id="tName" placeholder="Example: Sunday Clash" />
    <label for="tDate">Date & Time:</label>
    <input id="tDate" type="datetime-local" />
    <label for="tMode">Mode:</label>
    <select id="tMode">
      <option value="solo">Solo (1 player)</option>
      <option value="duo">Duo (2 players)</option>
      <option value="squad">Squad (4 players)</option>
    </select>
    <label for="tSlots">Total Slots (teams):</label>
    <input id="tSlots" type="number" min="1" max="1000" value="12" />
    <label for="tFee">Entry Fee (₹):</label>
    <input id="tFee" type="number" min="0" value="20" />
    <button id="createTBtn" class="gradient-btn">Create / Update Tournament</button>
    <button id="cancelEditTBtn" class="gradient-btn" style="background:#c0392b; margin-left:10px; display:none;">Cancel Edit</button>
  </div>

  <label for="tSelect">Select Tournament to Register / View:</label>
  <select id="tSelect"></select>

  <hr style="border-color:#f1c40f; margin:20px 0;" />

  <!-- Registration Section -->
  <div id="registrationSection" class="hidden">
    <h3>Register for Tournament</h3>

    <form id="registerForm">
      <label for="playerName">Your Name:</label>
      <input type="text" id="playerName" required />

      <label for="playerModeIds">Your Free Fire IDs:</label>
      <div id="playerModeIds"></div>

      <label for="phoneNumber">Phone Number (WhatsApp, required):</label>
      <input type="tel" id="phoneNumber" placeholder="91XXXXXXXXXX" pattern="[0-9]{10,12}" required />

      <div id="paymentSection">
        <p>Entry Fee: ₹<span id="entryFeeDisplay">0</span></p>
        <button type="button" id="payBtn" class="gradient-btn">Pay & Register</button>
        <button type="button" id="registerFreeBtn" class="gradient-btn" style="background:#c0392b; margin-left:10px;">Register Without Payment</button>
      </div>

      <div id="paymentUploadSection" class="hidden" style="margin-top:15px;">
        <label for="paymentProof">Upload Payment Screenshot:</label>
        <input type="file" id="paymentProof" accept="image/*" />
        <label for="utrInput">Enter UTR / Transaction ID:</label>
        <input type="text" id="utrInput" placeholder="UTR / Transaction Ref" />
        <img id="paymentProofPreview" class="screenshot-preview hidden" alt="Payment Proof Preview" />
        <button type="submit" class="gradient-btn" style="margin-top:15px;">Submit Registration</button>
      </div>
    </form>
  </div>

  <!-- QR Code Section for laptop payments -->
  <div id="qrContainer" class="hidden">
    <h3>Scan to Pay UPI</h3>
    <canvas id="qrCanvas"></canvas>
    <p>Or click <a href="#" id="upiLink" target="_blank" style="color:#f1c40f; font-weight:bold;">here</a> to pay via UPI</p>
  </div>

  <hr style="border-color:#f1c40f; margin:20px 0;" />

  <!-- User Registrations -->
  <div id="userTournamentsSection" class="hidden">
    <h3>Your Registered Tournaments</h3>
    <table id="userRegsTable">
      <thead><tr><th>Tournament</th><th>Date</th><th>Mode</th><th>Paid</th><th>Payment Status</th><th>UTR</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Admin Section -->
  <div id="adminSection" class="hidden" style="margin-top:40px; border-top: 2px solid #f1c40f; padding-top:20px;">
    <h2>Admin Panel</h2>

    <h3>Registrations</h3>
    <label for="adminTSelect">Select Tournament:</label>
    <select id="adminTSelect"></select>

    <table id="adminRegsTable" style="margin-top:15px;">
      <thead><tr>
        <th>Player Name</th>
        <th>FF IDs</th>
        <th>Phone</th>
        <th>Paid</th>
        <th>UTR</th>
        <th>Payment Screenshot</th>
        <th>Actions</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Support Buttons -->
  <div style="margin-top:30px; text-align:center;">
    <a href="tel:7976726014" style="color:#f1c40f; margin-right:15px; font-weight:bold;">Call Support: 7976726014</a>
    <a href="https://wa.me/919776726014" target="_blank" style="color:#f1c40f; font-weight:bold;">WhatsApp Support</a>
  </div>

</div>

<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, updateDoc, deleteDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

  // Firebase config - CHANGE with your own project's config
  const firebaseConfig = {
    apiKey: "AIzaSyCAjiInmaJsHSqhlxZZ0heIdNEMu6m6Y6Y",
    authDomain: "freefire-tournament-2009.firebaseapp.com",
    projectId: "freefire-tournament-2009",
    storageBucket: "freefire-tournament-2009.appspot.com",
    messagingSenderId: "498357283098",
    appId: "1:498357283098:web:2f05123efe6c57e65524a3"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Admin email (hardcoded)
  const adminEmail = "avinashnaruka89@gmail.com";

  // UI Elements
  const authSection = document.getElementById('authSection');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const authMessage = document.getElementById('authMessage');
  const mainApp = document.getElementById('mainApp');
  const logoutBtn = document.getElementById('logoutBtn');
  const userEmailDisplay = document.getElementById('userEmail');
  const adminBadge = document.getElementById('adminBadge');

  // Tournament Create/Edit UI
  const tournamentCreateSection = document.getElementById('tournamentCreateSection');
  const tName = document.getElementById('tName');
  const tDate = document.getElementById('tDate');
  const tMode = document.getElementById('tMode');
  const tSlots = document.getElementById('tSlots');
  const tFee = document.getElementById('tFee');
  const createTBtn = document.getElementById('createTBtn');
  const cancelEditTBtn = document.getElementById('cancelEditTBtn');

  // Tournament selection
  const tSelect = document.getElementById('tSelect');

  // Registration Section UI
  const registrationSection = document.getElementById('registrationSection');
  const registerForm = document.getElementById('registerForm');
  const playerNameInput = document.getElementById('playerName');
  const playerModeIdsDiv = document.getElementById('playerModeIds');
  const phoneNumberInput = document.getElementById('phoneNumber');
  const paymentSection = document.getElementById('paymentSection');
  const entryFeeDisplay = document.getElementById('entryFeeDisplay');
  const payBtn = document.getElementById('payBtn');
  const registerFreeBtn = document.getElementById('registerFreeBtn');
  const paymentUploadSection = document.getElementById('paymentUploadSection');
  const paymentProofInput = document.getElementById('paymentProof');
  const utrInput = document.getElementById('utrInput');
  const paymentProofPreview = document.getElementById('paymentProofPreview');

  // QR code
  const qrContainer = document.getElementById('qrContainer');
  const qrCanvas = document.getElementById('qrCanvas');
  const upiLink = document.getElementById('upiLink');

  // User Registered tournaments section
  const userTournamentsSection = document.getElementById('userTournamentsSection');
  const userRegsTableBody = userTournamentsSection.querySelector('tbody');

  // Admin Section UI
  const adminSection = document.getElementById('adminSection');
  const adminTSelect = document.getElementById('adminTSelect');
  const adminRegsTableBody = document.getElementById('adminRegsTable').querySelector('tbody');

  // State vars
  let currentUser = null;
  let isAdmin = false;
  let tournaments = [];
  let editingTournamentId = null;
  let selectedTournamentId = null;

  // Helper - format date/time nicely
  function formatDateTime(ts) {
    if(!ts) return '-';
    const d = new Date(ts);
    return d.toLocaleString();
  }

  // Show/hide elements by class
  function show(elem) { elem.classList.remove('hidden'); }
  function hide(elem) { elem.classList.add('hidden'); }

  // Show error/success messages for auth
  function setAuthMessage(msg, success = true) {
    authMessage.textContent = msg;
    authMessage.className = success ? 'message success' : 'message error';
  }

  // Clear auth messages
  function clearAuthMessage() {
    authMessage.textContent = '';
    authMessage.className = '';
  }

  // Auth: signup
  signupBtn.addEventListener('click', async () => {
    clearAuthMessage();
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if(!email || !pass) {
      setAuthMessage("Email and password required", false);
      return;
    }
    try {
      await createUserWithEmailAndPassword(auth, email, pass);
      setAuthMessage("Signup successful! Logging in...");
    } catch(e) {
      setAuthMessage("Signup error: " + e.message, false);
    }
  });

  // Auth: login
  loginBtn.addEventListener('click', async () => {
    clearAuthMessage();
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if(!email || !pass) {
      setAuthMessage("Email and password required", false);
      return;
    }
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      setAuthMessage("Login successful!");
    } catch(e) {
      setAuthMessage("Login error: " + e.message, false);
    }
  });

  // Logout
  logoutBtn.addEventListener('click', async () => {
    await signOut(auth);
  });

  // On Auth State Changed
  onAuthStateChanged(auth, user => {
    currentUser = user;
    if(user) {
      // Logged in
      userEmailDisplay.textContent = user.email;
      show(logoutBtn);
      hide(authSection);
      show(mainApp);

      isAdmin = (user.email.toLowerCase() === adminEmail.toLowerCase());

      if(isAdmin) {
        show(adminBadge);
        show(tournamentCreateSection);
        show(adminSection);
      } else {
        hide(adminBadge);
        hide(tournamentCreateSection);
        hide(adminSection);
      }

      loadTournaments();

      clearAuthMessage();

    } else {
      // Logged out
      userEmailDisplay.textContent = '';
      hide(logoutBtn);
      show(authSection);
      hide(mainApp);
      clearAuthMessage();
    }
  });

  // Load tournaments from Firestore
  async function loadTournaments() {
    tournaments = [];
    tSelect.innerHTML = '';
    adminTSelect.innerHTML = '';
    const q = query(collection(db, "tournaments"), orderBy("date", "asc"));
    const querySnap = await getDocs(q);
    querySnap.forEach(docSnap => {
      const data = docSnap.data();
      data.id = docSnap.id;
      tournaments.push(data);
    });

    if(tournaments.length === 0) {
      tSelect.innerHTML = '<option disabled>No tournaments available</option>';
      adminTSelect.innerHTML = '<option disabled>No tournaments available</option>';
      hide(registrationSection);
      hide(userTournamentsSection);
      return;
    }

    // Populate selects
    tournaments.forEach(t => {
      let opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = `${t.name} - ${new Date(t.date).toLocaleString()} (${t.mode.toUpperCase()})`;
      tSelect.appendChild(opt);
    });
    // Admin select same
    tournaments.forEach(t => {
      let opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = `${t.name} - ${new Date(t.date).toLocaleString()} (${t.mode.toUpperCase()})`;
      adminTSelect.appendChild(opt);
    });

    // Set default selected tournament
    selectedTournamentId = tournaments[0].id;
    tSelect.value = selectedTournamentId;
    adminTSelect.value = selectedTournamentId;

    showRegistrationSection();
    loadUserRegistrations();
    loadAdminRegistrations();
  }

  // Show Registration Section + inputs for FF IDs according to mode
  function showRegistrationSection() {
    if(!selectedTournamentId) {
      hide(registrationSection);
      return;
    }
    const t = tournaments.find(x => x.id === selectedTournamentId);
    if(!t) {
      hide(registrationSection);
      return;
    }

    entryFeeDisplay.textContent = t.fee;

    playerModeIdsDiv.innerHTML = '';
    let count = 1;
    if(t.mode === 'solo') count = 1;
    else if(t.mode === 'duo') count = 2;
    else if(t.mode === 'squad') count = 4;

    for(let i=1; i<=count; i++) {
      let label = document.createElement('label');
      label.textContent = `Free Fire ID ${i}:`;
      let input = document.createElement('input');
      input.type = 'text';
      input.required = true;
      input.placeholder = `Player ${i} Free Fire ID`;
      input.name = 'ffid';
      playerModeIdsDiv.appendChild(label);
      playerModeIdsDiv.appendChild(input);
    }

    // Reset payment form UI
    hide(paymentUploadSection);
    show(paymentSection);
    payBtn.disabled = false;
    registerFreeBtn.disabled = false;

    show(registrationSection);
  }

  // On tournament select change
  tSelect.addEventListener('change', e => {
    selectedTournamentId = e.target.value;
    showRegistrationSection();
    loadUserRegistrations();
  });

  adminTSelect.addEventListener('change', e => {
    selectedTournamentId = e.target.value;
    loadAdminRegistrations();
  });

  // Create / Update tournament
  createTBtn.addEventListener('click', async () => {
    const name = tName.value.trim();
    const dateVal = tDate.value;
    const modeVal = tMode.value;
    const slotsVal = parseInt(tSlots.value);
    const feeVal = parseInt(tFee.value);

    if(!name || !dateVal || !modeVal || !slotsVal || isNaN(slotsVal) || isNaN(feeVal)) {
      alert("Please fill all tournament fields properly.");
      return;
    }

    const dateMs = new Date(dateVal).getTime();
    if(isNaN(dateMs)) {
      alert("Invalid date/time");
      return;
    }

    const data = {
      name: name,
      date: dateMs,
      mode: modeVal,
      slots: slotsVal,
      fee: feeVal
    };

    try {
      if(editingTournamentId) {
        await updateDoc(doc(db, "tournaments", editingTournamentId), data);
        alert("Tournament updated.");
      } else {
        const newDocRef = doc(collection(db, "tournaments"));
        await setDoc(newDocRef, data);
        alert("Tournament created.");
      }
      editingTournamentId = null;
      createTBtn.textContent = "Create / Update Tournament";
      cancelEditTBtn.style.display = 'none';
      tName.value = "";
      tDate.value = "";
      tMode.value = "solo";
      tSlots.value = 12;
      tFee.value = 20;

      loadTournaments();
    } catch (e) {
      alert("Error creating/updating tournament: "+e.message);
    }
  });

  cancelEditTBtn.addEventListener('click', () => {
    editingTournamentId = null;
    createTBtn.textContent = "Create / Update Tournament";
    cancelEditTBtn.style.display = 'none';
    tName.value = "";
    tDate.value = "";
    tMode.value = "solo";
    tSlots.value = 12;
    tFee.value = 20;
  });

  // User clicks on Pay & Register
  payBtn.addEventListener('click', () => {
    const t = tournaments.find(x => x.id === selectedTournamentId);
    if(!t) return alert("Tournament not found");
    if(t.fee <= 0) {
      alert("No entry fee, just submit registration.");
      return;
    }
    // Show payment upload fields & hide pay/register buttons
    show(paymentUploadSection);
    hide(paymentSection);
    paymentProofInput.value = "";
    utrInput.value = "";
    paymentProofPreview.src = "";
    hide(paymentProofPreview);
  });

  // User clicks on register without payment
  registerFreeBtn.addEventListener('click', async () => {
    const t = tournaments.find(x => x.id === selectedTournamentId);
    if(!t) return alert("Tournament not found");
    if(t.fee > 0) {
      alert("Entry fee required, please pay first.");
      return;
    }
    await submitRegistration(null, null, false);
  });

  // Payment proof preview image
  paymentProofInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if(file) {
      const reader = new FileReader();
      reader.onload = () => {
        paymentProofPreview.src = reader.result;
        show(paymentProofPreview);
      };
      reader.readAsDataURL(file);
    } else {
      hide(paymentProofPreview);
      paymentProofPreview.src = "";
    }
  });

  // Registration form submit with payment proof
  registerForm.addEventListener('submit', async e => {
    e.preventDefault();

    const files = paymentProofInput.files;
    if(!files || files.length === 0) {
      alert("Please upload payment screenshot.");
      return;
    }
    if(!utrInput.value.trim()) {
      alert("Please enter UTR/Transaction ID.");
      return;
    }

    await submitRegistration(files[0], utrInput.value.trim(), true);
  });

  // Submit registration function
  async function submitRegistration(paymentFile, utr, paid) {
    const t = tournaments.find(x => x.id === selectedTournamentId);
    if(!t) return alert("Tournament not found");

    // Count current registered slots
    const regsQ = query(collection(db, "registrations"), where("tournamentId", "==", selectedTournamentId));
    const regsSnap = await getDocs(regsQ);
    let totalBookedSlots = 0;
    regsSnap.forEach(docSnap => {
      const data = docSnap.data();
      if(data.mode === 'solo') totalBookedSlots += 1;
      else if(data.mode === 'duo') totalBookedSlots += 2;
      else if(data.mode === 'squad') totalBookedSlots += 4;
    });

    // Determine slots requested
    let slotCount = 1;
    if(t.mode === 'duo') slotCount = 2;
    else if(t.mode === 'squad') slotCount = 4;

    if(totalBookedSlots + slotCount > t.slots * slotCount) {
      alert("Slots full, registration closed.");
      return;
    }

    const ffIds = Array.from(playerModeIdsDiv.querySelectorAll('input[name=ffid]')).map(i => i.value.trim());
    if(ffIds.some(id => !id)) {
      alert("Please fill all Free Fire IDs.");
      return;
    }

    if(!playerNameInput.value.trim()) {
      alert("Please enter your name.");
      return;
    }
    if(!phoneNumberInput.value.trim()) {
      alert("Please enter your phone number.");
      return;
    }

    // Upload payment screenshot if paid
    let paymentURL = null;
    if(paid && paymentFile) {
      const storageRef = ref(storage, `paymentProofs/${selectedTournamentId}/${Date.now()}_${paymentFile.name}`);
      try {
        const uploadResult = await uploadBytes(storageRef, paymentFile);
        paymentURL = await getDownloadURL(uploadResult.ref);
      } catch(e) {
        alert("Payment proof upload failed: "+e.message);
        return;
      }
    }

    // Save registration data
    try {
      await setDoc(doc(collection(db, "registrations")), {
        tournamentId: selectedTournamentId,
        tournamentName: t.name,
        tournamentDate: t.date,
        mode: t.mode,
        playerName: playerNameInput.value.trim(),
        ffIds: ffIds,
        phone: phoneNumberInput.value.trim(),
        paid: paid,
        paymentProof: paymentURL,
        utr: utr || null,
        paymentStatus: paid ? "Pending" : "Not Required",
        timestamp: Date.now(),
        userId: currentUser.uid,
        userEmail: currentUser.email
      });
      alert("Registration submitted successfully! Admin will verify payment.");
      registerForm.reset();
      hide(paymentUploadSection);
      show(paymentSection);
      loadUserRegistrations();
      if(isAdmin) loadAdminRegistrations();
    } catch(e) {
      alert("Registration failed: "+e.message);
    }
  }

  // Load user registrations
  async function loadUserRegistrations() {
    if(!currentUser) return;
    const regsQ = query(collection(db, "registrations"), where("userId", "==", currentUser.uid), orderBy("timestamp", "desc"));
    const regsSnap = await getDocs(regsQ);
    userRegsTableBody.innerHTML = '';
    let count = 0;
    regsSnap.forEach(docSnap => {
      const r = docSnap.data();
      count++;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.tournamentName}</td>
        <td>${formatDateTime(r.tournamentDate)}</td>
        <td>${r.mode.toUpperCase()}</td>
        <td>${r.paid ? '₹'+tournaments.find(t=>t.id===r.tournamentId)?.fee || 'N/A' : 'Free'}</td>
        <td>${r.paymentStatus}</td>
        <td>${r.utr || '-'}</td>
        <td><button data-id="${docSnap.id}" class="deleteRegBtn">Delete</button></td>
      `;
      userRegsTableBody.appendChild(tr);
    });
    if(count === 0) {
      userRegsTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No registrations yet.</td></tr>`;
    }
    show(userTournamentsSection);

    // Add delete event handlers
    Array.from(document.querySelectorAll('.deleteRegBtn')).forEach(btn => {
      btn.addEventListener('click', async (e) => {
        if(!confirm("Are you sure you want to delete this registration?")) return;
        const regId = btn.getAttribute('data-id');
        try {
          await deleteDoc(doc(db, "registrations", regId));
          alert("Registration deleted.");
          loadUserRegistrations();
          if(isAdmin) loadAdminRegistrations();
        } catch(e) {
          alert("Delete failed: "+e.message);
        }
      });
    });
  }

  // Load admin registrations for selected tournament
  async function loadAdminRegistrations() {
    if(!isAdmin || !selectedTournamentId) {
      adminRegsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Admin only section</td></tr>';
      return;
    }
    const regsQ = query(collection(db, "registrations"), where("tournamentId", "==", selectedTournamentId), orderBy("timestamp", "desc"));
    const regsSnap = await getDocs(regsQ);
    adminRegsTableBody.innerHTML = '';
    let count = 0;
    regsSnap.forEach(docSnap => {
      count++;
      const r = docSnap.data();

      // Format FF IDs as comma separated
      const ffIdsStr = (r.ffIds || []).join(", ");

      let paymentImgHtml = r.paymentProof ? `<a href="${r.paymentProof}" target="_blank"><img src="${r.paymentProof}" style="max-width:100px; max-height:80px; border-radius:8px;"></a>` : '-';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.playerName}</td>
        <td>${ffIdsStr}</td>
        <td>${r.phone}</td>
        <td>${r.paid ? '₹'+tournaments.find(t=>t.id===r.tournamentId)?.fee || 'N/A' : 'Free'}</td>
        <td>${r.utr || '-'}</td>
        <td>${paymentImgHtml}</td>
        <td>
          <button data-id="${docSnap.id}" class="approvePayBtn">Approve</button>
          <button data-id="${docSnap.id}" class="rejectPayBtn">Reject</button>
          <button data-id="${docSnap.id}" class="deleteRegAdminBtn" style="background:#c0392b;">Delete</button>
        </td>
      `;
      adminRegsTableBody.appendChild(tr);
    });
    if(count === 0) {
      adminRegsTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No registrations yet.</td></tr>`;
    }

    // Add approve/reject/delete event handlers
    Array.from(document.querySelectorAll('.approvePayBtn')).forEach(btn => {
      btn.addEventListener('click', async () => {
        const regId = btn.getAttribute('data-id');
        if(!confirm("Approve this payment?")) return;
        try {
          await updateDoc(doc(db, "registrations", regId), { paymentStatus: "Approved" });
          alert("Payment approved.");
          loadAdminRegistrations();
          loadUserRegistrations();
        } catch(e) {
          alert("Approve failed: "+e.message);
        }
      });
    });

    Array.from(document.querySelectorAll('.rejectPayBtn')).forEach(btn => {
      btn.addEventListener('click', async () => {
        const regId = btn.getAttribute('data-id');
        if(!confirm("Reject this payment?")) return;
        try {
          await updateDoc(doc(db, "registrations", regId), { paymentStatus: "Rejected" });
          alert("Payment rejected.");
          loadAdminRegistrations();
          loadUserRegistrations();
        } catch(e) {
          alert("Reject failed: "+e.message);
        }
      });
    });

    Array.from(document.querySelectorAll('.deleteRegAdminBtn')).forEach(btn => {
      btn.addEventListener('click', async () => {
        const regId = btn.getAttribute('data-id');
        if(!confirm("Delete this registration?")) return;
        try {
          await deleteDoc(doc(db, "registrations", regId));
          alert("Registration deleted.");
          loadAdminRegistrations();
          loadUserRegistrations();
        } catch(e) {
          alert("Delete failed: "+e.message);
        }
      });
    });
  }

  // Payment & QR code generation for laptop
  payBtn.addEventListener('click', () => {
    const t = tournaments.find(x => x.id === selectedTournamentId);
    if(!t) return alert("Tournament not found");

    // Show payment upload section after clicking pay
    // (already handled by payBtn listener)

    // For laptop users: generate QR code to pay exact amount
    // Generate UPI link
    const upiId = "7976726014@axl"; // PhonePe
    const payeeName = "Avinash Naruka";
    const amount = t.fee.toFixed(2);
    const upiURL = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(payeeName)}&am=${amount}&cu=INR&tn=${encodeURIComponent(t.name)}`;
    upiLink.href = upiURL;

    // Show QR container
    show(qrContainer);
    qrCanvas.width = 200;
    qrCanvas.height = 200;

    // Generate QR code on canvas
    QRCode.toCanvas(qrCanvas, upiURL, { width: 200 }, function (error) {
      if (error) console.error(error);
    });
  });

  // Admin edit and delete tournaments
  tSelect.addEventListener('change', () => {
    selectedTournamentId = tSelect.value;
    showRegistrationSection();
    loadUserRegistrations();
  });

  adminTSelect.addEventListener('change', () => {
    selectedTournamentId = adminTSelect.value;
    loadAdminRegistrations();
  });

  // Admin Tournament Editing by clicking existing tournament name (future: can add a list and click to edit)
  // For simplicity, add a function to allow admin to load a tournament to edit by selecting it in dropdown & clicking a button
  // Add button next to tournament create section for "Edit Selected Tournament"
  const editTournamentBtn = document.createElement('button');
  editTournamentBtn.textContent = "Edit Selected Tournament";
  editTournamentBtn.className = "gradient-btn";
  editTournamentBtn.style.marginTop = '10px';
  tournamentCreateSection.appendChild(editTournamentBtn);

  editTournamentBtn.addEventListener('click', () => {
    if(!selectedTournamentId) return alert("Select a tournament first");
    const t = tournaments.find(x => x.id === selectedTournamentId);
    if(!t) return alert("Tournament not found");
    editingTournamentId = selectedTournamentId;
    tName.value = t.name;
    tDate.value = new Date(t.date).toISOString().slice(0,16);
    tMode.value = t.mode;
    tSlots.value = t.slots;
    tFee.value = t.fee;
    createTBtn.textContent = "Update Tournament";
    cancelEditTBtn.style.display = 'inline-block';
  });

  // Admin Delete Tournament button
  const deleteTournamentBtn = document.createElement('button');
  deleteTournamentBtn.textContent = "Delete Selected Tournament";
  deleteTournamentBtn.className = "gradient-btn";
  deleteTournamentBtn.style.background = '#c0392b';
  deleteTournamentBtn.style.marginLeft = '10px';
  tournamentCreateSection.appendChild(deleteTournamentBtn);

  deleteTournamentBtn.addEventListener('click', async () => {
    if(!selectedTournamentId) return alert("Select a tournament first");
    if(!confirm("Delete tournament and all its registrations? This cannot be undone.")) return;
    try {
      await deleteDoc(doc(db, "tournaments", selectedTournamentId));

      // Delete all registrations linked to this tournament
      const regsQ = query(collection(db, "registrations"), where("tournamentId", "==", selectedTournamentId));
      const regsSnap = await getDocs(regsQ);
      const batchDeletes = regsSnap.docs.map(d => deleteDoc(doc(db, "registrations", d.id)));
      await Promise.all(batchDeletes);

      alert("Tournament and registrations deleted.");
      editingTournamentId = null;
      createTBtn.textContent = "Create / Update Tournament";
      cancelEditTBtn.style.display = 'none';
      selectedTournamentId = null;
      loadTournaments();
    } catch(e) {
      alert("Delete failed: "+e.message);
    }
  });

</script>

</body>
</html>
